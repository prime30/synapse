{% comment %}
  Shared product variable initialization for modular product sections.
  Extracts common setup logic (SellersDash, variant calculation, media prep)
  so each section doesn't duplicate it.

  Usage: {% render 'product-setup' %}
  After rendering, the following variables are available via the
  product-variant-sync JS (window.__productState).
{% endcomment %}

{% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}
{% if shsd_product_details.product_type == 'shsd_parent' %}
  {% assign shsd_product_handles = product.handle %}
  {% assign shsd_product_handles = shsd_product_handles | concat: shsd_product_details.handles %}
  {% for shsd_handle in shsd_product_handles %}
    {% assign shsd_single_product = all_products[shsd_handle] %}
    {% assign shsd_product_variants = shsd_product_variants | concat: shsd_single_product.variants %}
    {% assign shsd_product_media = shsd_product_media | concat: shsd_single_product.media %}
    {% assign shsd_product_images = shsd_product_images | concat: shsd_single_product.images %}
  {% endfor %}
  {% assign shsd_product_options_with_values = shsd_product_details.options_with_values %}
{% else %}
  {% assign shsd_product_options_with_values = product.options_with_values %}
  {% assign shsd_product_variants = product.variants %}
  {% assign shsd_product_media = product.media %}
  {% assign shsd_product_images = product.images %}
{% endif %}

{%- liquid
  assign isProductAvailable = product.available
  if isProductAvailable and settings.variant_remove == '2'
    assign remove_soldout = true
  else
    assign remove_soldout = false
  endif

  assign pr_variants = shsd_product_variants
  assign variants_size = pr_variants.size
  assign selected_variant = product.selected_variant
  assign pr_curent = settings.pr_curent

  if pr_curent == '1' and variants_size > 1
    assign current_variant = selected_variant
  elsif pr_curent == '2'
    assign current_variant = selected_variant | default: pr_variants.first
    if remove_soldout and current_variant.available == false and isProductAvailable
      assign current_variant = product.first_available_variant
    endif
  else
    assign current_variant = product.selected_or_first_available_variant
  endif

  assign PR_no_pick = false
  if pr_curent == '1' and variants_size > 1 and selected_variant == blank
    assign PR_no_pick = true
  endif
  assign isProductDefault = product.has_only_default_variant

  assign ntsoldout = false
  assign unvariants = false
  assign ck_so_un = false
  if isProductDefault == false and variants_size > 1
    assign unavailable_prs = pr_variants | where: 'available', false
    assign vls0 = shsd_product_options_with_values[0].values.size | default: 1
    assign vls1 = shsd_product_options_with_values[1].values.size | default: 1
    assign vls2 = shsd_product_options_with_values[2].values.size | default: 1
    assign ntvariants_size = vls0 | times: vls1 | times: vls2 | minus: pr_variants.size
    if unavailable_prs.size > 0 or product.available == false
      assign ntsoldout = true
    endif
    if ntvariants_size > 0
      assign unvariants = true
    endif
    if ntsoldout or unvariants
      assign ck_so_un = true
    endif
  endif

  assign pr_tags = product.tags
  assign pr_metafields = product.metafields
  assign meta_theme = product.metafields.theme
  assign cus_qty = meta_theme.cus_qty | default: 1

  assign isExternal = false
  assign external_title = meta_theme.external_title
  assign external_link = meta_theme.external_link
  if external_title != blank and external_link != blank
    assign isExternal = true
  endif

  assign isGrouped = false
  if meta_theme.grouped != blank
    assign isGrouped = true
  endif

  assign product_media = shsd_product_media
  assign variant_images = shsd_product_images | where: 'attached_to_variant?', true | map: 'src'
  assign media_size = product_media.size

  assign inventory_quantity = current_variant.inventory_quantity
  assign inventory_management = current_variant.inventory_management
  if inventory_quantity <= 0 and inventory_management == 'shopify' and current_variant.available
    assign isPreoder = true
  else
    assign isPreoder = false
  endif

  if settings.enable_his and PR_no_pick == false
    assign enableHistoryState = settings.enable_his
  else
    assign enableHistoryState = false
  endif
-%}
