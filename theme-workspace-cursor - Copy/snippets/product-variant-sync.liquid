{% comment %}
  Product Variant Sync (Cross-Section Communication)
  Bridges variant selection events between modular product sections:
  - product-gallery  (listens: updates active media)
  - product-description (listens: updates price, availability)
  - product-variants (dispatches: variant selection changes)
  - product-add-to-cart (listens: updates form hidden input, button state)

  Include once in the product template layout. Uses CustomEvent API.
{% endcomment %}

<script>
(function() {
  'use strict';

  var VARIANT_CHANGED = 'variant:changed';
  var OPTION_CHANGED  = 'variant:option-changed';

  var state = {
    productId: {{ product.id | json }},
    variants: {{ product.variants | json }},
    options: {{ product.options_with_values | json }},
    currentVariantId: {{ product.selected_or_first_available_variant.id | json }},
    available: {{ product.available | json }}
  };

  window.__productSyncState = state;

  function findVariantFromOptions(selectedOptions) {
    return state.variants.find(function(variant) {
      return selectedOptions.every(function(opt, index) {
        return variant['option' + (index + 1)] === opt;
      });
    });
  }

  function dispatchVariantChanged(variant, source) {
    state.currentVariantId = variant ? variant.id : null;
    var event = new CustomEvent(VARIANT_CHANGED, {
      bubbles: true,
      detail: {
        variant: variant,
        productId: state.productId,
        source: source
      }
    });
    document.dispatchEvent(event);
  }

  function initSwatchListeners() {
    var variantSections = document.querySelectorAll('[data-product-variants]');
    variantSections.forEach(function(section) {
      section.addEventListener('click', function(e) {
        var item = e.target.closest('[data-swatch-item]');
        if (!item) return;

        var optionGroup = item.closest('[data-swatch-option]');
        if (!optionGroup) return;

        var siblings = optionGroup.querySelectorAll('[data-swatch-item]');
        siblings.forEach(function(s) { s.classList.remove('is--selected'); });
        item.classList.add('is--selected');
        if (item.closest('.t4s-swatch__btn-wrap')) {
          item.closest('.t4s-swatch__btn-wrap').classList.add('is--selected');
        }

        var currentValueEls = optionGroup.querySelectorAll('[data-current-value]');
        currentValueEls.forEach(function(el) {
          el.textContent = item.getAttribute('data-value');
        });

        var allOptions = section.querySelectorAll('[data-swatch-option]');
        var selectedOptions = [];
        allOptions.forEach(function(opt) {
          var selected = opt.querySelector('[data-swatch-item].is--selected, .t4s-swatch__btn-wrap.is--selected [data-swatch-item]');
          if (selected) {
            selectedOptions.push(selected.getAttribute('data-value'));
          }
        });

        var variant = findVariantFromOptions(selectedOptions);
        updateVariantSelect(section, variant);
        dispatchVariantChanged(variant, 'swatch');
      });
    });
  }

  function updateVariantSelect(section, variant) {
    var select = section.querySelector('[data-variant-select]');
    if (select && variant) {
      select.value = variant.id;
    }
  }

  function initATCListeners() {
    document.addEventListener(VARIANT_CHANGED, function(e) {
      var variant = e.detail.variant;
      var atcSections = document.querySelectorAll('[data-product-add-to-cart]');

      atcSections.forEach(function(section) {
        var hiddenInput = section.querySelector('[data-variant-id-input]');
        if (hiddenInput && variant) {
          hiddenInput.value = variant.id;
        }

        var atcBtn = section.querySelector('[data-atc-form]');
        var atcText = section.querySelector('[data-atc-text]');
        if (atcBtn && atcText) {
          if (!variant || !variant.available) {
            atcBtn.setAttribute('aria-disabled', 'true');
            atcText.textContent = {{ 'products.product.sold_out' | t | json }};
          } else {
            atcBtn.removeAttribute('aria-disabled');
            if (variant.inventory_quantity <= 0 &&
                variant.inventory_management === 'shopify' &&
                variant.available) {
              atcText.textContent = {{ 'products.product.pre_order' | t | json }};
            } else {
              atcText.textContent = {{ 'products.product.add_to_cart' | t | json }};
            }
          }
        }

        var notifyBtn = section.querySelector('[data-notify-stock-btn]');
        if (notifyBtn) {
          if (variant && !variant.available) {
            notifyBtn.classList.remove('t4s-d-none');
            notifyBtn.setAttribute('data-variant-id', variant.id);
          } else {
            notifyBtn.classList.add('t4s-d-none');
          }
        }

        var paymentBtn = section.querySelector('.shopify-payment-button');
        if (paymentBtn) {
          paymentBtn.style.display = (variant && variant.available) ? '' : 'none';
        }
      });
    });
  }

  function initPriceListeners() {
    document.addEventListener(VARIANT_CHANGED, function(e) {
      var variant = e.detail.variant;
      if (!variant) return;

      var priceContainers = document.querySelectorAll('[data-product-price-container]');
      priceContainers.forEach(function(container) {
        var url = window.location.pathname + '?variant=' + variant.id + '&section_id=' + container.closest('section').id;

        fetch(url)
          .then(function(r) { return r.text(); })
          .then(function(html) {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var newPrice = doc.querySelector('[data-product-price-container]');
            if (newPrice) {
              container.innerHTML = newPrice.innerHTML;
            }
          })
          .catch(function() {});
      });

      var skuEls = document.querySelectorAll('[data-product-sku]');
      skuEls.forEach(function(el) {
        var skuNum = el.querySelector('[data-product__sku-number]');
        if (skuNum) {
          skuNum.textContent = variant.sku || '';
          el.classList.toggle('t4s-dn', !variant.sku);
        }
      });

      var availEls = document.querySelectorAll('[data-product-available]');
      availEls.forEach(function(el) {
        var instock = el.querySelector('[data-available-status]');
        var soldout = el.querySelector('[data-soldout-status]');
        if (instock && soldout) {
          if (variant.available) {
            instock.classList.remove('t4s-dn');
            soldout.classList.add('t4s-dn');
          } else {
            instock.classList.add('t4s-dn');
            soldout.classList.remove('t4s-dn');
          }
        }
      });
    });
  }

  function initHistoryState() {
    {%- if settings.enable_his -%}
    document.addEventListener(VARIANT_CHANGED, function(e) {
      var variant = e.detail.variant;
      if (variant && window.history.replaceState) {
        var url = new URL(window.location);
        url.searchParams.set('variant', variant.id);
        window.history.replaceState({}, '', url.toString());
      }
    });
    {%- endif -%}
  }

  function initGallerySync() {
    document.addEventListener(VARIANT_CHANGED, function(e) {
      var variant = e.detail.variant;
      if (!variant || !variant.featured_media) return;

      var galleryEl = document.querySelector('[data-product-gallery]');
      if (!galleryEl) return;

      var mediaId = variant.featured_media.id;
      var slide = galleryEl.querySelector('[data-media-id="' + mediaId + '"]');
      if (!slide) return;

      var flickity = galleryEl.querySelector('.flickityt4s');
      if (flickity && flickity.flickityInstance) {
        var index = Array.from(slide.parentNode.children).indexOf(slide);
        flickity.flickityInstance.select(index, false, true);
      }
    });
  }

  function init() {
    initSwatchListeners();
    initATCListeners();
    initPriceListeners();
    initHistoryState();
    initGallerySync();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
