{% comment %}
  Product Variants Section (Modular)
  Renders variant selectors: color swatches, size buttons, dropdowns.
  Dispatches 'variant:changed' custom events for cross-section sync.
{% endcomment %}

{% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}
{% if shsd_product_details.product_type == 'shsd_parent' %}
  {% assign shsd_product_handles = product.handle %}
  {% assign shsd_product_handles = shsd_product_handles | concat: shsd_product_details.handles %}
  {% for shsd_handle in shsd_product_handles %}
    {% assign shsd_single_product = all_products[shsd_handle] %}
    {% assign shsd_product_variants = shsd_product_variants | concat: shsd_single_product.variants %}
    {% assign shsd_product_images = shsd_product_images | concat: shsd_single_product.images %}
  {% endfor %}
  {% assign shsd_product_options_with_values = shsd_product_details.options_with_values %}
{% else %}
  {% assign shsd_product_options_with_values = product.options_with_values %}
  {% assign shsd_product_variants = product.variants %}
  {% assign shsd_product_images = product.images %}
{% endif %}

{%- liquid
  assign isProductAvailable = product.available
  if isProductAvailable and settings.variant_remove == '2'
    assign remove_soldout = true
  else
    assign remove_soldout = false
  endif

  assign se_stts = section.settings
  assign sid = section.id
  assign pr_sid = product.id | append: sid
  assign pr_variants = shsd_product_variants
  assign variants_size = pr_variants.size
  assign selected_variant = product.selected_variant
  assign pr_curent = settings.pr_curent

  if pr_curent == '1' and variants_size > 1
    assign current_variant = selected_variant
  elsif pr_curent == '2'
    assign current_variant = selected_variant | default: pr_variants.first
    if remove_soldout and current_variant.available == false and isProductAvailable
      assign current_variant = product.first_available_variant
    endif
  else
    assign current_variant = product.selected_or_first_available_variant
  endif

  assign PR_no_pick = false
  if pr_curent == '1' and variants_size > 1 and selected_variant == blank
    assign PR_no_pick = true
  endif
  assign isProductDefault = product.has_only_default_variant

  assign variant_images = shsd_product_images | where: 'attached_to_variant?', true | map: 'src'

  assign color_swatch = 'disabled-'
  assign color_mode = se_stts.color_mode
  assign selector_mode = se_stts.selector_mode
  assign stt_color_ck = settings.color_ck | default: ';'
  assign color_ck = stt_color_ck | append: ',color,colors,couleur,colour' | remove: ';,'
  assign get_color = color_ck | downcase | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | uniq
  assign color_mode_list = 'color, color is-sw-cl__round, color is-sw-cl__round is-sw-cl__label, variant_image, variant_image is-sw-cl__round, variant_image is-sw-cl__round is-sw-cl__label' | split: ', '
  if color_mode_list contains color_mode
    assign color_swatch = 'is-sw__color '
  endif

  assign choose_an_option = 'products.product.choose_an_option' | t
  assign date_in = settings.date_in

  if color_mode contains 'color' or color_mode contains 'variant'
    assign show_tooltip = ''
  else
    assign show_tooltip = '-off'
  endif

  assign is_fit_ratio_img = false
  if variant_images.size > 0 and se_stts.enable_fit_ratio_img and color_mode contains 'variant_image'
    assign is_fit_ratio_img = true
    assign first_ratio_img = variant_images[0].aspect_ratio
  endif
-%}

{%- unless isProductDefault -%}
  {{ 'swatch.css' | asset_url | stylesheet_tag }}

  <div
    class="t4s-product-variants-section"
    data-product-variants
    data-product-id="{{ product.id }}"
    data-section-id="{{ sid }}"
  >
    {%- if color_mode == 'dropdown' or selector_mode == 'dropdown' -%}
      <link rel="stylesheet" href="{{ 'base_drop.min.css' | asset_url }}" media="all">
    {%- endif -%}

    <div class="t4s-swatch t4s-color-mode__{{ color_mode }} t4s-color-size__{{ se_stts.color_size }} t4s-selector-mode__{{ selector_mode }}">
      {%- for option in shsd_product_options_with_values -%}
        {%- liquid
          assign option_index = 'option' | append: forloop.index
          assign selected_value = product.selected_or_first_available_variant[option_index]
          assign option_name = option.name
          assign name_downcase = option_name | downcase
        -%}

        {%- if get_color contains name_downcase -%}
          {% comment %} Color swatch option {% endcomment %}
          <div
            data-swatch-option
            data-id="{{ forloop.index0 }}"
            class="t4s-swatch__option is-t4s-style__color is-t4s-name__{{ option_name | handle }} {% cycle 'is--first-color', '', '' %}"
          >
            <h4 class="t4s-swatch__title">
              <span>
                {{ option_name }}:
                <span data-current-value class="t4s-swatch__current t4s-dib">
                  {{ selected_value | default: choose_an_option }}
                </span>
              </span>
            </h4>
            <div data-swatch-list class="t4s-swatch__list">
              {%- if color_mode != 'dropdown' -%}
                {%- if color_mode contains 'is-sw-cl__label' -%}
                  {%- for value in option.values -%}
                    <div
                      data-swatch-item
                      class="t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}"
                      data-value="{{ value | escape }}"
                    >
                      <div
                        data-img-el
                        class="t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s"
                      ></div>
                      <span class="t4s-swatch__label">{{ value }}</span>
                    </div>
                  {%- endfor -%}
                {%- else -%}
                  {%- for value in option.values -%}
                    {% for variant in product.variants %}
                      {% if variant.title contains value %}
                        {% assign variantQty = variant.inventory_quantity | json %}
                      {% endif %}
                    {% endfor %}
                    <div
                      data-qty="{{ variantQty }}"
                      data-swatch-item
                      data-tooltip{{ show_tooltip }}="top"
                      title="{{ value | escape }}"
                      class="t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}"
                      data-value="{{ value | escape }}"
                    >
                      {{ value }}
                    </div>
                  {%- endfor -%}
                {%- endif -%}
              {%- else -%}
                <button
                  type="button"
                  data-dropdown-open
                  data-position="bottom-end"
                  data-id="t4s_nt_{{ pr_sid }}{{ forloop.index }}"
                >
                  <span data-current-value>{{ selected_value | default: choose_an_option }}</span>
                  <svg class="t4s-icon-select-arrow" role="presentation" viewBox="0 0 19 12">
                    <use xlink:href="#t4s-select-arrow"></use>
                  </svg>
                </button>
                <div data-dropdown-wrapper class="t4s-dropdown__wrapper t4s-current-scrollbar" id="t4s_nt_{{ pr_sid }}{{ forloop.index }}">
                  <div class="t4s-drop-arrow"></div>
                  <div class="t4s-dropdown__header">
                    <span data-current-value class="t4s-dropdown__title">{{ selected_value | default: choose_an_option }}</span>
                    <button data-dropdown-close aria-label="{{ 'general.aria.close' | t }}">
                      <svg role="presentation" class="t4s-iconsvg-close" viewBox="0 0 16 14">
                        <path d="M15 0L1 14m14 0L1 0" stroke="currentColor" fill="none" fill-rule="evenodd"></path>
                      </svg>
                    </button>
                  </div>
                  <div class="t4s-dropdown__content">
                    {%- for value in option.values -%}
                      <div
                        data-swatch-item
                        data-dropdown-off
                        class="t4s-swatch__item t4s-truncate {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}"
                        data-value="{{ value | escape }}"
                      >
                        {{ value }}
                      </div>
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            </div>
          </div>

        {%- else -%}
          {% comment %} Non-color option (size, material, etc.) {% endcomment %}
          <div
            data-swatch-option
            data-id="{{ forloop.index0 }}"
            class="t4s-swatch__option is-t4s-name__{{ option_name | handle }}"
          >
            <h4 class="t4s-swatch__title">
              <span>
                {{ option_name }}:
                <span data-current-value class="t4s-dib">
                  {{ selected_value | default: choose_an_option }}
                </span>
              </span>
            </h4>
            <div class="t4s-swatch__list">
              {%- if selector_mode != 'dropdown' -%}
                {%- for value in option.values -%}
                  <div
                    data-swatch-item
                    class="t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}"
                    data-value="{{ value | escape }}"
                  >
                    {{ value }}
                  </div>
                {%- endfor -%}
              {%- else -%}
                <button
                  type="button"
                  data-dropdown-open
                  data-position="bottom-end"
                  data-id="t4s_nt_{{ pr_sid }}{{ forloop.index }}"
                >
                  <span data-current-value>{{ selected_value | default: choose_an_option }}</span>
                  <svg class="t4s-icon-select-arrow" role="presentation" viewBox="0 0 19 12">
                    <use xlink:href="#t4s-select-arrow"></use>
                  </svg>
                </button>
                <div data-dropdown-wrapper class="t4s-dropdown__wrapper t4s-current-scrollbar" id="t4s_nt_{{ pr_sid }}{{ forloop.index }}">
                  <div class="t4s-drop-arrow"></div>
                  <div class="t4s-dropdown__header">
                    <span data-current-value class="t4s-dropdown__title">{{ selected_value | default: choose_an_option }}</span>
                    <button data-dropdown-close aria-label="{{ 'general.aria.close' | t }}">
                      <svg role="presentation" class="t4s-iconsvg-close" viewBox="0 0 16 14">
                        <path d="M15 0L1 14m14 0L1 0" stroke="currentColor" fill="none" fill-rule="evenodd"></path>
                      </svg>
                    </button>
                  </div>
                  <div class="t4s-dropdown__content">
                    {%- for value in option.values -%}
                      <div
                        data-swatch-item
                        data-dropdown-off
                        class="t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}"
                        data-value="{{ value | escape }}"
                      >
                        {{ value }}
                      </div>
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            </div>
          </div>
        {%- endif -%}
      {%- endfor -%}
    </div>

    {% comment %} Hidden select for form submission (synced by variant-sync JS) {% endcomment %}
    <select
      name="id"
      id="product-variant-select-{{ pr_sid }}"
      class="t4s-product__select t4s-d-none"
      data-variant-select
    >
      {%- for variant in pr_variants -%}
        <option
          data-option1="{{ variant.option1 }}"
          data-option2="{{ variant.option2 }}"
          value="{{ variant.id }}"
          data-mdid="{{ variant.featured_media.id | json }}"
          data-incoming="{{ variant.incoming }}"
          data-inventoryQuantity="{{ variant.inventory_quantity | json }}"
          data-inventoryPolicy="{{ variant.inventory_policy | json }}"
          data-nextIncomingDate="{{ variant.next_incoming_date | date: date_in }}"
          {% if variant.id == current_variant.id %}selected="selected"{% endif %}
          {% unless variant.available %}
            {% if remove_soldout %}disabled="disabled"{% endif %}
            class="is--sold-out"
          {% endunless %}
        >
          {{ variant.title | escape }}
        </option>
      {%- endfor -%}
    </select>

    <script type="application/json" class="pr_variants_json" data-variants-json>
      {{ shsd_product_variants | json }}
    </script>
    <script type="application/json" class="pr_options_json" data-options-json>
      {{ shsd_product_options_with_values | json }}
    </script>
  </div>
{%- endunless -%}

{% schema %}
{
  "name": "Product variants",
  "tag": "section",
  "class": "t4s-section t4s-section-product-variants",
  "settings": [
    {
      "type": "select",
      "id": "selector_mode",
      "label": "Selector mode",
      "default": "radio is-sw__full",
      "options": [
        { "value": "radio", "label": "Radio buttons" },
        { "value": "radio is-sw__full", "label": "Radio buttons (full width)" },
        { "value": "dropdown", "label": "Dropdown" }
      ]
    },
    {
      "type": "select",
      "id": "color_mode",
      "label": "Color swatch mode",
      "default": "variant_image is-sw-cl__round is-sw-cl__label",
      "options": [
        { "value": "color", "label": "Color circle" },
        { "value": "color is-sw-cl__round", "label": "Color circle (round)" },
        { "value": "color is-sw-cl__round is-sw-cl__label", "label": "Color circle + label" },
        { "value": "variant_image", "label": "Variant image" },
        { "value": "variant_image is-sw-cl__round", "label": "Variant image (round)" },
        { "value": "variant_image is-sw-cl__round is-sw-cl__label", "label": "Variant image + label" },
        { "value": "dropdown", "label": "Dropdown" }
      ]
    },
    {
      "type": "checkbox",
      "id": "enable_fit_ratio_img",
      "label": "Fit variant image ratio",
      "default": false
    },
    {
      "type": "select",
      "id": "color_size",
      "label": "Color swatch size",
      "default": "large",
      "options": [
        { "value": "small", "label": "Small" },
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product variants"
    }
  ]
}
{% endschema %}
