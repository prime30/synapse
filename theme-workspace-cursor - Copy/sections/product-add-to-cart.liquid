{% comment %}
  Product Add to Cart Section (Modular)
  Renders the product form with quantity selector, ATC button,
  dynamic checkout, and wishlist/compare buttons.
  Listens for 'variant:changed' events from the variants section.
{% endcomment %}

{% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}
{% if shsd_product_details.product_type == 'shsd_parent' %}
  {% assign shsd_product_handles = product.handle %}
  {% assign shsd_product_handles = shsd_product_handles | concat: shsd_product_details.handles %}
  {% for shsd_handle in shsd_product_handles %}
    {% assign shsd_single_product = all_products[shsd_handle] %}
    {% assign shsd_product_variants = shsd_product_variants | concat: shsd_single_product.variants %}
  {% endfor %}
{% else %}
  {% assign shsd_product_variants = product.variants %}
{% endif %}

{%- liquid
  assign isProductAvailable = product.available
  if isProductAvailable and settings.variant_remove == '2'
    assign remove_soldout = true
  else
    assign remove_soldout = false
  endif

  assign se_stts = section.settings
  assign sid = section.id
  assign pr_sid = product.id | append: sid
  assign pr_variants = shsd_product_variants
  assign variants_size = pr_variants.size
  assign selected_variant = product.selected_variant
  assign pr_curent = settings.pr_curent

  if pr_curent == '1' and variants_size > 1
    assign current_variant = selected_variant
  elsif pr_curent == '2'
    assign current_variant = selected_variant | default: pr_variants.first
    if remove_soldout and current_variant.available == false and isProductAvailable
      assign current_variant = product.first_available_variant
    endif
  else
    assign current_variant = product.selected_or_first_available_variant
  endif

  assign PR_no_pick = false
  if pr_curent == '1' and variants_size > 1 and selected_variant == blank
    assign PR_no_pick = true
  endif
  assign isProductDefault = product.has_only_default_variant
  assign meta_theme = product.metafields.theme
  assign cus_qty = meta_theme.cus_qty | default: 1

  assign isExternal = false
  assign external_title = meta_theme.external_title
  assign external_link = meta_theme.external_link
  if external_title != blank and external_link != blank
    assign isExternal = true
  endif

  assign current_variant_available = current_variant.available
  assign current_inventory_quantity = current_variant.inventory_quantity
  if current_variant.inventory_management != null and current_inventory_quantity > 0 and current_variant.inventory_policy != 'continue'
    assign max_qty = current_inventory_quantity
  else
    assign max_qty = 9999
  endif

  assign inventory_quantity = current_variant.inventory_quantity
  assign inventory_management = current_variant.inventory_management
  if inventory_quantity <= 0 and inventory_management == 'shopify' and current_variant.available
    assign isPreoder = true
  else
    assign isPreoder = false
  endif

  assign PR_buy_pr = false
  if se_stts.show_dynamic_checkout and isExternal == false and isProductAvailable
    assign PR_buy_pr = true
  endif

  assign product_form_id = 'product-form-atc-' | append: pr_sid
-%}

{{ 'button-style.css' | asset_url | stylesheet_tag }}
<link href="{{ 'custom-effect.css' | asset_url }}" rel="stylesheet" media="print" onload="this.media='all'">

<div
  class="t4s-product-atc-section"
  data-product-add-to-cart
  data-product-id="{{ product.id }}"
  data-section-id="{{ sid }}"
>
  <div
    class="t4s-product-form__variants is-no-pick__{{ PR_no_pick }}{% if PR_buy_pr %} is-payment-btn-true t4s-payment-button t4s-btn-color-{{ se_stts.button_color_payment | default: 'dark' }}{% endif %} is-remove-soldout-{{ remove_soldout }} is-btn-full-width__{{ se_stts.btn_atc_full }} is-btn-atc-txt-{{ se_stts.btn_txt | default: '3' }} is-btn-ck-txt-{{ se_stts.btn_txt2 | default: '3' }}"
    style="--pr-btn-round: {{ se_stts.btn_round | default: 40 }}px;--wis-cp-btn-round: {{ se_stts.wis_cp_btn_round | default: 40 }}px;--wishlist-color: {{ se_stts.wishlist_color | default: '#000000' }};--wishlist-hover-color: {{ se_stts.wishlist_color_hover | default: '#fa0000' }};--wishlist-active-color: {{ se_stts.wishlist_color_active | default: '#e81e1e' }};--compare-color: {{ se_stts.compare_color | default: '#000000' }};--compare-hover-color: {{ se_stts.compare_color_hover | default: '#fa0000' }};"
  >
    <div data-callBackVariant id="t4s-callBackVariant{{ product_form_id }}">
      {%- form 'product',
        product,
        id: product_form_id,
        data-productid: product.id,
        class: 't4s-form__product',
        novalidate: 'novalidate',
        data-type: 'add-to-cart-form',
        data-disable-swatch: isProductDefault
      -%}

        {% comment %} Hidden variant ID input - synced by variant-sync JS {% endcomment %}
        <input
          type="hidden"
          name="id"
          data-variant-id-input
          value="{{ current_variant.id }}"
        >

        <div class="t4s-product-form__buttons">
          <div class="t4s-pr__qty_cart t4s-d-flex t4s-flex-wrap">

            {%- if isExternal -%}
              <a
                href="{{ external_link }}"
                rel="nofollow"
                target="_blank"
                class="t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ se_stts.button_style | default: 'default' }} t4s-btn-color-{{ se_stts.button_color | default: 'dark' }} t4s-w-100 t4s-justify-content-center {% if se_stts.button_style == 'default' or se_stts.button_style == 'outline' %} t4s-btn-effect-{{ se_stts.button_effect | default: 'sweep-to-right' }}{% endif %} t4s-truncate is--btn-external t4s-btn-loading__svg"
              >
                {%- if se_stts.show_btn_icon -%}
                  <svg class="t4s-btn-icon" viewBox="0 0 24 24"><use xlink:href="#t4s-icon-atc"></use></svg>
                {%- endif -%}
                <span class="t4s-btn-atc_text">{{ external_title }}</span>
                <span class="t4s-loading__spinner" hidden>
                  <svg width="16" height="16" hidden class="t4s-svg-spinner" focusable="false" role="presentation" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                    <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                  </svg>
                </span>
              </a>

            {%- else -%}
              {%- if se_stts.show_qty and isProductAvailable -%}
                <div data-quantity-wrapper class="t4s-quantity-wrapper t4s-product-form__qty">
                  <button data-quantity-selector data-decrease-qty type="button" class="t4s-quantity-selector is--minus"></button>
                  <input
                    data-quantity-value
                    type="number"
                    class="t4s-quantity-input"
                    step="1"
                    min="{{ cus_qty }}"
                    max="{{ max_qty }}"
                    name="quantity"
                    value="{{ cus_qty }}"
                    size="4"
                    pattern="[0-9]*"
                    inputmode="numeric"
                  >
                  <button data-quantity-selector data-increase-qty type="button" class="t4s-quantity-selector is--plus"></button>
                </div>
              {%- else -%}
                <input type="hidden" name="quantity" value="1">
              {%- endif -%}

              {% if customer %}
                <button
                  data-animation-atc='{ "ani": "{{ se_stts.ani | default: 'none' }}","time": {{ se_stts.animation_time | default: 6 | times: 1000 }} }'
                  type="submit"
                  name="add"
                  data-atc-form
                  class="t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ se_stts.button_style | default: 'default' }} t4s-btn-color-{{ se_stts.button_color | default: 'dark' }} t4s-w-100 t4s-justify-content-center {% if se_stts.button_style == 'default' or se_stts.button_style == 'outline' %} t4s-btn-effect-{{ se_stts.button_effect | default: 'sweep-to-right' }}{% endif %} t4s-btn-loading__svg"
                  {% unless current_variant_available %}aria-disabled="true"{% endunless %}
                  {% unless isProductAvailable %}disabled="disabled"{% endunless %}
                >
                  {%- if se_stts.show_btn_icon -%}
                    <svg class="t4s-btn-icon" viewBox="0 0 24 24"><use xlink:href="#t4s-icon-atc"></use></svg>
                  {%- endif -%}
                  <span class="t4s-btn-atc_text" data-atc-text>
                    {%- if current_variant_available == false or isProductAvailable == false -%}
                      {{ 'products.product.sold_out' | t }}
                    {%- elsif isPreoder -%}
                      {{ 'products.product.pre_order' | t }}
                    {%- else -%}
                      {{ 'products.product.add_to_cart' | t }}
                    {%- endif -%}
                  </span>
                  <span class="t4s-loading__spinner" hidden>
                    <svg width="16" height="16" hidden class="t4s-svg-spinner" focusable="false" role="presentation" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </span>
                </button>
              {% else %}
                <a
                  href="/account/login"
                  onclick="rememberPage(event)"
                  data-drawer-options='{ "id": "#t4s-login-sidebar" }'
                  class="atc-btn t4s-btn t4s-btn-base t4s-btn-style-default t4s-btn-color-dark t4s-w-100 t4s-justify-content-center t4s-btn-effect-sweep-to-right t4s-btn-loading__svg"
                >
                  <svg class="t4s-btn-icon" viewBox="0 0 24 24" style="margin-right:4px"><use xlink:href="#t4s-icon-atc"></use></svg>
                  <span class="t4s-btn-atc_text">Login to Shop</span>
                  <span class="t4s-loading__spinner" hidden>
                    <svg width="16" height="16" hidden class="t4s-svg-spinner" focusable="false" role="presentation" viewBox="0 0 66 66" xmlns="http://www.w3.org/2000/svg">
                      <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </span>
                </a>
              {% endif %}
            {%- endif -%}
          </div>

          {%- if PR_buy_pr %}
            {{ form | payment_button }}
          {% endif -%}

          {%- if settings.use_notify_me -%}
            {% if customer %}
              <button
                data-class="t4s-mfp-btn-close-inline"
                data-id="t4s-pr-popup__notify-stock"
                data-storageid="notify-stock{{ current_variant.id }}"
                data-mfp-src
                data-open-mfp-ajax
                class="t4s-pr__notify-stock{% if current_variant_available or current_variant == blank %} t4s-d-none{% endif %}"
                type="button"
                data-notify-stock-btn
                data-variant-id="{{ current_variant.id }}"
                data-root-url="{{ routes.root_url }}"
              >
                {{ 'products.notify_stock.trigger' | t }}
              </button>
            {% endif %}
          {%- endif -%}

          {%- if se_stts.enable_wishlist or se_stts.enable_compare -%}
            <div class="t4s-pr__wis_cp">
              {%- render 't4s_wis_cp', product: product, bk_stts: se_stts, disableTooltip: true -%}
            </div>
          {%- endif -%}
        </div>
      {%- endform -%}
    </div>
  </div>

  {%- if PR_buy_pr and current_variant_available != true -%}
    <style>
      #t4s-callBackVariant{{ product_form_id }} .shopify-payment-button { display: none; }
    </style>
  {%- endif -%}

  {%- if se_stts.ani != 'none' -%}
    <link href="{{ 'ani-atc.min.css' | asset_url }}" rel="stylesheet" media="print" onload="this.media='all'">
  {%- endif -%}
</div>

{% schema %}
{
  "name": "Product add to cart",
  "tag": "section",
  "class": "t4s-section t4s-section-product-atc",
  "settings": [
    {
      "type": "header",
      "content": "Quantity"
    },
    {
      "type": "checkbox",
      "id": "show_qty",
      "label": "Show quantity selector",
      "default": true
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "checkbox",
      "id": "show_btn_icon",
      "label": "Show cart icon on button",
      "default": true
    },
    {
      "type": "select",
      "id": "button_style",
      "label": "Button style",
      "default": "default",
      "options": [
        { "value": "default", "label": "Default" },
        { "value": "outline", "label": "Outline" }
      ]
    },
    {
      "type": "select",
      "id": "button_color",
      "label": "Button color",
      "default": "dark",
      "options": [
        { "value": "dark", "label": "Dark" },
        { "value": "light", "label": "Light" },
        { "value": "primary", "label": "Primary" }
      ]
    },
    {
      "type": "select",
      "id": "button_effect",
      "label": "Button hover effect",
      "default": "sweep-to-right",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "sweep-to-right", "label": "Sweep to right" },
        { "value": "sweep-to-left", "label": "Sweep to left" },
        { "value": "sweep-to-top", "label": "Sweep to top" },
        { "value": "sweep-to-bottom", "label": "Sweep to bottom" }
      ]
    },
    {
      "type": "range",
      "id": "btn_round",
      "min": 0,
      "max": 50,
      "step": 1,
      "label": "Button border radius",
      "unit": "px",
      "default": 40
    },
    {
      "type": "checkbox",
      "id": "btn_atc_full",
      "label": "Full width button",
      "default": false
    },
    {
      "type": "select",
      "id": "btn_txt",
      "label": "Button text style",
      "default": "3",
      "options": [
        { "value": "1", "label": "Style 1" },
        { "value": "2", "label": "Style 2" },
        { "value": "3", "label": "Style 3" }
      ]
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "select",
      "id": "ani",
      "label": "Add to cart animation",
      "default": "none",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "fly", "label": "Fly to cart" },
        { "value": "popup", "label": "Popup" },
        { "value": "drawer", "label": "Drawer" }
      ]
    },
    {
      "type": "range",
      "id": "animation_time",
      "min": 1,
      "max": 10,
      "step": 1,
      "label": "Animation duration",
      "unit": "sec",
      "default": 6
    },
    {
      "type": "header",
      "content": "Dynamic checkout"
    },
    {
      "type": "checkbox",
      "id": "show_dynamic_checkout",
      "label": "Show dynamic checkout button",
      "default": false
    },
    {
      "type": "select",
      "id": "button_color_payment",
      "label": "Dynamic checkout color",
      "default": "dark",
      "options": [
        { "value": "dark", "label": "Dark" },
        { "value": "light", "label": "Light" }
      ]
    },
    {
      "type": "select",
      "id": "btn_txt2",
      "label": "Dynamic checkout text style",
      "default": "3",
      "options": [
        { "value": "1", "label": "Style 1" },
        { "value": "2", "label": "Style 2" },
        { "value": "3", "label": "Style 3" }
      ]
    },
    {
      "type": "header",
      "content": "Wishlist & Compare"
    },
    {
      "type": "checkbox",
      "id": "enable_wishlist",
      "label": "Enable wishlist",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_compare",
      "label": "Enable compare",
      "default": false
    },
    {
      "type": "color",
      "id": "wishlist_color",
      "label": "Wishlist icon color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "wishlist_color_hover",
      "label": "Wishlist hover color",
      "default": "#fa0000"
    },
    {
      "type": "color",
      "id": "wishlist_color_active",
      "label": "Wishlist active color",
      "default": "#e81e1e"
    },
    {
      "type": "color",
      "id": "compare_color",
      "label": "Compare icon color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "compare_color_hover",
      "label": "Compare hover color",
      "default": "#fa0000"
    },
    {
      "type": "range",
      "id": "wis_cp_btn_round",
      "min": 0,
      "max": 50,
      "step": 1,
      "label": "Wishlist/compare button radius",
      "unit": "px",
      "default": 40
    }
  ],
  "presets": [
    {
      "name": "Product add to cart"
    }
  ]
}
{% endschema %}
