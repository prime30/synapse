{%- comment -%}
  Product Structured Data Module (JSON-LD)
  Renders schema.org Product markup for SEO.

  Required variables:
    product, current_variant, shsd_product_variants, shsd_product_media, sid
{%- endcomment -%}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant | default: shsd_product_variants.first
  if product.selected_or_first_available_variant.featured_media
    assign seo_media = product.selected_or_first_available_variant.featured_media
  else
    assign seo_media = product.featured_media
  endif
-%}

<script>
  window.__PRODUCT_HANDLE__ = {{ product.handle | json }};
</script>
{{ 'product-form-dynamic.js' | asset_url | script_tag }}

{%- unless product == empty -%}
  <script type="application/json" id="ModelJson-{{ sid }}">
    {{ shsd_product_media | where: 'media_type', 'model' | json }}
  </script>
{%- endunless -%}

<script type="application/ld+json">
  {
    "@context": "http://schema.org/",
    "@type": "Product",
    "name": {{ product.title | json }},
    "url": "{{ request.origin }}{{ product.url }}",
    {%- if seo_media != blank -%}
    "image": "https:{{ seo_media | image_url: width: seo_media.preview_image.width }}",
    {%- endif -%}
    "description": {{ product.description | strip_html | escape | strip_newlines | json }},
    "sku": "{{ current_variant.sku | default: current_variant.id }}",
    "mpn": "{{ current_variant.barcode }}",
    "productID": "{{ product.id }}",
    "brand": {
      "@type": "Brand",
      "name": "{{ product.vendor | escape }}"
    },
    {%- if product.price_varies -%}
    "offers": [
    {%- capture not_change -%}
        "@type" :"Offer",
        "availability" :"http://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}",
        "priceCurrency" :"{{ cart.currency.iso_code }}",
        "itemCondition": "https://schema.org/NewCondition",
        "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' | url_encode | replace: '+', '%20' }}",
    {%- endcapture -%}
    {%- for variant in shsd_product_variants -%}{%- assign barcode_size = variant.barcode.size -%}
        {
        {{ not_change }}
        "sku": "{{ variant.sku | default: variant.id }}",
        "price" :"{{ variant.price | divided_by: 100.00 }}",
        "mpn": "{{ variant.barcode }}",
        {%- if barcode_size == 12 or barcode_size == 13 or barcode_size == 14 -%}"gtin{{ barcode_size }}": "{{ variant.barcode }}",{%- endif -%}
        "url" :"{{ request.origin }}{{ variant.url }}"
        }{% unless forloop.last %},{% endunless -%}
    {%- endfor -%}
    ]
    {%- else -%}
    "offers": {
      "@type" :"Offer",
      "sku": "{{ current_variant.sku | default: current_variant.id }}",
      "availability" :"http://schema.org/{% if product.available %}InStock{% else %}OutOfStock{% endif %}",
      "price" :"{{ product.price | divided_by: 100.00 }}",
      "priceCurrency" :"{{ cart.currency.iso_code }}",
      "itemCondition": "https://schema.org/NewCondition",
      "url" :"{{ request.origin }}{{ product.url }}",
      "mpn": "{{ current_variant.barcode }}",
      {%- assign barcode_size = current_variant.barcode.size -%}{%- if barcode_size == 12 or barcode_size == 13 or barcode_size == 14 -%}"gtin{{ barcode_size }}": "{{ current_variant.barcode }}",{%- endif -%}
      "priceValidUntil": "{{ 'now' | date: '%s' | plus: 31536000 | date: '%Y-%m-%d' | url_encode | replace: '+', '%20' }}"
    }
    {%- endif -%}
    {%- assign review_app = settings.app_review | default: '1' -%}
    {%- case review_app -%}
      {%- when '1' -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "description": "Shopify Product Reviews",
        "ratingCount": {{ product.metafields.reviews.rating.value.rating | default: 0 }},
        "ratingValue": {{ product.metafields.reviews.rating_count | default: 0 }}
      }
      {%- when '2' -%}{%- assign aggregateRating = product.metafields.ryviu.product_reviews_info | split: ";" -%}{%- assign ratingCount = aggregateRating[0] -%}
      {%- if ratingCount != "0" and ratingCount != blank -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingCount": {{ ratingCount | plus: 0 }},
        "ratingValue": {{ aggregateRating[1] | plus: 0 }}
      }
      {%- endif -%}
      {%- when '3' -%}{%- assign ratingCount = product.metafields.ali.reviews_count -%}
      {%- if ratingCount != "0" and ratingCount != blank -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingCount": {{ ratingCount }},
        "ratingValue": {{ product.metafields.ali.reviews_average }}
      }
      {%- endif -%}
      {%- when '4' -%}{%- assign ratingCount = product.metafields.loox.num_reviews -%}
      {%- if ratingCount != "0" and ratingCount != blank -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingCount": {{ ratingCount }},
        "ratingValue": {{ product.metafields.loox.avg_rating }}
      }
      {%- endif -%}
      {%- when 'stamped' -%}{%- assign ratingCount = product.metafields.stamped.reviews_count -%}
      {%- if ratingCount != "0" and ratingCount != blank -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingCount": {{ ratingCount }},
        "ratingValue": {{ product.metafields.stamped.reviews_average }}
      }
      {%- endif -%}
    {%- endcase -%}
  }
</script>
