{% comment %}
  Quick View Modal
  Renders a single reusable modal that loads product data dynamically.
  Include once in layout/theme.liquid or render_bottom.liquid:
    {% render 'quick-view-modal' %}
  Trigger from any element with:
    <button data-quick-view-trigger="{{ product.handle }}">Quick View</button>
{% endcomment %}

<div id="qv-modal" class="qv-modal" aria-hidden="true" role="dialog" aria-label="{{ 'products.product_card.quick_view' | t | default: 'Quick view' }}">
  <div class="qv-modal__backdrop" data-qv-close></div>

  <div class="qv-modal__panel">
    <button class="qv-modal__close" data-qv-close type="button" aria-label="{{ 'general.popup.close' | t | default: 'Close' }}">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>

    {%- comment %} Loading spinner — visible while fetching product data {% endcomment -%}
    <div class="qv-modal__loader" data-qv-loader>
      <div class="qv-spinner">
        <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
          <circle cx="20" cy="20" r="16" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="80" stroke-dashoffset="60" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    {%- comment %} Product content — populated by JS {% endcomment -%}
    <div class="qv-modal__body" data-qv-body style="display:none;">
      <div class="qv-modal__media">
        <img data-qv-image src="" alt="" loading="lazy" width="600" height="600">
        <span class="t4s-badge-item t4s-badge-sale t4s-sale-pct" data-qv-sale-badge style="display:none;"></span>
      </div>
      <div class="qv-modal__info">
        <h2 class="qv-modal__title" data-qv-title></h2>
        <div class="qv-modal__price">
          <span class="qv-modal__price-sale" data-qv-price></span>
          <span class="qv-modal__price-compare" data-qv-compare-price></span>
        </div>
        <div class="qv-modal__description" data-qv-description></div>
        <form method="post" action="/cart/add" class="qv-modal__form">
          <input type="hidden" name="id" data-qv-variant-id value="">
          <div class="qv-modal__qty">
            <label for="qv-quantity" class="visually-hidden">{{ 'products.product.quantity' | t | default: 'Quantity' }}</label>
            <button type="button" class="qv-modal__qty-btn" data-qv-qty-minus aria-label="Decrease quantity">−</button>
            <input type="number" id="qv-quantity" name="quantity" value="1" min="1" max="9999" class="qv-modal__qty-input">
            <button type="button" class="qv-modal__qty-btn" data-qv-qty-plus aria-label="Increase quantity">+</button>
          </div>
          <button type="submit" class="qv-modal__atc" data-qv-atc>
            <span class="qv-modal__atc-text">{{ 'products.product.add_to_cart' | t | default: 'Add to cart' }}</span>
            <span class="qv-modal__atc-loading" style="display:none;">
              <svg width="20" height="20" viewBox="0 0 40 40"><circle cx="20" cy="20" r="16" fill="none" stroke="currentColor" stroke-width="3" stroke-dasharray="80" stroke-dashoffset="60" stroke-linecap="round"/></svg>
            </span>
          </button>
        </form>
        <a class="qv-modal__view-full" data-qv-link href="">
          {{ 'products.product_card.view_full' | t | default: 'View full details' }} →
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  .qv-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, visibility 0.25s ease;
  }
  .qv-modal[aria-hidden="false"] {
    pointer-events: auto;
    opacity: 1;
    visibility: visible;
  }

  /* Backdrop */
  .qv-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    cursor: pointer;
  }

  /* Panel — desktop centered */
  .qv-modal__panel {
    position: relative;
    background: var(--t4s-light-color, #fff);
    color: var(--t4s-dark-color, #1a1a1a);
    border-radius: 12px;
    max-width: 860px;
    width: 92vw;
    max-height: 85vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    box-shadow: 0 25px 60px rgba(0, 0, 0, 0.15);
    transform: scale(0.96);
    transition: transform 0.3s cubic-bezier(0.32, 0.72, 0, 1);
  }
  .qv-modal[aria-hidden="false"] .qv-modal__panel {
    transform: scale(1);
  }

  /* Close button */
  .qv-modal__close {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 2;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 6px;
    color: inherit;
    border-radius: 50%;
    transition: background 0.2s;
  }
  .qv-modal__close:hover {
    background: rgba(0, 0, 0, 0.06);
  }

  /* Loader */
  .qv-modal__loader {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 260px;
  }
  .qv-spinner svg {
    animation: qv-spin 0.8s linear infinite;
    color: var(--accent-color, #333);
  }
  @keyframes qv-spin {
    to { transform: rotate(360deg); }
  }

  /* Body — 2 column on desktop */
  .qv-modal__body {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
  }

  /* Media */
  .qv-modal__media {
    position: relative;
    overflow: hidden;
    border-radius: 12px 0 0 12px;
    background: var(--t4s-bg-1, #f5f5f5);
  }
  .qv-modal__media img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Info */
  .qv-modal__info {
    padding: 28px 28px 24px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    overflow-y: auto;
  }
  .qv-modal__title {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: 1.3;
    margin: 0;
  }

  /* Price */
  .qv-modal__price {
    display: flex;
    align-items: baseline;
    gap: 8px;
    flex-wrap: wrap;
  }
  .qv-modal__price-sale {
    font-size: 1.15rem;
    font-weight: 600;
  }
  .qv-modal__price-compare {
    font-size: 0.95rem;
    text-decoration: line-through;
    opacity: 0.5;
  }
  .qv-modal__price-compare:empty {
    display: none;
  }

  /* Description */
  .qv-modal__description {
    font-size: 0.9rem;
    line-height: 1.55;
    opacity: 0.75;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .qv-modal__description:empty {
    display: none;
  }

  /* Quantity */
  .qv-modal__qty {
    display: flex;
    align-items: center;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    width: fit-content;
  }
  .qv-modal__qty-btn {
    width: 36px;
    height: 36px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    color: inherit;
  }
  .qv-modal__qty-input {
    width: 44px;
    text-align: center;
    border: none;
    background: none;
    font-size: 0.95rem;
    -moz-appearance: textfield;
    color: inherit;
  }
  .qv-modal__qty-input::-webkit-inner-spin-button,
  .qv-modal__qty-input::-webkit-outer-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* Add to cart button */
  .qv-modal__atc {
    width: 100%;
    padding: 12px 20px;
    border: none;
    border-radius: 8px;
    background: var(--accent-color, #1a1a1a);
    color: var(--accent-text, #fff);
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .qv-modal__atc:hover { opacity: 0.85; }
  .qv-modal__atc:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .qv-modal__atc-loading svg {
    animation: qv-spin 0.8s linear infinite;
    color: currentColor;
  }

  /* View full link */
  .qv-modal__view-full {
    font-size: 0.85rem;
    color: var(--secondary-color, #555);
    text-decoration: none;
    margin-top: auto;
    transition: color 0.2s;
  }
  .qv-modal__view-full:hover {
    color: var(--accent-color, #1a1a1a);
  }

  /* ========================================
     MOBILE: slide-up drawer (<768px)
     ======================================== */
  @media (max-width: 767px) {
    .qv-modal {
      align-items: flex-end;
    }
    .qv-modal__panel {
      width: 100%;
      max-width: 100%;
      max-height: 90vh;
      max-height: 90dvh;
      border-radius: 16px 16px 0 0;
      transform: translateY(100%);
      transition: transform 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    }
    .qv-modal[aria-hidden="false"] .qv-modal__panel {
      transform: translateY(0);
    }

    /* Drag handle indicator */
    .qv-modal__panel::before {
      content: '';
      display: block;
      width: 36px;
      height: 4px;
      border-radius: 2px;
      background: rgba(0, 0, 0, 0.15);
      margin: 10px auto 4px;
    }

    /* Stack to single column */
    .qv-modal__body {
      grid-template-columns: 1fr;
    }
    .qv-modal__media {
      border-radius: 0;
      max-height: 50vh;
      max-height: 50dvh;
    }
    .qv-modal__info {
      padding: 20px 20px 28px;
    }
    .qv-modal__close {
      top: 16px;
      right: 16px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }
  }
</style>

<script>
  (function () {
    var modal = document.getElementById('qv-modal');
    if (!modal) return;

    var loader = modal.querySelector('[data-qv-loader]');
    var body = modal.querySelector('[data-qv-body]');
    var elImage = modal.querySelector('[data-qv-image]');
    var elTitle = modal.querySelector('[data-qv-title]');
    var elPrice = modal.querySelector('[data-qv-price]');
    var elCompare = modal.querySelector('[data-qv-compare-price]');
    var elDesc = modal.querySelector('[data-qv-description]');
    var elVariantId = modal.querySelector('[data-qv-variant-id]');
    var elLink = modal.querySelector('[data-qv-link]');
    var elAtc = modal.querySelector('[data-qv-atc]');
    var elAtcText = modal.querySelector('.qv-modal__atc-text');
    var elAtcLoading = modal.querySelector('.qv-modal__atc-loading');
    var elQtyInput = modal.querySelector('#qv-quantity');
    var elSaleBadge = modal.querySelector('[data-qv-sale-badge]');
    var cache = {};

    function formatMoney(cents) {
      return (Shopify && Shopify.formatMoney)
        ? Shopify.formatMoney(cents)
        : (window.theme && theme.Currency && theme.Currency.formatMoney
            ? theme.Currency.formatMoney(cents)
            : '$' + (cents / 100).toFixed(2));
    }

    function openModal() {
      modal.setAttribute('aria-hidden', 'false');
      document.documentElement.style.overflow = 'hidden';
    }
    function closeModal() {
      modal.setAttribute('aria-hidden', 'true');
      document.documentElement.style.overflow = '';
    }

    function showLoader() {
      loader.style.display = '';
      body.style.display = 'none';
    }
    function showBody() {
      loader.style.display = 'none';
      body.style.display = '';
    }

    function populate(product) {
      var variant = product.variants[0];
      var image = product.featured_image || (product.images && product.images[0]) || '';
      var imgSrc = (typeof image === 'string') ? image : image.src || '';

      if (imgSrc && imgSrc.indexOf('//') === 0) imgSrc = 'https:' + imgSrc;

      elImage.src = imgSrc;
      elImage.alt = product.title;
      elTitle.textContent = product.title;
      elPrice.textContent = formatMoney(variant.price);

      if (variant.compare_at_price && variant.compare_at_price > variant.price) {
        elCompare.textContent = formatMoney(variant.compare_at_price);
        var pct = Math.round((variant.compare_at_price - variant.price) / variant.compare_at_price * 100);
        if (pct > 0 && elSaleBadge) {
          elSaleBadge.textContent = '-' + pct + '%';
          elSaleBadge.style.display = '';
        }
      } else {
        elCompare.textContent = '';
        if (elSaleBadge) elSaleBadge.style.display = 'none';
      }

      var desc = product.body_html || '';
      var tmp = document.createElement('div');
      tmp.innerHTML = desc;
      var plain = (tmp.textContent || tmp.innerText || '').trim();
      elDesc.textContent = plain.length > 200 ? plain.substring(0, 200) + '…' : plain;

      elVariantId.value = variant.id;
      elLink.href = '/products/' + product.handle;
      elQtyInput.value = 1;

      if (!variant.available) {
        elAtc.disabled = true;
        elAtcText.textContent = '{{ "products.product.sold_out" | t | default: "Sold out" }}';
      } else {
        elAtc.disabled = false;
        elAtcText.textContent = '{{ "products.product.add_to_cart" | t | default: "Add to cart" }}';
      }
    }

    function loadProduct(handle) {
      showLoader();
      openModal();

      if (cache[handle]) {
        populate(cache[handle]);
        showBody();
        return;
      }

      fetch('/products/' + handle + '.json')
        .then(function (r) { return r.json(); })
        .then(function (data) {
          cache[handle] = data.product;
          populate(data.product);
          showBody();
        })
        .catch(function () {
          closeModal();
        });
    }

    /* Close handlers */
    modal.querySelectorAll('[data-qv-close]').forEach(function (el) {
      el.addEventListener('click', closeModal);
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && modal.getAttribute('aria-hidden') === 'false') closeModal();
    });

    /* Quantity buttons */
    modal.querySelector('[data-qv-qty-minus]').addEventListener('click', function () {
      var v = parseInt(elQtyInput.value, 10) || 1;
      if (v > 1) elQtyInput.value = v - 1;
    });
    modal.querySelector('[data-qv-qty-plus]').addEventListener('click', function () {
      var v = parseInt(elQtyInput.value, 10) || 1;
      elQtyInput.value = v + 1;
    });

    /* AJAX add-to-cart */
    modal.querySelector('.qv-modal__form').addEventListener('submit', function (e) {
      e.preventDefault();
      if (elAtc.disabled) return;

      elAtcText.style.display = 'none';
      elAtcLoading.style.display = '';
      elAtc.disabled = true;

      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({
          id: parseInt(elVariantId.value, 10),
          quantity: parseInt(elQtyInput.value, 10) || 1
        })
      })
      .then(function (r) { return r.json(); })
      .then(function () {
        elAtcText.textContent = '{{ "products.product_card.added" | t | default: "Added!" }}';
        elAtcText.style.display = '';
        elAtcLoading.style.display = 'none';
        setTimeout(function () {
          elAtcText.textContent = '{{ "products.product.add_to_cart" | t | default: "Add to cart" }}';
          elAtc.disabled = false;
          closeModal();
          /* Trigger theme cart update if available */
          if (typeof t4s !== 'undefined' && t4s.updateCart) t4s.updateCart();
          document.dispatchEvent(new CustomEvent('cart:updated'));
        }, 1200);
      })
      .catch(function () {
        elAtcText.textContent = '{{ "general.popup.error" | t | default: "Error" }}';
        elAtcText.style.display = '';
        elAtcLoading.style.display = 'none';
        elAtc.disabled = false;
      });
    });

    /* Delegate trigger clicks */
    document.addEventListener('click', function (e) {
      var trigger = e.target.closest('[data-quick-view-trigger]');
      if (!trigger) return;
      e.preventDefault();
      var handle = trigger.getAttribute('data-quick-view-trigger');
      if (handle) loadProduct(handle);
    });
  })();
</script>
