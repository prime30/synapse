{%- liquid
  assign se_stts = section.settings
  assign bg_color = se_stts.bg_color
  assign text_color = se_stts.text_color
  assign font_size = se_stts.font_size
  assign bar_padding = se_stts.bar_padding
  assign dismissible = se_stts.dismissible
  assign separator = se_stts.separator
-%}

{%- if section.blocks.size > 0 -%}
  {%- style -%}
    #t4s-announcement-bar-{{ section.id }} {
      background-color: {{ bg_color }};
      color: {{ text_color }};
      font-size: {{ font_size }}px;
      padding: {{ bar_padding }}px 20px;
      text-align: center;
      position: relative;
      z-index: 10;
    }
    #t4s-announcement-bar-{{ section.id }} a {
      color: {{ text_color }};
      text-decoration: underline;
      text-underline-offset: 2px;
    }
    #t4s-announcement-bar-{{ section.id }} a:hover {
      opacity: 0.8;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__inner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      position: relative;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__messages {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0;
      overflow: hidden;
      flex: 1;
      min-width: 0;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__msg {
      white-space: nowrap;
      flex-shrink: 0;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__sep {
      flex-shrink: 0;
      margin: 0 12px;
      opacity: 0.5;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__close {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: {{ text_color }};
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      transition: opacity 0.2s;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__close:hover {
      opacity: 0.6;
    }
    #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__close svg {
      width: 14px;
      height: 14px;
    }
    #t4s-announcement-bar-{{ section.id }}.t4s-hidden {
      display: none;
    }
    @media (max-width: 749px) {
      #t4s-announcement-bar-{{ section.id }} {
        font-size: {{ font_size | minus: 1 }}px;
        padding: {{ bar_padding | minus: 2 }}px 14px;
      }
      #t4s-announcement-bar-{{ section.id }} .t4s-ann-bar__sep {
        margin: 0 8px;
      }
    }
  {%- endstyle -%}

  <div
    id="t4s-announcement-bar-{{ section.id }}"
    role="region"
    aria-label="{{ 'sections.announcement.label' | t | default: 'Announcement' }}"
  >
    <div class="t4s-container">
      <div class="t4s-ann-bar__inner">
        <div class="t4s-ann-bar__messages">
          {%- for block in section.blocks -%}
            {%- if block.settings.text != blank -%}
              {%- if forloop.index > 1 -%}
                <span class="t4s-ann-bar__sep" aria-hidden="true">{{ separator }}</span>
              {%- endif -%}

              <div class="t4s-ann-bar__msg" {{ block.shopify_attributes }}>
                {%- if block.settings.link != blank -%}
                  <a href="{{ block.settings.link }}">{{ block.settings.text }}</a>
                {%- else -%}
                  <span>{{ block.settings.text }}</span>
                {%- endif -%}
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>

        {%- if dismissible -%}
          <button
            class="t4s-ann-bar__close"
            aria-label="{{ 'sections.announcement.close' | t | default: 'Dismiss announcement' }}"
            data-dismiss-ann="{{ section.id }}"
          >
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M2 2l12 12M14 2L2 14"></path>
            </svg>
          </button>
        {%- endif -%}
      </div>
    </div>
  </div>

  {%- if dismissible -%}
    <script>
      (function() {
        var id = {{ section.id | json }};
        var key = 't4s_ann_bar_dismissed_' + id;
        var el = document.getElementById('t4s-announcement-bar-' + id);
        if (!el) return;

        if (localStorage.getItem(key) === 'true') {
          el.classList.add('t4s-hidden');
          el.setAttribute('aria-hidden', 'true');
          return;
        }

        var btn = el.querySelector('[data-dismiss-ann]');
        if (btn) {
          btn.addEventListener('click', function() {
            el.classList.add('t4s-hidden');
            el.setAttribute('aria-hidden', 'true');
            localStorage.setItem(key, 'true');
          });
        }
      })();
    </script>
  {%- endif -%}
{%- endif -%}

{% schema %}
{
  "name": "Announcement bar",
  "tag": "section",
  "class": "t4s-section t4s-section-announcement-bar",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background color",
      "default": "#1a1a2e"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font size",
      "default": 13,
      "min": 10,
      "max": 22,
      "step": 1,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "bar_padding",
      "label": "Vertical padding",
      "default": 10,
      "min": 4,
      "max": 24,
      "step": 2,
      "unit": "px"
    },
    {
      "type": "text",
      "id": "separator",
      "label": "Message separator",
      "info": "Character shown between messages when multiple blocks are used.",
      "default": "Â·"
    },
    {
      "type": "checkbox",
      "id": "dismissible",
      "label": "Allow visitors to dismiss",
      "info": "Adds a close button. Dismissed state is saved in the browser.",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "message",
      "name": "Message",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "label": "Text",
          "default": "Free shipping on orders over $50"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link URL",
          "info": "Optional. Wraps the message in a clickable link."
        }
      ]
    }
  ],
  "max_blocks": 5,
  "presets": [
    {
      "name": "Announcement bar",
      "category": "group8",
      "blocks": [
        {
          "type": "message",
          "settings": {
            "text": "Free shipping on orders over $50"
          }
        }
      ]
    }
  ]
}
{% endschema %}
