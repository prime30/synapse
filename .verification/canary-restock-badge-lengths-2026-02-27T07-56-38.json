{
  "timestamp": "2026-02-27T07:56:38.218Z",
  "projectId": "838e7498-6dc5-4268-9fcd-e6f6148f65ad",
  "scenario": "restock-badge-lengths",
  "prompt": "On the product page template, update product-form-dynamic so out-of-stock color swatches with \"Awaiting Restock\" also show a second line listing available longer lengths for that color. Implement all three layers in one pass: (1) Liquid markup in snippets/product-form-dynamic.liquid, (2) styling in assets/product-form-dynamic.css, and (3) behavior/data handling in assets/product-form-dynamic.js. The length list must come from variant option1 availability and must exclude any lengths present in the product metafield list custom_values. Ensure text contrast is background-aware over swatch images.",
  "totalRuns": 1,
  "results": [
    {
      "run": 1,
      "passed": true,
      "reason": "Applied required files (3/3) in 23 tool calls",
      "metrics": {
        "totalToolCalls": 23,
        "editToolCalls": 4,
        "readToolCalls": 17,
        "searchToolCalls": 0,
        "elapsedMs": 162258,
        "costCents": 151,
        "inputTokens": 483747,
        "outputTokens": 3578
      },
      "tier": "COMPLEX",
      "strategy": "GOD_MODE",
      "changedFiles": [
        "snippets/product-form-dynamic.liquid",
        "assets/product-form-dynamic.css",
        "assets/product-form-dynamic.js",
        "product-form-dynamic.js",
        "product-form-dynamic.liquid"
      ],
      "transcript": {
        "runId": "run-1",
        "scenario": "restock-badge-lengths",
        "decisions": [
          {
            "phase": "analyzing",
            "label": "Loading context...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Context ready",
            "detail": "606 files, 5 prefs",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Building context...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Classifying request...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Preparing file context...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Building structural brief...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Starting agent...",
            "timestamp": 0
          },
          {
            "phase": "strategy",
            "label": "Strategy: GOD_MODE",
            "detail": "strategy=GOD_MODE, tier=COMPLEX",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "COMPLEX tier — GOD_MODE strategy — claude-sonnet-4-6",
            "detail": "routingTier=COMPLEX, strategy=GOD_MODE",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Style profile loaded",
            "detail": "styleProfileRules=8, designTokenCount=0, patternConflictResolutions=0, referenceSectionsLoaded=0, cssPreloaded=false, snippetConsumers=0",
            "timestamp": 0
          }
        ],
        "toolSequence": [
          {
            "name": "read_lines",
            "id": "toolu_016TEFKhLaUH6f7ovrC9cPMP",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 1,
                  "endLine": 80
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01F8ZhJmJR8xhLfTLK2sNaT7",
            "input": {
              "filePath": "assets/product-form-dynamic.css",
              "ranges": [
                {
                  "startLine": 606,
                  "endLine": 799
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01295s5cjgnonErJe6xpBczf",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 80,
                  "endLine": 200
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01JT1GKMSjn7VyTn3bMzTxoq",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1,
                  "endLine": 80
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01QdGZXQLJu8tRjzFx6RmkD1",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 200,
                  "endLine": 380
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_0128DpNN4xNQCgNsaJzLDDLP",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 82,
                  "endLine": 300
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_013WGE1QvYMQJgi1YfU86tFx",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 380,
                  "endLine": 560
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_012GP5H2Gi6QF8Xycetqu44y",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 300,
                  "endLine": 550
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01St1a6ac9ihDUbapeZ9BUsV",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 560,
                  "endLine": 700
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01XZzX1rrUWZw8NQxP8fQ3AB",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 550,
                  "endLine": 800
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_019YmjSdFKbzmZhnzdafpAXN",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 800,
                  "endLine": 1050
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_014sLSZnC1Jd396zTvY2WTCi",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1050,
                  "endLine": 1200
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01Ky6B1536J2CgggYqAv2PPk",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1200,
                  "endLine": 1400
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01K2W7uUHNgjZvuSmbBWHq9S",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1400,
                  "endLine": 1600
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01S3kGbDfaUmQD4KJm9aqe2W",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 895,
                  "endLine": 915
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01VaWcHV5EtLKwEK6v4WRxJT",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 838,
                  "endLine": 930
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "check_lint",
            "id": "toolu_01Wh2HmbZSde7Q3oaWaPQ7Nm",
            "input": {
              "fileName": "assets/product-form-dynamic.js"
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "check_lint",
            "id": "toolu_01Sn4CGupK72EKp4pzhzJbdk",
            "input": {
              "fileName": "snippets/product-form-dynamic.liquid"
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01CjgKZPUscTTQLKfcjHtefo",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 130,
                  "endLine": 140
                }
              ]
            },
            "result": "",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "propose_code_edit",
            "id": "pm-change-1772178862459",
            "input": {
              "filePath": "product-form-dynamic.js",
              "newContent": "(() => {\n  /*\n   * Product Form Dynamic (PFD) - Unique Class Names:\n   * - .pfd-variant-images (container for variant image data)\n   * - .pfd-main-imgs (main images container)\n   * - .pfd-thumb-imgs (thumbnail images container)\n   * - .pfd-img-listing (individual variant image listing)\n   * - .pfd-media-item (main image item)\n   * - .pfd-media-thumb (thumbnail item)\n   * - .pfd-img (thumbnail background image div)\n   * - data-pfd-variant-id (variant ID attribute)\n   * - .pfd-split-selection (split selection container)\n   * - .pfd-standard-options (standard swatch options)\n   * - .pfd-custom-options (custom dropdown options)\n   * - .pfd-custom-dropdown (custom dropdown button)\n   */\n\n  // Get custom option names from metafield (passed from Liquid)\n  const CUSTOM_OPTION_NAMES = window.__CUSTOM_OPTION_NAMES__ || [];\n\n  function isCustomOption(optionValue) {\n    // Handle both cleaned (quotes removed) and uncleaned values\n    const cleanedOptionValue = optionValue.replace(/\"/g, \"\");\n    return CUSTOM_OPTION_NAMES.some((customName) => {\n      const cleanedCustomName = customName.replace(/\"/g, \"\");\n      return (\n        optionValue.toLowerCase().includes(customName.toLowerCase()) ||\n        cleanedOptionValue\n          .toLowerCase()\n          .includes(cleanedCustomName.toLowerCase())\n      );\n    });\n  }\n\n  // Check if ANY currently selected option is a custom option\n  // Note: selectedValues is defined later, so this function is used after initialization\n  function hasCustomOptionSelected(selectedValuesArray) {\n    for (const val of selectedValuesArray) {\n      if (val && isCustomOption(val)) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  // Override theme's swatch click handler\n  function setupSwatchOverride() {\n    // Use event capturing to intercept clicks before theme's handler\n    document.addEventListener(\n      \"click\",\n      function (e) {\n        const swatchItem = e.target.closest(\n          \"[data-swatch-item]:not(.is--selected)\",\n        );\n        if (!swatchItem) return;\n\n        // Check if this is within our product form\n        const productForm = swatchItem.closest(\n          \".t4s-product-form__variants, .t4s-form__product\",\n        );\n        if (!productForm) return;\n\n        // Stop the theme's handler from running\n        e.stopImmediatePropagation();\n        e.preventDefault();\n\n        // Let our custom handler process it\n        handleCustomSwatchClick(swatchItem, e);\n      },\n      true,\n    ); // Use capture phase\n  }\n\n  function handleCustomSwatchClick(swatchItem, originalEvent) {\n    const optEl = swatchItem.closest(\"[data-swatch-option]\");\n    if (!optEl) return;\n\n    const optionIndex = Number(optEl.getAttribute(\"data-id\"));\n    if (Number.isNaN(optionIndex)) return;\n\n    // Handle split selection - clear selections from both standard and custom areas\n    if (optEl.classList.contains(\"pfd-split-option\")) {\n      optEl\n        .querySelectorAll(\"[data-swatch-item].is--selected\")\n        .forEach((el) => el.classList?.remove(\"is--selected\"));\n\n      // Update custom dropdown text if selecting a standard option\n      const value = swatchItem.getAttribute(\"data-value\") || \"\";\n\n      // Check if this swatch item is from the custom options area\n      const isFromCustomDropdown = swatchItem.closest(\".pfd-custom-options\");\n\n      if (!isFromCustomDropdown) {\n        // Reset custom dropdown to default state when selecting standard option\n        const customDropdown = optEl.querySelector(\n          \".pfd-custom-dropdown [data-current-value]\",\n        );\n        if (customDropdown) {\n          const optionName = optEl.getAttribute(\"data-option-name\") || \"\";\n          customDropdown.textContent = `Custom ${optionName.toLowerCase()}`;\n        }\n\n        // Hide custom notice when standard option is selected\n        const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n        if (customNotice) {\n          customNotice.style.display = \"none\";\n        }\n\n        // Remove active state from dropdown button when standard option is selected\n        const dropdownButton = optEl.querySelector(\".pfd-custom-dropdown\");\n        if (dropdownButton) {\n          dropdownButton.classList.remove(\"is--selected\");\n        }\n      }\n    } else {\n      // Standard handling for non-split options\n      optEl\n        .querySelectorAll(\"[data-swatch-item].is--selected\")\n        .forEach((el) => el.classList?.remove(\"is--selected\"));\n    }\n\n    // Always add selected class to the clicked item\n    swatchItem.classList.add(\"is--selected\");\n\n    // Update current value display - handle both Color and Non-Color structures\n    const value = swatchItem.getAttribute(\"data-value\") || \"\";\n    const optionUnit = optEl.getAttribute(\"data-option-unit\") || \"\";\n    const displayValue = getDisplayValue(value, optionUnit);\n\n    // Check if this is a custom option to add badge\n    const isFromCustomDropdown = swatchItem.closest(\".pfd-custom-options\");\n    let titleElement = optEl.querySelector(\".t4s-swatch__title--right .bold\");\n    if (titleElement) {\n      // Non-Color section structure\n      titleElement.textContent = displayValue;\n    } else {\n      // Color section structure - use the wrapper span\n      titleElement = optEl.querySelector(\".t4s-selected-value\");\n      if (titleElement) {\n        titleElement.textContent = displayValue;\n      }\n    }\n\n    // Update custom dropdown display for selected custom options\n    if (isFromCustomDropdown) {\n      const customDropdown = optEl.querySelector(\n        \".pfd-custom-dropdown [data-current-value]\",\n      );\n      const customDropdownButton = optEl.querySelector(\".pfd-custom-dropdown\");\n      if (customDropdown) {\n        customDropdown.innerHTML = `${displayValue} <span class=\"pfd-custom-badge\">Custom</span>`;\n      }\n      // Add active state to dropdown button\n      if (customDropdownButton) {\n        customDropdownButton.classList.add(\"is--selected\");\n      }\n\n      // Show custom notice and update text\n      const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n      if (customNotice) {\n        const optionName = optEl.getAttribute(\"data-option-name\") || \"item\";\n        const noticeText = customNotice.querySelector(\n          \".pfd-custom-notice-text\",\n        );\n        if (noticeText) {\n          noticeText.innerHTML = `Custom ${optionName.toLowerCase()}s are <strong>made to order</strong>. Please allow <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery. Custom orders are non-cancellable/refundable.`;\n        }\n        customNotice.style.display = \"block\";\n      }\n    } else {\n      // Hide custom notice when standard option is selected\n      const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n      if (customNotice) {\n        customNotice.style.display = \"none\";\n      }\n      // Remove active state from dropdown button when standard option is selected\n      const customDropdownButton = optEl.querySelector(\".pfd-custom-dropdown\");\n      if (customDropdownButton) {\n        customDropdownButton.classList.remove(\"is--selected\");\n      }\n    }\n\n    // Update our internal state if PFD is initialized\n    if (window.__PFD && window.__PFD.selectedValues) {\n      window.__PFD.selectedValues[optionIndex] = normVal(value);\n\n      // Resolve variant and update select\n      const variantId = resolveVariantFromValues(window.__PFD.selectedValues);\n      if (variantId && window.__PFD.selectEl) {\n        // Update HTML data attributes with correct variant info before changing select\n        const variant = window.__PFD.variantById.get(variantId);\n        if (variant) {\n          const selectedOption = window.__PFD.selectEl.querySelector(\n            `option[value=\"${variantId}\"]`,\n          );\n          if (selectedOption) {\n            // Update HTML data attributes that the theme actually checks\n            selectedOption.setAttribute(\n              \"data-incoming\",\n              variant.incoming || \"false\",\n            );\n            selectedOption.setAttribute(\n              \"data-nextincomingdate\",\n              variant.nextIncomingDate || \"\",\n            );\n            selectedOption.setAttribute(\n              \"data-inventorypolicy\",\n              variant.inventoryPolicy || \"deny\",\n            );\n            selectedOption.setAttribute(\n              \"data-inventoryquantity\",\n              variant.inventoryQuantity || (variant.available ? \"999\" : \"0\"),\n            );\n          }\n        }\n\n        window.__PFD.selectEl.value = variantId;\n        window.__PFD.selectEl.dispatchEvent(\n          new Event(\"change\", { bubbles: true }),\n        );\n      }\n\n      // Update availability\n      if (typeof patchAllAvailability === \"function\") {\n        patchAllAvailability();\n      }\n    } else {\n      // Fallback: find the select and update it directly\n      const form = swatchItem.closest(\"form, .t4s-form__product\");\n      const selectEl = form?.querySelector('select[name=\"id\"]');\n      if (selectEl) {\n        // Get all selected values and find matching variant\n        const allOptions = form.querySelectorAll(\"[data-swatch-option]\");\n        const selectedValues = [];\n\n        allOptions.forEach((opt) => {\n          const idx = Number(opt.getAttribute(\"data-id\"));\n          const selected = opt.querySelector(\"[data-swatch-item].is--selected\");\n          selectedValues[idx] = selected\n            ? normVal(selected.getAttribute(\"data-value\") || \"\")\n            : \"\";\n        });\n\n        // Find matching option in select\n        const options = selectEl.querySelectorAll(\"option\");\n        for (const option of options) {\n          const optionMatches = selectedValues.every((val, idx) => {\n            if (!val) return true;\n            const optionVal =\n              option.getAttribute(`data-option${idx + 1}`) || \"\";\n            return normVal(optionVal) === val;\n          });\n\n          if (optionMatches) {\n            selectEl.value = option.value;\n            selectEl.dispatchEvent(new Event(\"change\", { bubbles: true }));\n            break;\n          }\n        }\n      }\n    }\n\n    // Manually trigger the thumbnail update functionality that the theme expects\n    // This replicates the jQuery code from main-product.liquid lines 5489+\n    if (typeof $ !== \"undefined\") {\n      setTimeout(() => {\n        triggerThumbnailUpdate();\n      }, 100);\n    }\n  }\n\n  // Manual thumbnail update function to maintain existing functionality\n  function triggerThumbnailUpdate() {\n    if (typeof $ === \"undefined\") return;\n\n    // Remove existing slick script to avoid conflicts\n    $(\n      'head script[src=\"https://kenwheeler.github.io/slick/slick/slick.js\"]',\n    ).remove();\n\n    setTimeout(function () {\n      var sel_var_id = $(\n        '.t4s-product-form__variants select[name=\"id\"] option:selected',\n      ).val();\n\n      if (!sel_var_id) {\n        return;\n      }\n\n      var sel_images = $(\n        \".pfd-variant-images .pfd-main-imgs .pfd-img-listing[data-pfd-variant-id='\" +\n          sel_var_id +\n          \"']\",\n      ).html();\n      var sel_thumb_img = $(\n        \".pfd-variant-images .pfd-thumb-imgs .pfd-img-listing[data-pfd-variant-id='\" +\n          sel_var_id +\n          \"']\",\n      ).html();\n      var data_var_img = $(\n        \".pfd-variant-images .pfd-main-imgs .pfd-img-listing[data-pfd-variant-id='\" +\n          sel_var_id +\n          \"']\",\n      ).attr(\"data-var-img\");\n\n      // Check if we have variant images or just a single image\n      var mediaItemCount = 0;\n      if (sel_images && sel_images.trim() !== \"\") {\n        mediaItemCount = $(sel_images).filter(\".pfd-media-item\").length;\n      }\n\n      var hasMultipleImages = mediaItemCount > 1;\n\n      if (!hasMultipleImages) {\n        // Show single image or fallback\n        $(\".t4s-product__media-wrapper .slider_sec_main\")\n          .show()\n          .css(\"opacity\", \"1\");\n        if (data_var_img) {\n          $(\".slider_sec_main\").html(\"<img src='\" + data_var_img + \"' />\");\n        }\n        $(\".slick_gallery\").hide();\n      } else {\n        // Show gallery with multiple images\n        $(\".slick_gallery\").css(\"opacity\", \"0\");\n        $(\".t4s-product__media-wrapper .slider_sec_main\").hide();\n        $(\".slick_gallery\").show();\n        $(\n          \".t4s-product__media-wrapper .t4s-col-thumb .t4s-carousel__nav\",\n        ).hide();\n        $(\".t4s-product__media-wrapper .slick_gallery .slider_for\").html(\n          sel_images,\n        );\n        $(\".t4s-product__media-wrapper .slick_gallery .slider_nav\").html(\n          sel_thumb_img,\n        );\n        $(\".slick-initialized\").removeClass(\"slick-initialized\");\n        $(\".slick-slider\").removeClass(\"slick-slider\");\n        $(\".slick-vertical\").removeClass(\"slick-vertical\");\n\n        var s = document.createElement(\"script\");\n        s.type = \"text/javascript\";\n        s.src = \"https://kenwheeler.github.io/slick/slick/slick.js\";\n        $(\"head\").append(s);\n\n        setTimeout(function () {\n          $(\".slick_gallery .slider_for\").slick({\n            slidesToShow: 1,\n            slidesToScroll: 1,\n            arrows: true,\n            fade: true,\n            adaptiveHeight: true,\n            asNavFor: \".slider_nav\",\n          });\n          $(\".slick_gallery .slider_nav\").slick({\n            slidesToShow: 7,\n            slidesToScroll: 1,\n            vertical: true,\n            asNavFor: \".slider_for\",\n            dots: false,\n            adaptiveHeight: true,\n            focusOnSelect: true,\n            verticalSwiping: true,\n            responsive: [\n              {\n                breakpoint: 1400,\n                settings: {\n                  slidesToShow: 5,\n                  slidesToScroll: 1,\n                },\n              },\n              {\n                breakpoint: 767,\n                settings: {\n                  verticalSwiping: false,\n                  vertical: false,\n                  slidesToShow: 4,\n                  slidesToScroll: 1,\n                },\n              },\n              {\n                breakpoint: 480,\n                settings: {\n                  verticalSwiping: false,\n                  vertical: false,\n                  slidesToShow: 4,\n                  slidesToScroll: 1,\n                },\n              },\n            ],\n          });\n\n          $(\".slick_gallery\").css(\"opacity\", \"1\");\n        }, 100);\n      }\n    }, 100);\n  }\n\n  // Initialize swatch override immediately\n  setupSwatchOverride();\n\n  const root = document.querySelector(\".t4s-product-form__variants\");\n  if (!root) return;\n\n  const selectEl = root.querySelector('select[name=\"id\"]');\n  const variantsJsonEl = root.querySelector(\"script.pr_variants_json\");\n  const optionsJsonEl = root.querySelector(\"script.pr_options_json\");\n\n  if (!selectEl || !variantsJsonEl || !optionsJsonEl) {\n    console.warn(\"[PFD] Missing required elements\");\n    return;\n  }\n\n  const normName = (s) =>\n    String(s ?? \"\")\n      .trim()\n      .toLowerCase();\n  const normVal = (s) => String(s ?? \"\").trim();\n  const keyFromValues = (values) => values.map(normVal).join(\"||\");\n\n  // Helper function to get display value (only strips quotes for display purposes)\n  const getDisplayValue = (rawValue, optionUnit = \"\") => {\n    const cleanedValue = rawValue.replace(/\"/g, \"\");\n    return optionUnit ? `${cleanedValue} ${optionUnit}` : cleanedValue;\n  };\n\n  const getSwatchOptions = () => [\n    ...root.querySelectorAll(\"[data-swatch-option]\"),\n  ];\n\n  const getSwatchItems = (optionIndex) => {\n    const optEl = getSwatchOptions().find(\n      (el) => Number(el.getAttribute(\"data-id\")) === optionIndex,\n    );\n    if (!optEl) return { optEl: null, items: [] };\n    return {\n      optEl,\n      items: [...optEl.querySelectorAll(\"[data-swatch-item]\")],\n    };\n  };\n\n  // ----- parse bootstrap -----\n  let initialVariants = [];\n  let options = [];\n\n  try {\n    initialVariants = JSON.parse(variantsJsonEl.textContent || \"[]\");\n  } catch (e) {\n    console.warn(\"[PFD] Bad pr_variants_json\", e);\n  }\n\n  try {\n    options = JSON.parse(optionsJsonEl.textContent || \"[]\");\n  } catch (e) {\n    console.warn(\"[PFD] Bad pr_options_json\", e);\n  }\n\n  const optionCount = Math.max(1, options.length || 0);\n\n  // ----- state -----\n  // Build maps from BOTH theme JSON and Storefront hydration (same shape)\n  const variantById = new Map(); // id -> {id, available, option1..N}\n  const idByKey = new Map(); // \"v1||v2||v3\" -> id\n  const selectedValues = Array(optionCount).fill(\"\");\n\n  // Initialize theme variant array reference\n  if (!window.__PFD_VARIANTS__) {\n    window.__PFD_VARIANTS__ = [];\n  }\n\n  // Keep debug available and expose select element\n  window.__PFD = { variantById, idByKey, selectedValues, options, selectEl };\n\n  function resolveVariantFromValues(selectedValues) {\n    if (!idByKey || !selectedValues) return null;\n    return idByKey.get(keyFromValues(selectedValues));\n  }\n\n  function upsertVariant(v) {\n    const id = String(v.id);\n    variantById.set(id, v);\n    if (id === \"51236621975869\") {\n      console.log(\"HERE\", variantById.get(id));\n    }\n\n    const values = [];\n    for (let i = 0; i < optionCount; i++)\n      values.push(v[`option${i + 1}`] ?? \"\");\n    idByKey.set(keyFromValues(values), id);\n\n    // Update theme's variant array\n    updateThemeVariantArray(v, v._productRequiresSellingPlan);\n  }\n\n  // Function to build theme-compatible variant object\n  function buildThemeVariant(rawVariant, productRequiresSellingPlan = false) {\n    // If variant already has full theme data, preserve it and just add PFD fields\n    if (rawVariant.title && rawVariant.name && rawVariant.public_title) {\n      return {\n        ...rawVariant, // Preserve all existing theme fields\n        // Ensure PFD-specific fields are included\n        imageUrl: rawVariant.imageUrl,\n        variantImages: rawVariant.variantImages || [],\n      };\n    }\n\n    // For variants that need theme format building\n    const optionValues = [\n      rawVariant.option1,\n      rawVariant.option2,\n      rawVariant.option3,\n    ].filter(Boolean);\n    const titleFromOptions = optionValues.join(\" / \");\n\n    return {\n      id: Number(rawVariant.id),\n      title: rawVariant.title || titleFromOptions,\n      option1: rawVariant.option1 || null,\n      option2: rawVariant.option2 || null,\n      option3: rawVariant.option3 || null,\n      sku: rawVariant.sku || null,\n      requires_shipping: rawVariant.requires_shipping !== false,\n      taxable: rawVariant.taxable !== false,\n      featured_image:\n        rawVariant.featured_image ||\n        (rawVariant.imageUrl ? { src: rawVariant.imageUrl } : null),\n      available: rawVariant.available,\n      name: rawVariant.name || rawVariant.title || titleFromOptions,\n      public_title: rawVariant.public_title || titleFromOptions,\n      options: rawVariant.options || optionValues,\n      price: rawVariant.price || 0,\n      weight: rawVariant.weight || 0,\n      compare_at_price: rawVariant.compare_at_price || null,\n      inventory_management: rawVariant.inventory_management || \"shopify\",\n      barcode: rawVariant.barcode || \"\",\n      featured_media: rawVariant.featured_media || null,\n      requires_selling_plan:\n        rawVariant.requires_selling_plan !== undefined\n          ? rawVariant.requires_selling_plan\n          : productRequiresSellingPlan,\n      selling_plan_allocations: rawVariant.selling_plan_allocations || [],\n      quantity_rule: rawVariant.quantity_rule || {\n        min: 1,\n        max: null,\n        increment: 1,\n      },\n      incoming: rawVariant.incoming || false,\n      next_incoming_date: rawVariant.next_incoming_date || null,\n      inventory_policy: rawVariant.inventory_policy || null,\n      inventory_quantity: rawVariant.inventory_quantity || 0,\n      // Preserve PFD-specific data\n      imageUrl: rawVariant.imageUrl,\n      variantImages: rawVariant.variantImages || [],\n    };\n  }\n\n  // Function to populate theme's variant array with variant data\n  function updateThemeVariantArray(\n    variant,\n    productRequiresSellingPlan = false,\n  ) {\n    if (!window.__PFD_VARIANTS__) {\n      window.__PFD_VARIANTS__ = [];\n    }\n\n    const existingIndex = window.__PFD_VARIANTS__.findIndex(\n      (v) => String(v.id) === String(variant.id),\n    );\n\n    const themeVariant = buildThemeVariant(variant, productRequiresSellingPlan);\n\n    if (existingIndex >= 0) {\n      // Update existing variant\n      window.__PFD_VARIANTS__[existingIndex] = themeVariant;\n    } else {\n      // Add new variant\n      window.__PFD_VARIANTS__.push(themeVariant);\n    }\n  }\n\n  for (const v of initialVariants) {\n    // Extract image URL from variant data\n    let imageUrl = null;\n    if (v.featured_image && v.featured_image.src) {\n      imageUrl = v.featured_image.src;\n    } else if (\n      v.featured_media &&\n      v.featured_media.preview_image &&\n      v.featured_media.preview_image.src\n    ) {\n      imageUrl = v.featured_media.preview_image.src;\n    }\n\n    // Preserve all existing theme variant data and add PFD-specific fields\n    upsertVariant({\n      ...v,\n      available: !!v.available,\n      imageUrl: imageUrl,\n      variantImages: imageUrl ? [imageUrl] : [],\n    });\n  }\n\n  function getSelectedFromDOM() {\n    const values = Array(optionCount).fill(\"\");\n    for (const optEl of getSwatchOptions()) {\n      const idx = Number(optEl.getAttribute(\"data-id\"));\n      if (Number.isNaN(idx)) continue;\n\n      const selectedItem = optEl.querySelector(\n        \"[data-swatch-item].is--selected\",\n      );\n      if (selectedItem)\n        values[idx] = normVal(selectedItem.getAttribute(\"data-value\") || \"\");\n    }\n    return values;\n  }\n\n  function resolveVariantId(values) {\n    return idByKey.get(keyFromValues(values));\n  }\n\n  // IMPORTANT: do NOT dispatch change unless variant truly changed\n  let lastAppliedVariantId = null;\n  function applyVariantToSelect(variantId) {\n    if (!variantId) return;\n    const nextId = String(variantId);\n    if (lastAppliedVariantId === nextId) return;\n\n    lastAppliedVariantId = nextId;\n    selectEl.value = nextId;\n\n    // Ensure DOM exists for this variant before theme processes it\n    ensureDOMForVariant(nextId);\n\n    // Let theme update its own UI\n    selectEl.dispatchEvent(new Event(\"change\", { bubbles: true }));\n  }\n\n  // Progressive prefix matching for availability\n  function variantMatchesPrefix(v, optionIndex) {\n    for (let i = 0; i < optionIndex; i++) {\n      const sel = normVal(selectedValues[i]);\n      if (!sel) continue;\n      if (normVal(v[`option${i + 1}`] ?? \"\") !== sel) return false;\n    }\n    return true;\n  }\n\n  // Visual \"sold out marker\" handling:\n  // We only toggle the visual class but keep items clickable\nfunction setSoldOut(el, isSoldOut) {\n  el.classList.toggle(\"is--soldout\", isSoldOut);\n  el.classList.toggle(\"is--out-of-stock\", isSoldOut);\n\n  // Find the correct parent for the badge (image container if exists)\n  const imgContainer = el.querySelector(\"[data-img-el]\");\n  const badgeParent = imgContainer || el;\n\n  if (isSoldOut) {\n    el.setAttribute(\"aria-disabled\", \"true\");\n    el.dataset.available = \"false\";\n\n    // Create badge if doesn't exist\n    let badge = badgeParent.querySelector(\".t4s-swatch__restock-badge\");\n    if (!badge) {\n      badge = document.createElement(\"span\");\n      badge.className = \"t4s-swatch__restock-badge\";\n      badge.textContent = \"Awaiting Restock\";\n      badgeParent.appendChild(badge);\n    }\n    // Class-based visibility (works with CSS !important)\n    badge.classList.add(\"is-visible\");\n\n    // Always run luminance detection — covers both newly-created badges and\n    // SSR-rendered badges whose image src may have just been updated by\n    // updateSwatchImages() after hydration.\n    if (imgContainer) {\n      detectSwatchLuminance(imgContainer, badge);\n    }\n\n    // Compute and show available standard lengths for this color\n    updateAvailableLengths(el, badgeParent, imgContainer);\n  } else {\n    el.removeAttribute(\"aria-disabled\");\n    el.dataset.available = \"true\";\n\n    // Find and hide badge\n    const badge = badgeParent.querySelector(\".t4s-swatch__restock-badge\");\n    if (badge) {\n      badge.classList.remove(\"is-visible\");\n    }\n    // Hide available lengths — el IS the .t4s-swatch__btn-wrap\n    const lengthsEl = el.querySelector(\":scope > .t4s-swatch__available-lengths\");\n    if (lengthsEl) {\n      lengthsEl.classList.remove(\"is-visible\");\n    }\n    el.classList.remove(\"pfd-has-lengths\");\n\n  }\n}\n\nfunction updateAvailableLengths(swatchEl, badgeParent, imgContainer) {\n  const customNames = window.__CUSTOM_OPTION_NAMES__ || [];\n  // Prefer the explicit length option index injected by Liquid.\n  // Falls back to scanning all non-color options if not set.\n  const explicitLengthIdx = typeof window.__LENGTH_OPTION_INDEX__ === \"number\"\n    ? window.__LENGTH_OPTION_INDEX__\n    : -1;\n\n  // Find which option index is the color option\n  let colorOptIdx = -1;\n  for (let i = 0; i < optionCount; i++) {\n    if (isColorOption(i)) {\n      colorOptIdx = i;\n      break;\n    }\n  }\n  if (colorOptIdx < 0) return;\n\n  // Get the color value from this swatch element\n  const colorValue = normVal(swatchEl.getAttribute(\"data-value\") || \"\");\n  if (!colorValue) return;\n\n  // Determine which option indices to report as \"available lengths\".\n  // If a specific length index was injected (option1 in most cases), use only that.\n  // Otherwise fall back to all non-color indices.\n  let targetIndices;\n  if (explicitLengthIdx >= 0 && explicitLengthIdx !== colorOptIdx) {\n    targetIndices = [explicitLengthIdx];\n  } else {\n    targetIndices = [];\n    for (let i = 0; i < optionCount; i++) {\n      if (i !== colorOptIdx) targetIndices.push(i);\n    }\n  }\n  if (targetIndices.length === 0) return;\n\n  // Check if this color IS available at the current non-color selections.\n  // If so, there's nothing to report — hide any existing text and bail.\n  const nonColorIndices = [];\n  for (let i = 0; i < optionCount; i++) {\n    if (i !== colorOptIdx) nonColorIndices.push(i);\n  }\n  const currentSelections = nonColorIndices.map((idx) =>\n    normVal(selectedValues[idx] || \"\")\n  );\n\n  const availableAtCurrentSelections = [...variantById.values()].some((v) => {\n    if (!v || !v.available) return false;\n    const vColor = normVal(v[`option${colorOptIdx + 1}`] || \"\");\n    if (vColor !== colorValue) return false;\n    return nonColorIndices.every((idx, i) => {\n      const sel = currentSelections[i];\n      if (!sel) return true;\n      return normVal(v[`option${idx + 1}`] || \"\") === sel;\n    });\n  });\n\n  if (availableAtCurrentSelections) {\n    // swatchEl IS the .t4s-swatch__btn-wrap — lengths span lives as its direct child\n    const existingEl = swatchEl.querySelector(\":scope > .t4s-swatch__available-lengths\");\n    if (existingEl) existingEl.classList.remove(\"is-visible\");\n    swatchEl.classList.remove(\"pfd-has-lengths\");\n    return;\n  }\n\n  // Collect available values for the target (length) option indices,\n  // filtered to this color and excluding custom option values from the\n  // product metafield `custom.custom_values`.\n  const availableByOption = targetIndices.map((idx) => {\n    const seen = new Set();\n    const values = [];\n\n    for (const v of variantById.values()) {\n      if (!v || !v.available) continue;\n      const vColor = normVal(v[`option${colorOptIdx + 1}`] || \"\");\n      if (vColor !== colorValue) continue;\n\n      const rawVal = v[`option${idx + 1}`] || \"\";\n      if (!rawVal) continue;\n\n      // Exclude values that are in the custom_values metafield list\n      const isCustom = customNames.some(\n        (cn) => String(cn).trim() === String(rawVal).trim()\n      );\n      if (isCustom) continue;\n\n      const cleanVal = String(rawVal).replace(/\"/g, \"\");\n\n      if (!seen.has(cleanVal)) {\n        seen.add(cleanVal);\n        values.push(cleanVal);\n      }\n    }\n\n    return { idx, values };\n  });\n\n  // Build display text\n  const parts = [];\n  for (const { idx, values } of availableByOption) {\n    if (values.length === 0) continue;\n    if (targetIndices.length === 1) {\n      parts.push(values.join(\", \"));\n    } else {\n      const optName = (options?.[idx]?.name || \"\").replace(/\"/g, \"\");\n      parts.push(optName ? `${optName}: ${values.join(\", \")}` : values.join(\", \"));\n    }\n  }\n  // The lengths element lives as a direct child of .t4s-swatch__btn-wrap\n  // swatchEl IS the .t4s-swatch__btn-wrap (data-swatch-item is on the btn-wrap div)\n  let lengthsEl = swatchEl.querySelector(\":scope > .t4s-swatch__available-lengths\");\n\n  if (parts.length > 0) {\n    if (!lengthsEl) {\n      lengthsEl = document.createElement(\"span\");\n      lengthsEl.className = \"t4s-swatch__available-lengths\";\n      // Insert after the image container ([data-img-el]) so the order matches\n      // the Liquid-rendered DOM: image → lengths → label → nickname.\n      // Fall back to appendChild if no image container exists.\n      const imgEl = swatchEl.querySelector(\":scope > [data-img-el]\");\n      if (imgEl && imgEl.nextSibling) {\n        swatchEl.insertBefore(lengthsEl, imgEl.nextSibling);\n      } else {\n        swatchEl.appendChild(lengthsEl);\n      }\n    }\n    lengthsEl.textContent = \"Available in \" + parts.join(\", \");\n    lengthsEl.classList.add(\"is-visible\");\n    swatchEl.classList.add(\"pfd-has-lengths\");\n\n  } else {\n    if (lengthsEl) lengthsEl.classList.remove(\"is-visible\");\n    swatchEl.classList.remove(\"pfd-has-lengths\");\n  }\n}\n\n// Luminance detection for content-aware badge contrast\nconst luminanceCache = new Map();\n\nfunction detectSwatchLuminance(imgContainer, badge) {\n  const img = imgContainer.querySelector(\"img\");\n  // The btn-wrap parent needs the attribute so the CSS cascade reaches\n  // the sibling .t4s-swatch__available-lengths element\n  const btnWrap = imgContainer.closest(\".t4s-swatch__btn-wrap\");\n\n  const applyLuminance = (result) => {\n    imgContainer.setAttribute(\"data-luminance\", result);\n    if (btnWrap) btnWrap.setAttribute(\"data-luminance\", result);\n  };\n\n  if (!img || !img.src || img.src === \"\" || img.src === \"null\") {\n    applyLuminance(\"dark\");\n    return;\n  }\n\n  // Check cache first\n  if (luminanceCache.has(img.src)) {\n    const cached = luminanceCache.get(img.src);\n    applyLuminance(cached);\n    return;\n  }\n\n  // Wait for image to load if needed\n  const analyze = () => {\n    try {\n      const canvas = document.createElement(\"canvas\");\n      const ctx = canvas.getContext(\"2d\");\n      canvas.width = 20;\n      canvas.height = 20;\n\n      ctx.drawImage(img, 0, 0, 20, 20);\n      const imageData = ctx.getImageData(0, 0, 20, 20).data;\n\n      let totalLuminance = 0;\n      const pixelCount = imageData.length / 4;\n\n      for (let i = 0; i < imageData.length; i += 4) {\n        // Perceived luminance formula: 0.299R + 0.587G + 0.114B\n        const luminance = 0.299 * imageData[i] + 0.587 * imageData[i + 1] + 0.114 * imageData[i + 2];\n        totalLuminance += luminance;\n      }\n\n      const avgLuminance = totalLuminance / pixelCount;\n      const result = avgLuminance > 128 ? \"light\" : \"dark\";\n\n      luminanceCache.set(img.src, result);\n      applyLuminance(result);\n    } catch (e) {\n      console.error(\"[Luminance] Error analyzing image:\", e.message, \"| Image:\", img.src);\n      applyLuminance(\"dark\");\n    }\n  };\n\n  if (img.complete && img.naturalWidth > 0) {\n    analyze();\n  } else {\n    img.addEventListener(\"load\", analyze, { once: true });\n    img.addEventListener(\"error\", () => {\n      applyLuminance(\"dark\");\n    }, { once: true });\n  }\n}\n\n// Check if an option is a Color option based on the option name.\n// Matches the full get_color set injected by Liquid as window.__COLOR_OPTION_NAMES__,\n// which includes \"color\", \"colors\", \"colour\", \"couleur\" plus any store-level additions.\nfunction isColorOption(optionIndex) {\n  const optionName = normName(options?.[optionIndex]?.name || \"\");\n  const colorNames = window.__COLOR_OPTION_NAMES__ || [\"color\", \"colours\", \"couleur\", \"colour\", \"colors\"];\n  return colorNames.some((n) => normName(n) === optionName);\n}\n\n// Find variant matching current selections + given color value\nfunction getVariantForColorValue(colorValue, currentSelection, colorIndex) {\n  for (const v of variantById.values()) {\n    if (!v) continue;\n\n    const variantColorVal = normVal(v[`option${colorIndex + 1}`] || \"\");\n    if (variantColorVal !== colorValue) continue;\n\n    let matches = true;\n    for (let i = 0; i < optionCount; i++) {\n      if (i === colorIndex) continue;\n      const selectedVal = normVal(currentSelection[i] || \"\");\n      const variantVal = normVal(v[`option${i + 1}`] || \"\");\n      if (selectedVal && selectedVal !== variantVal) {\n        matches = false;\n        break;\n      }\n    }\n\n    if (matches) return v;\n  }\n  return null;\n}\n\nfunction patchAvailabilityForOption(optionIndex) {\n  const { items } = getSwatchItems(optionIndex);\n  if (!items.length) return;\n\n  const availableByValue = new Map();\n  const isColor = isColorOption(optionIndex);\n\n  // Use selectedValues array directly instead of reading from DOM\n  // This ensures we have the most up-to-date selection state\n  // (especially important after click handlers update selectedValues)\n  const currentSelection = [...selectedValues];\n\n  if (isColor) {\n    // For Color options: only show sold-out if the specific combination is sold out\n\n    for (const v of variantById.values()) {\n      if (!v || !v.available) continue;\n\n      // Check if variant matches all currently selected options\n      let matches = true;\n      for (let i = 0; i < optionCount; i++) {\n        // Ignore the current option being evaluated\n        if (i === optionIndex) continue;\n\n        const selectedVal = normVal(currentSelection[i] || \"\");\n        const variantVal = normVal(v[`option${i + 1}`] || \"\");\n\n        if (selectedVal && selectedVal !== variantVal) {\n          matches = false;\n          break;\n        }\n      }\n\n      if (!matches) continue;\n\n      const val = normVal(v[`option${optionIndex + 1}`] ?? \"\");\n      if (val) availableByValue.set(val, true);\n    }\n\n    // Check if we have any variants for this option with current selections\n    const hasAnyVariantsForOption = [...variantById.values()].some((v) => {\n      if (!v) return false;\n\n      let matches = true;\n      for (let i = 0; i < optionIndex; i++) {\n        const selectedVal = normVal(currentSelection[i] || \"\");\n        const variantVal = normVal(v[`option${i + 1}`] || \"\");\n        if (selectedVal && selectedVal !== variantVal) {\n          matches = false;\n          break;\n        }\n      }\n\n      if (!matches) return false;\n      const val = normVal(v[`option${optionIndex + 1}`] ?? \"\");\n      return !!val;\n    });\n\n    if (!hasAnyVariantsForOption) {\n      for (const item of items) setSoldOut(item, false);\n      return;\n    }\n  } else {\n    // For non-Color options: only show sold-out if ALL variants with that value are sold out\n    for (const v of variantById.values()) {\n      if (!v || !v.available) continue;\n\n      const val = normVal(v[`option${optionIndex + 1}`] ?? \"\");\n      if (val) availableByValue.set(val, true);\n    }\n\n    // Check if we have any variants for this option at all\n    const hasAnyVariantsForOption = [...variantById.values()].some((v) => {\n      if (!v) return false;\n      const val = normVal(v[`option${optionIndex + 1}`] ?? \"\");\n      return !!val;\n    });\n\n    if (!hasAnyVariantsForOption) {\n      for (const item of items) setSoldOut(item, false);\n      return;\n    }\n  }\n\n  let availableCount = 0;\n  let soldOutCount = 0;\n\n  for (const item of items) {\n    const val = normVal(item.getAttribute(\"data-value\") || \"\");\n    const isAvailable = availableByValue.get(val) === true;\n\n    if (isColor && !isAvailable && hasCustomOptionSelected(currentSelection)) {\n      // Check if variant is truly unavailable (not just out of stock)\n      const variant = getVariantForColorValue(val, currentSelection, optionIndex);\n      if (variant && variant.inventory_quantity <= 0 && !variant.available) {\n        // Hide completely for custom options\n        item.classList.add('pfd-hidden-custom');\n        item.style.display = 'none';\n        continue;\n      }\n    }\n\n    // Show the swatch (remove hidden state if previously hidden)\n    item.classList.remove('pfd-hidden-custom');\n    item.style.display = '';\n\n    setSoldOut(item, !isAvailable);\n\n    if (isAvailable) {\n      availableCount++;\n    } else {\n      soldOutCount++;\n    }\n  }\n}\n\n  function patchAllAvailability() {\n    // Sync selectedValues with current DOM state before patching availability\n    const domSelected = getSelectedFromDOM();\n    for (let i = 0; i < optionCount; i++) {\n      selectedValues[i] = domSelected[i];\n    }\n\n    for (let i = 0; i < optionCount; i++) patchAvailabilityForOption(i);\n  }\n\n  function updateSwatchImages() {\n    // Update swatch items with variant image data\n    const swatchItems = root.querySelectorAll(\"[data-swatch-item]\");\n\n    for (const item of swatchItems) {\n      const optionEl = item.closest(\"[data-swatch-option]\");\n      if (!optionEl) continue;\n\n      const optionIndex = Number(optionEl.getAttribute(\"data-id\"));\n      const itemValue = normVal(item.getAttribute(\"data-value\") || \"\");\n\n      if (Number.isNaN(optionIndex) || !itemValue) continue;\n\n      // Find variants that match this option value at this position\n      const matchingVariants = [...variantById.values()].filter((v) => {\n        const variantValue = normVal(v[`option${optionIndex + 1}`] || \"\");\n        return variantValue === itemValue;\n      });\n\n      // Use the first matching variant's image (prioritizing available variants)\n      const preferredVariant =\n        matchingVariants.find((v) => v.available && v.imageUrl) ||\n        matchingVariants.find((v) => v.imageUrl);\n\n      const imgEl =\n        item.querySelector(\"[data-img-el] img\") || item.querySelector(\"img\");\n      if (imgEl) {\n        if (preferredVariant && preferredVariant.imageUrl) {\n          item.setAttribute(\"data-var-img\", preferredVariant.imageUrl);\n          setupSwatchImageLoad(imgEl, preferredVariant.imageUrl, item);\n        } else {\n          // No image available, show placeholder\n          item.classList.add(\"swatch-placeholder\");\n          imgEl.src = \"\";\n        }\n      }\n    }\n  }\n\n  function setupSwatchImageLoad(imgEl, imageUrl, swatchItem) {\n    // Add loading state\n    swatchItem.classList.add(\"swatch-loading\");\n    swatchItem.classList.remove(\n      \"swatch-loaded\",\n      \"swatch-error\",\n      \"swatch-placeholder\",\n    );\n\n    // Handle load success\n    imgEl.onload = function () {\n      swatchItem.classList.remove(\"swatch-loading\", \"swatch-placeholder\");\n      swatchItem.classList.add(\"swatch-loaded\");\n    };\n\n    // Handle load error\n    imgEl.onerror = function () {\n      swatchItem.classList.remove(\"swatch-loading\");\n      swatchItem.classList.add(\"swatch-error\", \"swatch-placeholder\");\n      imgEl.src = \"\";\n    };\n\n    // Set the image source to trigger loading\n    imgEl.src = imageUrl;\n  }\n\n  function updateVariantImages() {\n    // Hide any legacy variant image containers to ensure only our implementation is used\n    const legacyContainers = root.querySelectorAll(\".varin_imgaes\");\n    legacyContainers.forEach((container) => {\n      container.style.display = \"none !important\";\n    });\n\n    // Update the .pfd-variant-images sections with correct variant image data\n    const varinImagesEl = root.querySelector(\".pfd-variant-images\");\n    if (!varinImagesEl) return;\n\n    const mainImgsEl = varinImagesEl.querySelector(\".pfd-main-imgs\");\n    const thumbImgsEl = varinImagesEl.querySelector(\".pfd-thumb-imgs\");\n\n    let createdCount = 0;\n    let updatedCount = 0;\n\n    // Process all variants in our map\n    for (const [variantId, variant] of variantById.entries()) {\n      if (!variant) continue;\n\n      // Handle main images\n      if (mainImgsEl) {\n        let mainListing = mainImgsEl.querySelector(\n          `.pfd-img-listing[data-pfd-variant-id=\"${variantId}\"]`,\n        );\n\n        // Create main listing if it doesn't exist\n        if (!mainListing) {\n          mainListing = document.createElement(\"div\");\n          mainListing.className = \"pfd-img-listing\";\n          mainListing.setAttribute(\"data-pfd-variant-id\", variantId);\n          mainListing.setAttribute(\"data-var-img\", variant.imageUrl || \"\");\n          mainImgsEl.appendChild(mainListing);\n          createdCount++;\n\n          // Populate with images only when creating new\n          const imagesToUse =\n            variant.variantImages && variant.variantImages.length > 0\n              ? variant.variantImages\n              : variant.imageUrl\n                ? [variant.imageUrl]\n                : [];\n\n          for (const imageUrl of imagesToUse) {\n            const mediaItem = document.createElement(\"div\");\n            mediaItem.className = \"pfd-media-item\";\n            const img = document.createElement(\"img\");\n            img.src = imageUrl;\n            mediaItem.appendChild(img);\n            mainListing.appendChild(mediaItem);\n          }\n        } else {\n          // Update existing DOM element with hydrated image data\n          updatedCount++;\n\n          // Clear existing content and repopulate with hydrated data\n          mainListing.innerHTML = \"\";\n          mainListing.setAttribute(\"data-var-img\", variant.imageUrl || \"\");\n\n          const imagesToUse =\n            variant.variantImages && variant.variantImages.length > 0\n              ? variant.variantImages\n              : variant.imageUrl\n                ? [variant.imageUrl]\n                : [];\n\n          for (const imageUrl of imagesToUse) {\n            const mediaItem = document.createElement(\"div\");\n            mediaItem.className = \"pfd-media-item\";\n            const img = document.createElement(\"img\");\n            img.src = imageUrl;\n            mediaItem.appendChild(img);\n            mainListing.appendChild(mediaItem);\n          }\n        }\n      }\n\n      // Handle thumbnail images\n      if (thumbImgsEl) {\n        let thumbListing = thumbImgsEl.querySelector(\n          `.pfd-img-listing[data-pfd-variant-id=\"${variantId}\"]`,\n        );\n\n        // Create thumb listing if it doesn't exist (for hydrated variants)\n        if (!thumbListing) {\n          thumbListing = document.createElement(\"div\");\n          thumbListing.className = \"pfd-img-listing\";\n          thumbListing.setAttribute(\"data-pfd-variant-id\", variantId);\n          thumbImgsEl.appendChild(thumbListing);\n\n          // Populate with thumbnails only when creating new\n          const imagesToUse =\n            variant.variantImages && variant.variantImages.length > 0\n              ? variant.variantImages\n              : variant.imageUrl\n                ? [variant.imageUrl]\n                : [];\n\n          for (const imageUrl of imagesToUse) {\n            const mediaThumb = document.createElement(\"div\");\n            mediaThumb.className = \"pfd-media-thumb\";\n            const imgDiv = document.createElement(\"div\");\n            imgDiv.className = \"pfd-img\";\n            imgDiv.style.backgroundImage = `url('${imageUrl}')`;\n            mediaThumb.appendChild(imgDiv);\n            thumbListing.appendChild(mediaThumb);\n          }\n        } else {\n          // Update existing thumb DOM element with hydrated image data\n\n          // Clear existing content and repopulate with hydrated data\n          thumbListing.innerHTML = \"\";\n\n          const imagesToUse =\n            variant.variantImages && variant.variantImages.length > 0\n              ? variant.variantImages\n              : variant.imageUrl\n                ? [variant.imageUrl]\n                : [];\n\n          for (const imageUrl of imagesToUse) {\n            const mediaThumb = document.createElement(\"div\");\n            mediaThumb.className = \"pfd-media-thumb\";\n            const imgDiv = document.createElement(\"div\");\n            imgDiv.className = \"pfd-img\";\n            imgDiv.style.backgroundImage = `url('${imageUrl}')`;\n            mediaThumb.appendChild(imgDiv);\n            thumbListing.appendChild(mediaThumb);\n          }\n        }\n      }\n    }\n  }\n\n  // Listen for variant changes to ensure DOM is updated\n  function ensureDOMForVariant(variantId) {\n    const variant = variantById.get(variantId);\n    if (!variant || !variant.variantImages) return;\n\n    const varinImagesEl = root.querySelector(\".pfd-variant-images\");\n    if (!varinImagesEl) return;\n\n    const mainImgsEl = varinImagesEl.querySelector(\".pfd-main-imgs\");\n    const thumbImgsEl = varinImagesEl.querySelector(\".pfd-thumb-imgs\");\n\n    // Ensure main listing exists\n    if (mainImgsEl) {\n      let mainListing = mainImgsEl.querySelector(\n        `.pfd-img-listing[data-pfd-variant-id=\"${variantId}\"]`,\n      );\n\n      if (!mainListing) {\n        mainListing = document.createElement(\"div\");\n        mainListing.className = \"pfd-img-listing\";\n        mainListing.setAttribute(\"data-pfd-variant-id\", variantId);\n        mainListing.setAttribute(\"data-var-img\", variant.imageUrl || \"\");\n        mainImgsEl.appendChild(mainListing);\n\n        // Populate with images\n        for (const imageUrl of variant.variantImages) {\n          const mediaItem = document.createElement(\"div\");\n          mediaItem.className = \"pfd-media-item\";\n          const img = document.createElement(\"img\");\n          img.src = imageUrl;\n          mediaItem.appendChild(img);\n          mainListing.appendChild(mediaItem);\n        }\n      }\n    }\n\n    // Ensure thumb listing exists\n    if (thumbImgsEl) {\n      let thumbListing = thumbImgsEl.querySelector(\n        `.pfd-img-listing[data-pfd-variant-id=\"${variantId}\"]`,\n      );\n\n      if (!thumbListing) {\n        thumbListing = document.createElement(\"div\");\n        thumbListing.className = \"pfd-img-listing\";\n        thumbListing.setAttribute(\"data-pfd-variant-id\", variantId);\n        thumbImgsEl.appendChild(thumbListing);\n\n        // Populate with thumbnails\n        for (const imageUrl of variant.variantImages) {\n          const mediaThumb = document.createElement(\"div\");\n          mediaThumb.className = \"pfd-media-thumb\";\n          const imgDiv = document.createElement(\"div\");\n          imgDiv.className = \"pfd-img\";\n          imgDiv.style.backgroundImage = `url('${imageUrl}')`;\n          mediaThumb.appendChild(imgDiv);\n          thumbListing.appendChild(mediaThumb);\n        }\n      }\n    }\n  }\n\n  // Ensure select option exists for hydrated variants\n  function ensureSelectOption(variantId, variant) {\n    if (selectEl.querySelector(`option[value=\"${variantId}\"]`)) return;\n\n    const option = document.createElement(\"option\");\n    option.value = variantId;\n    option.setAttribute(\"data-option1\", variant.option1 || \"\");\n    option.setAttribute(\"data-option2\", variant.option2 || \"\");\n\n    const optionValues = [\n      variant.option1,\n      variant.option2,\n      variant.option3,\n    ].filter(Boolean);\n    option.textContent = optionValues.join(\" / \");\n\n    if (!variant.available) option.disabled = true;\n\n    selectEl.appendChild(option);\n  }\n\n  // ---------- PFD Click handling (backup for our override) ----------\n  function handlePFDSwatchClick(item) {\n    const optEl = item.closest(\"[data-swatch-option]\");\n    if (!optEl) return;\n\n    const optionIndex = Number(optEl.getAttribute(\"data-id\"));\n    if (Number.isNaN(optionIndex)) return;\n\n    // preserve current selections (prevents \"reset to 14\")\n    const domSelected = getSelectedFromDOM();\n    for (let i = 0; i < optionCount; i++) {\n      if (!selectedValues[i] && domSelected[i])\n        selectedValues[i] = domSelected[i];\n    }\n\n    const value = normVal(item.getAttribute(\"data-value\") || \"\");\n    selectedValues[optionIndex] = value;\n\n    // Handle split selection - clear selections from both standard and custom areas\n    if (optEl.classList.contains(\"pfd-split-option\")) {\n      optEl\n        .querySelectorAll(\"[data-swatch-item].is--selected\")\n        .forEach((el) => el.classList?.remove(\"is--selected\"));\n\n      // Check if this swatch item is from the custom options area\n      const isFromCustomDropdown = item.closest(\".pfd-custom-options\");\n\n      if (!isFromCustomDropdown) {\n        // Reset custom dropdown to default state when selecting standard option\n        const customDropdown = optEl.querySelector(\n          \".pfd-custom-dropdown [data-current-value]\",\n        );\n        if (customDropdown) {\n          const optionName = optEl.getAttribute(\"data-option-name\") || \"\";\n          customDropdown.textContent = `Custom ${optionName.toLowerCase()}`;\n        }\n\n        // Hide custom notice when standard option is selected\n        const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n        if (customNotice) {\n          customNotice.style.display = \"none\";\n        }\n      }\n    } else {\n      // Standard handling for non-split options\n      optEl\n        .querySelectorAll(\"[data-swatch-item].is--selected\")\n        .forEach((el) => el.classList?.remove(\"is--selected\"));\n    }\n\n    item.classList.add(\"is--selected\");\n\n    // Update current value display - handle both Color and Non-Color structures\n    const valueFromItem = item.getAttribute(\"data-value\") || \"\";\n    const optionUnit = optEl.getAttribute(\"data-option-unit\") || \"\";\n    const displayValue = getDisplayValue(valueFromItem, optionUnit);\n\n    // Check if this is a custom option to add badge\n    const isFromCustomDropdown = item.closest(\".pfd-custom-options\");\n\n    let titleElement = optEl.querySelector(\".t4s-swatch__title--right .bold\");\n    if (titleElement) {\n      // Non-Color section structure\n      titleElement.textContent = displayValue;\n    } else {\n      // Color section structure - use the wrapper span\n      titleElement = optEl.querySelector(\".t4s-selected-value\");\n      if (titleElement) {\n        titleElement.textContent = displayValue;\n      }\n    }\n\n    // Update custom dropdown display for selected custom options\n    if (isFromCustomDropdown) {\n      const customDropdown = optEl.querySelector(\n        \".pfd-custom-dropdown [data-current-value]\",\n      );\n      if (customDropdown) {\n        customDropdown.innerHTML = `${displayValue} <span class=\"pfd-custom-badge\">Custom</span>`;\n      }\n\n      // Show custom notice and update text\n      const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n      if (customNotice) {\n        const optionName = optEl.getAttribute(\"data-option-name\") || \"item\";\n        const noticeText = customNotice.querySelector(\n          \".pfd-custom-notice-text\",\n        );\n        if (noticeText) {\n          noticeText.innerHTML = `Custom ${optionName.toLowerCase()}s are <strong>made to order</strong>. Please allow <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery. Custom orders are non-cancellable/refundable.`;\n        }\n        customNotice.style.display = \"block\";\n      }\n    } else {\n      // Hide custom notice when standard option is selected\n      const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n      if (customNotice) {\n        customNotice.style.display = \"none\";\n      }\n    }\n\n    // resolve full variant and apply to select\n    const variantId = resolveVariantId(selectedValues);\n    if (variantId) {\n      // Update HTML data attributes with correct variant info before applying variant\n      const variant = window.__PFD\n        ? window.__PFD.variantById.get(variantId)\n        : null;\n      if (variant) {\n        const selectEl = item\n          .closest(\"form, .t4s-form__product\")\n          ?.querySelector('select[name=\"id\"]');\n        const selectedOption = selectEl?.querySelector(\n          `option[value=\"${variantId}\"]`,\n        );\n        if (selectedOption) {\n          // Update HTML data attributes that the theme actually checks\n          selectedOption.setAttribute(\n            \"data-incoming\",\n            variant.incoming || \"false\",\n          );\n          selectedOption.setAttribute(\n            \"data-nextincomingdate\",\n            variant.nextIncomingDate || \"\",\n          );\n          selectedOption.setAttribute(\n            \"data-inventorypolicy\",\n            variant.inventoryPolicy || \"deny\",\n          );\n          selectedOption.setAttribute(\n            \"data-inventoryquantity\",\n            variant.inventoryQuantity || (variant.available ? \"999\" : \"0\"),\n          );\n        }\n      }\n\n      // Ensure DOM exists before applying variant\n      ensureDOMForVariant(variantId);\n      applyVariantToSelect(variantId);\n    }\n\n    // re-patch sold-out\n    patchAllAvailability();\n  }\n\n  // Make function available globally for our override\n  window.handlePFDSwatchClick = handlePFDSwatchClick;\n\n  // Setup split selection dropdown handlers\n  function setupSplitSelectionHandlers() {\n    document.addEventListener(\"click\", function (e) {\n      // Handle custom dropdown item selection\n      const dropdownItem = e.target.closest(\n        \"[data-swatch-item][data-dropdown-off]\",\n      );\n      if (dropdownItem && dropdownItem.closest(\".pfd-custom-options\")) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const value = dropdownItem.getAttribute(\"data-value\") || \"\";\n        const cleanedValue = getDisplayValue(value);\n\n        // Find the custom dropdown button\n        const dropdownWrapper = dropdownItem.closest(\".t4s-dropdown__wrapper\");\n        if (dropdownWrapper) {\n          const dropdownId = dropdownWrapper.id;\n          const customButton = document.querySelector(\n            `[data-pfd-dropdown-open][data-id=\"${dropdownId}\"]`,\n          );\n\n          if (customButton) {\n            // Update the dropdown button text to show the selected value\n            const currentValueSpan = customButton.querySelector(\n              \"[data-current-value]\",\n            );\n            if (currentValueSpan) {\n              // Get the option unit from the parent option element\n              const optionEl = dropdownItem.closest(\"[data-swatch-option]\");\n              const optionUnit = optionEl\n                ? optionEl.getAttribute(\"data-option-unit\") || \"\"\n                : \"\";\n\n              // Display the value with unit if available\n              const displayValue = optionUnit\n                ? `${cleanedValue} ${optionUnit}`\n                : cleanedValue;\n\n              currentValueSpan.innerHTML = `${displayValue} <span class=\"pfd-custom-badge\">Custom</span>`;\n            }\n\n            // Close the dropdown\n            dropdownWrapper.classList.remove(\"is-open\");\n            customButton.setAttribute(\"aria-expanded\", \"false\");\n          }\n\n          // Show custom notice for dropdown selection and update text\n          const optionEl = dropdownItem.closest(\"[data-swatch-option]\");\n          const customNotice = optionEl\n            ? optionEl.querySelector(\".pfd-custom-notice\")\n            : null;\n          if (customNotice && optionEl) {\n            const optionName =\n              optionEl.getAttribute(\"data-option-name\") || \"item\";\n            const noticeText = customNotice.querySelector(\n              \".pfd-custom-notice-text\",\n            );\n            if (noticeText) {\n              noticeText.innerHTML = `Custom ${optionName.toLowerCase()}s are <strong>made to order</strong>. Please allow <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery.`;\n            }\n            customNotice.style.display = \"block\";\n          }\n\n          // Clear all selected states from the option group (both standard and custom)\n          if (optionEl && optionEl.classList.contains(\"pfd-split-option\")) {\n            optionEl\n              .querySelectorAll(\"[data-swatch-item].is--selected\")\n              .forEach((el) => el.classList?.remove(\"is--selected\"));\n\n            // Remove active state from ALL dropdown buttons in this option group\n            optionEl\n              .querySelectorAll(\".pfd-custom-dropdown\")\n              .forEach((btn) => btn.classList?.remove(\"is--selected\"));\n          }\n\n          // Add active state to THIS dropdown button\n          if (customButton) {\n            customButton.classList.add(\"is--selected\");\n          }\n        }\n\n        // Trigger the standard swatch selection logic\n        handleCustomSwatchClick(dropdownItem, e);\n        return;\n      }\n\n      // Handle custom dropdown clicks\n      const customDropdown = e.target.closest(\"[data-pfd-dropdown-open]\");\n      if (customDropdown) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const dropdownId = customDropdown.getAttribute(\"data-id\");\n        const dropdownWrapper = document.getElementById(dropdownId);\n\n        if (dropdownWrapper) {\n          const isOpen = dropdownWrapper.classList.contains(\"is-open\");\n\n          // Close all PFD dropdowns first\n          document\n            .querySelectorAll(\n              \".pfd-custom-options .t4s-dropdown__wrapper.is-open\",\n            )\n            .forEach((wrapper) => wrapper.classList?.remove(\"is-open\"));\n\n          // Toggle current dropdown\n          if (!isOpen) {\n            dropdownWrapper.classList.add(\"is-open\");\n            customDropdown.setAttribute(\"aria-expanded\", \"true\");\n          } else {\n            customDropdown.setAttribute(\"aria-expanded\", \"false\");\n          }\n        }\n\n        return;\n      }\n\n      // Close dropdowns when clicking outside\n      if (\n        !e.target.closest(\".pfd-custom-options\") &&\n        !e.target.closest(\".t4s-dropdown__wrapper\")\n      ) {\n        document\n          .querySelectorAll(\n            \".pfd-custom-options .t4s-dropdown__wrapper.is-open\",\n          )\n          .forEach((wrapper) => {\n            wrapper.classList?.remove(\"is-open\");\n            const customButton = document.querySelector(\n              `[data-pfd-dropdown-open][data-id=\"${wrapper.id}\"]`,\n            );\n            if (customButton) {\n              customButton.setAttribute(\"aria-expanded\", \"false\");\n            }\n          });\n      }\n    });\n\n    // Handle keyboard navigation for dropdowns\n    document.addEventListener(\"keydown\", function (e) {\n      if (e.key === \"Escape\") {\n        document\n          .querySelectorAll(\n            \".pfd-custom-options .t4s-dropdown__wrapper.is-open\",\n          )\n          .forEach((wrapper) => {\n            wrapper.classList?.remove(\"is-open\");\n            const customButton = document.querySelector(\n              `[data-pfd-dropdown-open][data-id=\"${wrapper.id}\"]`,\n            );\n            if (customButton) {\n              customButton.setAttribute(\"aria-expanded\", \"false\");\n              customButton.focus();\n            }\n          });\n      }\n    });\n  }\n\n  // Initialize split selection handlers\n  setupSplitSelectionHandlers();\n\n  // ---------- Bootstrap selection ----------\n  const domSelected = getSelectedFromDOM();\n  for (let i = 0; i < optionCount; i++)\n    selectedValues[i] = domSelected[i] || \"\";\n  patchAllAvailability();\n\n  // Initial image update with any existing data\n  updateSwatchImages();\n  updateVariantImages();\n\n  // Run luminance detection on SSR-rendered out-of-stock swatches so that\n  // .t4s-swatch__available-lengths contrast CSS fires any JS interaction.\n  // updateSwatchImages() sets img.src synchronously, so images may still be\n  // loading — we pass each container to detectSwatchLuminance which handles\n  // both the already-loaded and the still-loading cases via its load listener.\n  (function initLuminanceForSSRSwatches() {\n    const outOfStockWraps = root.querySelectorAll(\n      \".t4s-swatch__btn-wrap.is--out-of-stock\"\n    );\n    for (const wrap of outOfStockWraps) {\n      const imgContainer = wrap.querySelector(\"[data-img-el]\");\n      if (!imgContainer) continue;\n      const badge = imgContainer.querySelector(\".t4s-swatch__restock-badge\");\n      detectSwatchLuminance(imgContainer, badge);\n    }\n  })();\n\n  // Show custom notice on page load if custom option is already selected\n  setTimeout(() => {\n    const swatchOptions = document.querySelectorAll(\"[data-swatch-option]\");\n    swatchOptions.forEach((optEl) => {\n      const selectedCustomItem = optEl.querySelector(\n        \".pfd-custom-options [data-swatch-item].is--selected\",\n      );\n      const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n      const customDropdownButton = optEl.querySelector(\".pfd-custom-dropdown\");\n\n      if (selectedCustomItem && customNotice) {\n        const optionName = optEl.getAttribute(\"data-option-name\") || \"item\";\n        const noticeText = customNotice.querySelector(\n          \".pfd-custom-notice-text\",\n        );\n        if (noticeText) {\n          noticeText.innerHTML = `Custom ${optionName.toLowerCase()}s are <strong>made to order</strong>. Please allow <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery.`;\n        }\n        customNotice.style.display = \"block\";\n\n        // Add active state to dropdown button if custom option is selected\n        if (customDropdownButton) {\n          customDropdownButton.classList.add(\"is--selected\");\n        }\n      }\n    });\n  }, 100);\n\n  // Initial thumbnail update on page load\n  if (typeof $ !== \"undefined\") {\n    setTimeout(() => {\n      triggerThumbnailUpdate();\n    }, 500);\n  }\n\n  // ---------- Storefront hydration ----------\n  const productHandle = window.__PRODUCT_HANDLE__;\n  if (!productHandle) {\n    console.warn(\"[PFD] Missing window.__PRODUCT_HANDLE__\");\n    return;\n  }\n\n  const endpoint = `${window.location.origin}/api/2026-01/graphql.json`;\n\n  function sfFetch(query, variables, fallback = false) {\n    const headers = {\n      \"content-type\": \"application/json\",\n    };\n\n    if (!fallback) {\n      headers[\"X-Shopify-Storefront-Access-Token\"] =\n        \"5b053b572b0031f80b6d0465d5be4a18\";\n    }\n\n    return fetch(endpoint, {\n      method: \"POST\",\n      headers,\n      body: JSON.stringify({ query, variables }),\n    }).then((r) => r.json());\n  }\n\n  async function hydrateAllVariants(fallback = false) {\n    const variantImageField = fallback\n      ? \"\"\n      : `\n      variant_image: metafield(key: \"variant_image\", namespace: \"custom\") {\n        references(first: 5) {\n          nodes {\n            ... on MediaImage {\n              id\n              image {\n                url\n              }\n            }\n          }\n        }\n      }\n    `;\n\n    const quantityAvailableField = fallback ? \"\" : \"quantityAvailable\";\n\n    const query = `\n      query VariantsPage($handle: String!, $first: Int!, $after: String) {\n        product(handle: $handle) {\n          requiresSellingPlan\n          variants(first: $first, after: $after) {\n            pageInfo { hasNextPage endCursor }\n            nodes {\n              id\n              title\n              availableForSale\n              selectedOptions { name value }\n              sku\n              taxable\n              price {\n                amount\n              }\n              compareAtPrice {\n                amount\n              }\n              weight\n              barcode\n              ${quantityAvailableField}\n              image {\n                id\n                url\n                width\n                height\n                altText\n              }\n              ${variantImageField}\n            }\n          }\n        }\n      }\n    `;\n\n    let after = null;\n    while (true) {\n      const res = await sfFetch(\n        query,\n        {\n          handle: productHandle,\n          first: 250,\n          after,\n        },\n        fallback,\n      );\n\n      if (res?.data?.product === null && !fallback) {\n        return hydrateAllVariants(true);\n      }\n\n      const nodes = res?.data?.product?.variants?.nodes || [];\n      const pageInfo = res?.data?.product?.variants?.pageInfo;\n      const productRequiresSellingPlan =\n        res?.data?.product?.requiresSellingPlan || false;\n\n      for (const n of nodes) {\n        const gid = String(n.id);\n        const numericId = gid.includes(\"/\") ? gid.split(\"/\").pop() : gid;\n\n        const optMap = new Map(\n          (n.selectedOptions || []).map((o) => [\n            normName(o.name),\n            normVal(o.value),\n          ]),\n        );\n\n        // Extract variant images - collect all images from variant_image metafield\n        const variantImageNodes = n.variant_image?.references?.nodes || [];\n        const variantImages = variantImageNodes\n          .map((node) => node.image?.url)\n          .filter(Boolean);\n        const mainImageUrl = n.image?.url;\n        const imageUrl = mainImageUrl;\n\n        // Build featured_image object to match theme format\n        const featuredImage = n.image\n          ? {\n              id: n.image.id\n                ? String(n.image.id).includes(\"/\")\n                  ? String(n.image.id).split(\"/\").pop()\n                  : n.image.id\n                : null,\n              src: n.image.url,\n              width: n.image.width || 600,\n              height: n.image.height || 600,\n              alt: n.image.altText || null,\n            }\n          : null;\n\n        // Build featured_media object to match theme format\n        const featuredMedia = n.image\n          ? {\n              id: n.image.id\n                ? String(n.image.id).includes(\"/\")\n                  ? String(n.image.id).split(\"/\").pop()\n                  : n.image.id\n                : null,\n              alt: n.image.altText || null,\n              preview_image: {\n                aspect_ratio:\n                  n.image.width && n.image.height\n                    ? n.image.width / n.image.height\n                    : 1,\n                height: n.image.height || 600,\n                width: n.image.width || 600,\n                src: n.image.url,\n              },\n            }\n          : null;\n\n        // Get option values for title and public_title\n        const optionValues = (n.selectedOptions || []).map((o) => o.value);\n\n        const rawVariant = {\n          id: numericId,\n          title: n.title,\n          available: !!n.availableForSale,\n          sku: n.sku,\n          requires_shipping: true,\n          taxable: n.taxable !== false,\n          featured_image: featuredImage,\n          options: optionValues,\n          price: n.price ? Math.round(parseFloat(n.price.amount) * 100) : 0,\n          weight: n.weight || 0,\n          compare_at_price: n.compareAtPrice\n            ? Math.round(parseFloat(n.compareAtPrice.amount) * 100)\n            : null,\n          inventory_management: \"shopify\",\n          barcode: n.barcode || \"\",\n          featured_media: featuredMedia,\n          inventory_policy: null,\n          inventory_quantity:\n            n.quantityAvailable !== undefined ? n.quantityAvailable : 0,\n          imageUrl: imageUrl,\n          variantImages:\n            variantImages.length > 0\n              ? variantImages\n              : mainImageUrl\n                ? [mainImageUrl]\n                : [],\n        };\n\n        for (let i = 0; i < optionCount; i++) {\n          const optName = normName(options?.[i]?.name);\n          rawVariant[`option${i + 1}`] = optName\n            ? optMap.get(optName) || \"\"\n            : \"\";\n        }\n\n        const v = buildThemeVariant(rawVariant, productRequiresSellingPlan);\n\n        // Store the product selling plan info for upsertVariant\n        v._productRequiresSellingPlan = productRequiresSellingPlan;\n\n        upsertVariant(v);\n\n        // Ensure option exists in select for hydrated variants\n        ensureSelectOption(numericId, v);\n      }\n\n      // Patch as data arrives (won't disable everything if partial)\n      patchAllAvailability();\n\n      if (!pageInfo?.hasNextPage) break;\n      after = pageInfo.endCursor;\n    }\n\n    // Final pass once all data is in\n    patchAllAvailability();\n\n    // Update swatch images with the loaded data\n    updateSwatchImages();\n\n    // Update variant images sections with the loaded data\n    updateVariantImages();\n\n    // Update thumbnails after hydration completes\n    if (typeof $ !== \"undefined\") {\n      setTimeout(() => {\n        triggerThumbnailUpdate();\n      }, 200);\n    }\n  }\n\n  function setDefaultVariant() {\n    console.log(\"[PFD] Selected Variant\", window.__HAS_SELECTED__);\n    console.log(\"[PFD] Default Variant\", window.__DEFAULT_VARIANT__);\n\n    // If there is a selected variant, do nothing (handled by server)\n    if (window.__HAS_SELECTED__) {\n      console.log(\n        \"[PFD] Selected variant exists, skipping default variant logic\",\n      );\n      return;\n    }\n\n    // If there is no selected variant, set the default variant\n    const defaultVariant = window.__DEFAULT_VARIANT__;\n    if (!defaultVariant || !defaultVariant.id) {\n      console.log(\"[PFD] No default variant specified\");\n      return;\n    }\n\n    console.log(\"[PFD] Setting default variant:\", defaultVariant.id);\n\n    // Get the variant from our data\n    const variant = variantById.get(String(defaultVariant.id));\n    console.log(\"variant\", { ...variant });\n    if (!variant) {\n      console.log(\"[PFD] Variant not found in cache:\", defaultVariant.id);\n      return;\n    }\n\n    // Step 1: Update selectedValues array (critical for system to work)\n    for (let i = 0; i < optionCount; i++) {\n      selectedValues[i] = variant[`option${i + 1}`] || \"\";\n    }\n\n    // Step 2: Clear all current visual selections\n    document\n      .querySelectorAll(\"[data-swatch-item].is--selected\")\n      .forEach((el) => {\n        el.classList.remove(\"is--selected\");\n      });\n\n    // Step 3: Update visual state for each option (exactly like click handler)\n    for (let i = 0; i < optionCount; i++) {\n      const optionValue = variant[`option${i + 1}`];\n      if (!optionValue) continue;\n\n      const optEl = document.querySelector(\n        `[data-swatch-option][data-id=\"${i}\"]`,\n      );\n      if (!optEl) continue;\n\n      const swatchItem = optEl.querySelector(\n        `[data-swatch-item][data-value=\"${optionValue.replace(/\"/g, '\\\\\"')}\"]`,\n      );\n      console.log(swatchItem);\n\n      // Check if this is a split option (has both standard and custom dropdown)\n      const isSplitOption = optEl.classList.contains(\"pfd-split-option\");\n\n      if (swatchItem) {\n        swatchItem.classList.add(\"is--selected\");\n\n        // Update display value exactly like click handler\n        const optionUnit = optEl.getAttribute(\"data-option-unit\") || \"\";\n        const displayValue = getDisplayValue(optionValue, optionUnit);\n\n        let titleElement = optEl.querySelector(\n          \".t4s-swatch__title--right .bold\",\n        );\n        if (titleElement) {\n          titleElement.textContent = displayValue;\n        } else {\n          titleElement = optEl.querySelector(\".t4s-selected-value\");\n          if (titleElement) {\n            titleElement.textContent = displayValue;\n          }\n        }\n\n        // Handle dropdown logic for split options\n        if (isSplitOption) {\n          const isFromCustomDropdown = swatchItem.closest(\n            \".pfd-custom-options\",\n          );\n\n          if (isFromCustomDropdown) {\n            // Custom option selected - update dropdown button and show custom notice\n            const customDropdown = optEl.querySelector(\n              \".pfd-custom-dropdown [data-current-value]\",\n            );\n            const customDropdownButton = optEl.querySelector(\n              \".pfd-custom-dropdown\",\n            );\n\n            if (customDropdown) {\n              customDropdown.innerHTML = `${displayValue} <span class=\"pfd-custom-badge\">Custom</span>`;\n            }\n\n            if (customDropdownButton) {\n              customDropdownButton.classList.add(\"is--selected\");\n            }\n\n            // Show custom notice\n            const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n            if (customNotice) {\n              const optionName =\n                optEl.getAttribute(\"data-option-name\") || \"item\";\n              const noticeText = customNotice.querySelector(\n                \".pfd-custom-notice-text\",\n              );\n              if (noticeText) {\n                noticeText.innerHTML = `Custom ${optionName.toLowerCase()}s are <strong>made to order</strong>. Please allow <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery.`;\n              }\n              customNotice.style.display = \"block\";\n            }\n          } else {\n            // Standard option selected - reset dropdown to default state\n            const customDropdown = optEl.querySelector(\n              \".pfd-custom-dropdown [data-current-value]\",\n            );\n            const customDropdownButton = optEl.querySelector(\n              \".pfd-custom-dropdown\",\n            );\n\n            if (customDropdown) {\n              const optionName = optEl.getAttribute(\"data-option-name\") || \"\";\n              customDropdown.textContent = `Custom ${optionName.toLowerCase()}`;\n            }\n\n            if (customDropdownButton) {\n              customDropdownButton.classList.remove(\"is--selected\");\n            }\n\n            // Hide custom notice\n            const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n            if (customNotice) {\n              customNotice.style.display = \"none\";\n            }\n          }\n        }\n      } else if (isSplitOption) {\n        // No matching swatch item found, but this is a split option\n        // Reset dropdown to default state since selection is not in standard or custom options\n        const customDropdown = optEl.querySelector(\n          \".pfd-custom-dropdown [data-current-value]\",\n        );\n        const customDropdownButton = optEl.querySelector(\n          \".pfd-custom-dropdown\",\n        );\n\n        if (customDropdown) {\n          const optionName = optEl.getAttribute(\"data-option-name\") || \"\";\n          customDropdown.textContent = `Custom ${optionName.toLowerCase()}`;\n        }\n\n        if (customDropdownButton) {\n          customDropdownButton.classList.remove(\"is--selected\");\n        }\n\n        // Hide custom notice\n        const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n        if (customNotice) {\n          customNotice.style.display = \"none\";\n        }\n      }\n    }\n\n    // Step 4: Update HTML data attributes on select option (like click handler does)\n    const selectedOption = selectEl?.querySelector(\n      `option[value=\"${defaultVariant.id}\"]`,\n    );\n    if (selectedOption) {\n      selectedOption.setAttribute(\"data-incoming\", variant.incoming || \"false\");\n      selectedOption.setAttribute(\n        \"data-nextincomingdate\",\n        variant.nextIncomingDate || \"\",\n      );\n      selectedOption.setAttribute(\n        \"data-inventorypolicy\",\n        variant.inventoryPolicy || \"deny\",\n      );\n      selectedOption.setAttribute(\n        \"data-inventoryquantity\",\n        variant.inventoryQuantity || (variant.available ? \"999\" : \"0\"),\n      );\n    }\n\n    // Step 5: Ensure DOM exists for variant\n    ensureDOMForVariant(defaultVariant.id);\n\n    // Step 6: Apply to select element\n    applyVariantToSelect(defaultVariant.id);\n\n    // Step 7: Re-patch availability (exactly like click handler)\n    patchAllAvailability();\n\n    // Update thumbnails after hydration completes\n    if (typeof $ !== \"undefined\") {\n      setTimeout(() => {\n        triggerThumbnailUpdate();\n      }, 200);\n    }\n  }\n\n  hydrateAllVariants(false)\n    .then(() => {\n      setDefaultVariant();\n    })\n    .catch((e) => console.warn(\"[PFD] Hydration failed\", e));\n})();\n",
              "reasoning": "Fix the broken error event listener (missing closing braces) and remove the duplicate isColorOption definition that shadowed the correct one using __COLOR_OPTION_NAMES__."
            },
            "result": "(no result received)",
            "isError": true,
            "elapsedMs": 0
          },
          {
            "name": "edit_lines",
            "id": "toolu_01B9xuZjfeypANZS53nvAHwE",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "startLine": 899,
              "endLine": 913,
              "newContent": "    img.addEventListener(\"error\", () => {\n      applyLuminance(\"dark\");\n    }, { once: true });\n  }\n}\n\n// Check if an option is a Color option based on the option name.\n// Matches the full get_color set injected by Liquid as window.__COLOR_OPTION_NAMES__,\n// which includes \"color\", \"colors\", \"colour\", \"couleur\" plus any store-level additions.\nfunction isColorOption(optionIndex) {\n  const optionName = normName(options?.[optionIndex]?.name || \"\");\n  const colorNames = window.__COLOR_OPTION_NAMES__ || [\"color\", \"colours\", \"couleur\", \"colour\", \"colors\"];\n  return colorNames.some((n) => normName(n) === optionName);\n}\n",
              "reasoning": "Fix the broken error event listener (missing closing braces) and remove the duplicate isColorOption definition that shadowed the correct one using __COLOR_OPTION_NAMES__."
            },
            "result": "(no result received)",
            "isError": true,
            "elapsedMs": 0
          },
          {
            "name": "propose_code_edit",
            "id": "pm-change-1772178868241",
            "input": {
              "filePath": "product-form-dynamic.liquid",
              "newContent": "{% comment %} Custom options configuration - options listed here will render as dropdowns {% endcomment %}\n{% assign custom_option_names = product.metafields.custom.custom_values.value %}\n\n{% comment %} Custom content configuration for specific options {% endcomment %}\n{% comment %} Format: option_name:option_value|<html content> - separated by semicolons for multiple {% endcomment %}\n\n{% assign option_content_config = 'texture:Straight|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our straight texture has slight natural wave texture to it when washed and dried. It is not pin straight hair, nor is that desirable among most clientele.</span></div>;texture:Natural Wave|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our natural wave texture features soft, beachy waves that blend seamlessly with most natural hair textures. Low maintenance and versatile for everyday styling.</span></div>;texture:Loose Curl|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our loose curl texture offers bouncy, defined curls that hold their shape beautifully. Perfect for adding volume and movement with minimal styling required.</span></div>;texture:Tight Curl|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our tight curl texture provides well-defined, springy curls with maximum volume. Ideal for protective styles and blending with naturally curly hair.</span></div>' %}\n\n{% assign option_content_pairs = option_content_config | split: ';' %}\n\n{% comment %} SellersDash collect child product details {% endcomment %}\n{% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}\n{% if shsd_product_details.product_type == 'shsd_parent' %}\n  {% assign shsd_product_handles = product.handle %}\n  {% assign shsd_product_handles = shsd_product_handles | concat: shsd_product_details.handles %}\n  {% for shsd_handle in shsd_product_handles %}\n    {% assign shsd_single_product = all_products[shsd_handle] %}\n    {% assign shsd_product_variants = shsd_product_variants | concat: shsd_single_product.variants %}\n    {% assign shsd_product_media = shsd_product_media | concat: shsd_single_product.media %}\n    {% assign shsd_product_images = shsd_product_images | concat: shsd_single_product.images %}\n  {% endfor %}\n  {% assign shsd_product_options_with_values = shsd_product_details.options_with_values %}\n{% else %}\n  {% assign shsd_product_options_with_values = product.options_with_values %}\n  {% assign shsd_product_variants = product.variants %}\n  {% assign shsd_product_media = product.media %}\n  {% assign shsd_product_images = product.images %}\n{% endif %}\n\n{% comment %} Reorder options: Length, Texture, Color, then remaining {% endcomment %}\n{% assign reordered_options = '' | split: '' %}\n{% assign remaining_options = '' | split: '' %}\n\n{% for option in shsd_product_options_with_values %}\n  {% assign opt_name_lower = option.name | downcase | strip %}\n  {% if opt_name_lower == 'length' %}\n    {% assign length_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n  {% elsif opt_name_lower == 'texture' %}\n    {% assign texture_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n  {% elsif opt_name_lower == 'color' or opt_name_lower == 'colour' or opt_name_lower == 'colors' %}\n    {% assign color_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n  {% else %}\n    {% assign other_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n    {% assign remaining_options = remaining_options | concat: other_slice %}\n  {% endif %}\n{% endfor %}\n\n{% if length_slice %}\n  {% assign reordered_options = reordered_options | concat: length_slice %}\n{% endif %}\n{% if texture_slice %}\n  {% assign reordered_options = reordered_options | concat: texture_slice %}\n{% endif %}\n{% if color_slice %}\n  {% assign reordered_options = reordered_options | concat: color_slice %}\n{% endif %}\n{% assign shsd_product_options_with_values = reordered_options | concat: remaining_options %}\n\n{%- assign product_form_id = 'product-form-' | append: pr_sid -%}\n{%- liquid\n  assign pr_variants = shsd_product_variants\n  assign PR_buy_pr = false\n  if bk_stts.show_dynamic_checkout and isExternal == false and isProductAvailable\n    assign PR_buy_pr = true\n  endif\n  assign choose_an_option = 'products.product.choose_an_option' | t\n  assign date_in = settings.date_in\n  assign class_frm = 't4s-form__product has--form__swatch'\n  if isProductDefault\n    assign class_frm = 't4s-form__product'\n  endif\n  if arr_properties.size > 0 and isProductAvailable\n    assign class_frm = class_frm | append: ' has--properties'\n  endif\n  if settings.sticky_atc and type == 'main'\n    assign class_frm = class_frm | append: ' is--main-sticky'\n  else\n    assign class_frm = class_frm | append: ' is--atc-sticky'\n  endif\n\n  assign color_swatch = 'disabled-'\n  assign color_mode = bk_stts.color_mode\n  assign selector_mode = bk_stts.selector_mode\n  assign stt_color_ck = settings.color_ck | default: ';'\n  assign color_ck = stt_color_ck | append: ',color,colors,couleur,colour' | remove: ';,'\n  assign get_color = color_ck | downcase | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | uniq\n  assign color_mode_list = 'color, color is-sw-cl__round, color is-sw-cl__round is-sw-cl__label, variant_image, variant_image is-sw-cl__round, variant_image is-sw-cl__round is-sw-cl__label' | split: ', '\n  if color_mode_list contains color_mode\n    assign color_swatch = 'is-sw__color '\n  endif\n  assign current_variant_available = current_variant.available\n  assign use_incoming_mess = settings.use_incoming_mess\n  assign current_variant_incoming = false\n  assign current_inventory_quantity = current_variant.inventory_quantity\n  if current_inventory_quantity <= 0 and current_variant.inventory_management == 'shopify' and current_variant.incoming\n    assign current_variant_incoming = true\n  endif\n  if pos_sizeg == '1'\n    assign html_sizeg = ''\n  endif\n  if current_variant.inventory_management != null and current_inventory_quantity > 0 and current_variant.inventory_policy != 'continue'\n    assign max_qty = current_inventory_quantity\n  else\n    assign max_qty = 9999\n  endif\n  if color_mode contains 'color' or color_mode contains 'variant'\n    assign show_tooltip = ''\n  else\n    assign show_tooltip = '-off'\n  endif\n-%}\n\n{%- if product.metafields.custom.default_variant.value -%}\n  <script>\n    window.__HAS_SELECTED__ = {{ product.selected_variant | json }};\n    window.__DEFAULT_VARIANT__ = {{ product.metafields.custom.default_variant.value | json }};\n  </script>\n{%- endif -%}\n\n{%- assign length_option_position = -1 -%}\n{%- assign color_option_position = -1 -%}\n{%- for opt_name in product.options -%}\n  {%- assign opt_name_down = opt_name | downcase -%}\n  {%- if opt_name_down == 'length' -%}\n    {%- assign length_option_position = forloop.index -%}\n  {%- endif -%}\n  {%- if get_color contains opt_name_down -%}\n    {%- assign color_option_position = forloop.index -%}\n  {%- endif -%}\n{%- endfor -%}\n\n<script>\n  window.__CUSTOM_OPTION_NAMES__ = {{ custom_option_names | json }};\n  window.__LENGTH_OPTION_INDEX__ = {{ length_option_position | minus: 1 }};\n  window.__COLOR_OPTION_NAMES__ = {{ get_color | json }};\n</script>\n\n{%- comment -%} Load dropdown CSS if either color mode or selector mode is dropdown {%- endcomment -%}\n\n{%- if color_mode == 'dropdown' or selector_mode == 'dropdown' -%}\n  <link\n    rel=\"stylesheet\"\n    href=\"{{ 'base_drop.min.css' | asset_url }}\"\n    media=\"all\"\n  >\n{%- endif -%}\n\n{%- comment -%} Custom CSS for product form dynamic {%- endcomment -%}\n{{ 'product-form-dynamic.css' | asset_url | stylesheet_tag }}\n\n<div class=\"pfd-override-wrapper\">\n  <div class=\"pfd-custom-wrapper\">\n    <div\n      class=\"t4s-product-form__variants is-no-pick__{{ PR_no_pick }}{% if PR_buy_pr %} is-payment-btn-true t4s-payment-button t4s-btn-color-{{ bk_stts.button_color_payment }}{% endif %} is-remove-soldout-{{ remove_soldout }} is-btn-full-width__{{ bk_stts.btn_atc_full }} is-btn-atc-txt-{{ bk_stts.btn_txt }} is-btn-ck-txt-{{ bk_stts.btn_txt2 }} is--fist-ratio-{{ is_fit_ratio_img }}\"\n      style=\"{% if is_fit_ratio_img %} --fit-ratio-img: {{ first_ratio_img }}; {% endif %} --wishlist-color: {{bk_stts.wishlist_color}};--wishlist-hover-color: {{bk_stts.wishlist_color_hover}};--wishlist-active-color: {{bk_stts.wishlist_color_active}};--compare-color: {{bk_stts.compare_color}};--compare-hover-color: {{bk_stts.compare_color_hover}};--compare-active-color: {{bk_stts.compare_color_active}};\"\n      {{ shopify_attributes }}\n    >\n      <div data-callBackVariant id=\"t4s-callBackVariant{{ product_form_id }}\">\n        {%- form 'product',\n          product,\n          id: product_form_id,\n          data-productid: product.id,\n          class: class_frm,\n          novalidate: 'novalidate',\n          data-type: 'add-to-cart-form',\n          data-disable-swatch: isProductDefault\n        -%}\n          {% comment %}{{- form | payment_terms -}}{% endcomment %}\n          {%- if isProductDefault -%}\n            <input\n              name=\"id\"\n              value=\"{{ pr_variants.first.id }}\"\n              type=\"hidden\"\n            >\n            {%- if advance_pr_type != blank -%}\n              {%- render 'choose_style', advance_pr_type: advance_pr_type, title: advance_label, pid: product.id -%}\n            {%- endif -%}\n          {%- else -%}\n            {{ 'swatch.css' | asset_url | stylesheet_tag }}\n            <select\n              name=\"id\"\n              id=\"product-select-{{ pr_sid }}\"\n              class=\"t4s-product__select t4s-d-none\"\n            >\n              {%- for variant in pr_variants -%}\n                {%- if variant.available -%}\n                  <option\n                    data-option1=\"{{ variant.option1 }}\"\n                    data-option2=\"{{ variant.option2 }}\"\n                    value=\"{{ variant.id }}\"\n                    data-mdid=\"{{ variant.featured_media.id | json }}\"\n                    data-incoming=\"{{ variant.incoming }}\"\n                    data-inventoryQuantity=\"{{ variant.inventory_quantity | json }}\"\n                    data-inventoryPolicy=\"{{ variant.inventory_policy | json }}\"\n                    data-nextIncomingDate=\"{{ variant.next_incoming_date | date: date_in }}\"\n                    {% if variant.id == current_variant.id %}\n                      selected=\"selected\"\n                    {% endif %}\n                  >\n                    {{ variant.title | escape }}\n                  </option>\n                {%- else -%}\n                  <option\n                    data-option1=\"{{ variant.option1 }}\"\n                    data-option2=\"{{ variant.option2 }}\"\n                    value=\"{{ variant.id }}\"\n                    data-mdid=\"{{ variant.featured_media.id | json }}\"\n                    data-incoming=\"{{ variant.incoming }}\"\n                    data-inventoryQuantity=\"{{ variant.inventory_quantity | json }}\"\n                    data-inventoryPolicy=\"{{ variant.inventory_policy | json }}\"\n                    data-nextIncomingDate=\"{{ variant.next_incoming_date | date: date_in }}\"\n                  >\n                    {{ variant.title | escape }}\n                  </option>\n                {%- endif -%}\n              {%- endfor -%}\n            </select>\n\n            <div class=\"pfd-variant-images\" style=\"display:none !important;\">\n              <div class=\"pfd-main-imgs\">\n                {%- for variant in pr_variants -%}\n                  {% assign var_imgs = variant.metafields.custom.variant_image.value %}\n                  <div\n                    class=\"pfd-img-listing\"\n                    data-var-img=\"{{ variant.image.src | img_url: 'master' }}\"\n                    data-pfd-variant-id=\"{{ variant.id }}\"\n                  >\n                    {% for value in var_imgs %}\n                      <div class=\"pfd-media-item\">\n                        <img src=\"{{value | img_url: 'master'}}\">\n                      </div>\n                    {% endfor %}\n                  </div>\n                {%- endfor -%}\n              </div>\n              <div class=\"pfd-thumb-imgs\">\n                {%- for variant in pr_variants -%}\n                  {% assign var_imgs = variant.metafields.custom.variant_image.value %}\n                  <div class=\"pfd-img-listing\" data-pfd-variant-id=\"{{ variant.id }}\">\n                    {% for value in var_imgs %}\n                      <div class=\"pfd-media-thumb\">\n                        <div\n                          class=\"pfd-img\"\n                          style=\"background-image:url('{{value | img_url: \"master\"}}');\"\n                        ></div>\n                      </div>\n                    {% endfor %}\n                  </div>\n                {%- endfor -%}\n              </div>\n            </div>\n\n            <div class=\"t4s-swatch t4s-color-mode__{{ color_mode }} t4s-color-size__{{ bk_stts.color_size }} t4s-selector-mode__{{ selector_mode }}\">\n              {%- if advance_pr_type != blank -%}\n                {%- render 'choose_style', advance_pr_type: advance_pr_type, title: advance_label, pid: product.id -%}\n              {%- endif -%}\n\n              {%- for option in shsd_product_options_with_values -%}\n                {%- liquid\n                  assign option_index = 'option' | append: forloop.index\n                  assign selected_value = product.selected_or_first_available_variant[option_index]\n                  assign option_name = option.name\n                  assign name_downcase = option_name | downcase\n                -%}\n\n                {%- if get_color contains name_downcase -%}\n                  {% comment %}--MARK: Color Option{% endcomment %}\n\n                  {% comment %} Build color nickname map from variant metafields {% endcomment %}\n                  {%- capture color_nicknames_map -%}\n                    {%- for variant in shsd_product_variants -%}\n                      {%- if variant.metafields.custom.variant_color != blank -%}\n                        {%- for opt_index in (1..3) -%}\n                          {%- assign opt_key = 'option' | append: opt_index -%}\n                          {%- assign opt_val = variant[opt_key] -%}\n                          {%- if opt_val != blank -%}\n                            {%- assign opt_index_adjusted = opt_index | minus: 1 -%}\n                            {%- assign opt_name_check = product.options[opt_index_adjusted] | downcase -%}\n                            {%- if get_color contains opt_name_check -%}\n                              {{ opt_val | handle }}:{{ variant.metafields.custom.variant_color }};\n                            {%- endif -%}\n                          {%- endif -%}\n                        {%- endfor -%}\n                      {%- endif -%}\n                    {%- endfor -%}\n                  {%- endcapture -%}\n                  {%- assign color_nicknames_map = color_nicknames_map | strip -%}\n\n                  <div\n                    data-swatch-option\n                    data-option-name=\"{{ option_name | escape }}\"\n                    data-id=\"{{ forloop.index0 }}\"\n                    data-option-unit=\"\n                      {%- liquid\n                        assign option_unit = ''\n                        if se_stts and se_stts.option_units and se_stts.option_units != blank\n                          assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                          for pair in option_units_raw\n                            assign pair_cleaned = pair | strip\n                            if pair_cleaned contains ':'\n                              assign key_value = pair_cleaned | split: ':'\n                              assign key = key_value[0] | strip\n                              assign value = key_value[1] | strip\n                              if key == option_name and value != blank\n                                assign option_unit = value\n                                break\n                              endif\n                            endif\n                          endfor\n                        endif\n                      -%}{{ option_unit | escape }}\n                    \"\n                    class=\"t4s-swatch__option is-t4s-style__color is-t4s-name__{{ option_name | handle }} {% cycle 'is--first-color', '', '' %}\"\n                  >\n                    <h4 class=\"t4s-swatch__title t4s-swatch__title--color\">\n                      <span class=\"t4s-swatch__title--left\">\n                        <span class=\"bold\">\n                          {{- option_name | upcase -}}\n                          {%- liquid\n                            assign option_unit = ''\n                            if se_stts and se_stts.option_units and se_stts.option_units != blank\n                              assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                              for pair in option_units_raw\n                                assign pair_cleaned = pair | strip\n                                if pair_cleaned contains ':'\n                                  assign key_value = pair_cleaned | split: ':'\n                                  assign key = key_value[0] | strip\n                                  assign value = key_value[1] | strip\n                                  if key == option_name and value != blank\n                                    assign option_unit = value\n                                    break\n                                  endif\n                                endif\n                              endfor\n                            endif\n                          -%}\n                          {%- if option_unit != blank %} ({{ option_unit }}){%- endif -%}\n                          :\n                        </span>\n                        <span class=\"t4s-selected-value\">\n                          {%- assign display_value = selected_value | default: choose_an_option | replace: '\"', '' -%}\n                          {{- display_value -}}\n                          {%- if option_unit != blank %} {{ option_unit }}{%- endif -%}\n                        </span>\n                      </span>\n                      {%- if name_sizeg == name_downcase -%}\n                        {{- html_sizeg -}}\n                      {%- endif %}\n                    </h4>\n\n                    <div data-swatch-list class=\"t4s-swatch__list\">\n                      {%- if color_mode != 'dropdown' -%}\n                        {%- if color_mode contains 'is-sw-cl__label' -%}\n                          {%- for value in option.values -%}\n                            {%- assign color_handle = value | handle -%}\n\n                            {%- comment %} Look up color nickname from map {%- endcomment -%}\n                            {%- assign color_nickname = '' -%}\n                            {%- assign nickname_pairs = color_nicknames_map | split: ';' -%}\n                            {%- for pair in nickname_pairs -%}\n                              {%- assign pair_clean = pair | strip -%}\n                              {%- if pair_clean != blank -%}\n                                {%- assign pair_parts = pair_clean | split: ':' -%}\n                                {%- if pair_parts[0] == color_handle -%}\n                                  {%- assign color_nickname = pair_parts[1] -%}\n                                  {%- break -%}\n                                {%- endif -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Context-aware availability check: color + current other selections {%- endcomment -%}\n                            {%- assign color_is_available = false -%}\n                            {%- for variant in shsd_product_variants -%}\n                              {%- assign matches_color = false -%}\n                              {%- assign matches_other_options = true -%}\n\n                              {%- for opt_idx in (1..3) -%}\n                                {%- assign opt_key = 'option' | append: opt_idx -%}\n                                {%- assign variant_opt_val = variant[opt_key] -%}\n                                {%- if variant_opt_val != blank -%}\n                                  {%- assign variant_opt_handle = variant_opt_val | handle -%}\n\n                                  {%- comment %} Determine if this option index is the color option {%- endcomment -%}\n                                  {%- assign opt_idx_adjusted = opt_idx | minus: 1 -%}\n                                  {%- assign this_opt_name = product.options[opt_idx_adjusted] | downcase -%}\n\n                                  {%- if get_color contains this_opt_name -%}\n                                    {%- comment %} This is the color option - check if it matches our target color {%- endcomment -%}\n                                    {%- if variant_opt_handle == color_handle -%}\n                                      {%- assign matches_color = true -%}\n                                    {%- endif -%}\n                                  {%- else -%}\n                                    {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment -%}\n                                    {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}\n                                    {%- if current_selected_val != blank -%}\n                                      {%- assign current_selected_handle = current_selected_val | handle -%}\n                                      {%- unless variant_opt_handle == current_selected_handle -%}\n                                        {%- assign matches_other_options = false -%}\n                                      {%- endunless -%}\n                                    {%- endif -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n\n                              {%- if matches_color and matches_other_options and variant.available -%}\n                                {%- assign color_is_available = true -%}\n                                {%- break -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Compute available standard lengths for this color (used for both classes and content) {%- endcomment -%}\n                            {%- assign avail_lengths = '' -%}\n                            {%- assign avail_lengths_seen = '' -%}\n                            {%- assign length_opt_key = 'option' | append: length_option_position -%}\n                            {%- if length_option_position > 0 and color_option_position > 0 -%}\n                              {%- for lv in shsd_product_variants -%}\n                                {%- assign v_color_key = 'option' | append: color_option_position -%}\n                                {%- assign v_color_val = lv[v_color_key] | handle -%}\n                                {%- if v_color_val == color_handle and lv.available -%}\n                                  {%- assign v_length_val = lv[length_opt_key] -%}\n                                  {%- if v_length_val != blank -%}\n                                    {%- assign is_custom_length = false -%}\n                                    {%- if custom_option_names -%}\n                                      {%- for custom_name in custom_option_names -%}\n                                        {%- assign custom_name_stripped = custom_name | strip -%}\n                                        {%- if v_length_val == custom_name_stripped -%}\n                                          {%- assign is_custom_length = true -%}\n                                          {%- break -%}\n                                        {%- endif -%}\n                                      {%- endfor -%}\n                                    {%- endif -%}\n                                    {%- unless is_custom_length -%}\n                                      {%- assign v_length_clean = v_length_val | replace: '\"', '' | strip -%}\n                                      {%- assign sentinel = '@@' | append: v_length_clean | append: '@@' -%}\n                                      {%- unless avail_lengths_seen contains sentinel -%}\n                                        {%- assign avail_lengths_seen = avail_lengths_seen | append: sentinel -%}\n                                        {%- if avail_lengths == '' -%}\n                                          {%- assign avail_lengths = v_length_clean -%}\n                                        {%- else -%}\n                                          {%- assign avail_lengths = avail_lengths | append: ', ' | append: v_length_clean -%}\n\n                                        {%- endif -%}\n                                      {%- endunless -%}\n                                    {%- endunless -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                            {%- endif -%}\n\n                            <div\n                              data-swatch-item\n                              class=\"t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}{% unless color_is_available %} is--soldout is--out-of-stock{% if avail_lengths != '' %} pfd-has-lengths{% endif %}{% endunless %}\"\n                              data-value=\"{{ value | escape }}\"\n                              data-available=\"{{ color_is_available }}\"\n                            >\n                              <!-- DEBUG: color={{ color_handle }} | available={{ color_is_available }} | selected_opt1={{ product.selected_or_first_available_variant.option1 | handle }} | selected_opt2={{ product.selected_or_first_available_variant.option2 | handle }} -->\n                              <div\n                                data-img-el\n                                class=\"t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s\">\n                                <img crossorigin=\"anonymous\">\n                                {%- unless color_is_available -%}\n                                  <span class=\"t4s-swatch__restock-badge\">Awaiting Restock</span>\n                                {%- endunless -%}\n                              </div>\n                              {%- unless color_is_available -%}\n                                {%- if avail_lengths != '' -%}\n                                  <span class=\"t4s-swatch__available-lengths is-visible\">Available in {{ avail_lengths }}</span>\n                                {%- endif -%}\n                              {%- endunless -%}\n                              <span class=\"t4s-swatch__label\">\n                                {{- value | replace: '\"', '' -}}\n                              </span>\n                              {%- if color_nickname != blank -%}\n                                <span class=\"t4s-swatch__nickname\">{{ color_nickname }}</span>\n                              {%- endif -%}\n                            </div>\n\n                          {%- endfor -%}\n\n                        {%- else -%}\n                          {%- for value in option.values -%}\n                            {%- assign color_handle = value | handle -%}\n\n                            {%- comment %} Look up color nickname {%- endcomment -%}\n                            {%- assign color_nickname = '' -%}\n                            {%- assign nickname_pairs = color_nicknames_map | split: ';' -%}\n                            {%- for pair in nickname_pairs -%}\n                              {%- assign pair_clean = pair | strip -%}\n                              {%- if pair_clean != blank -%}\n                                {%- assign pair_parts = pair_clean | split: ':' -%}\n                                {%- if pair_parts[0] == color_handle -%}\n                                  {%- assign color_nickname = pair_parts[1] -%}\n                                  {%- break -%}\n                                {%- endif -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Context-aware availability check: color + current other selections {%- endcomment -%}\n                            {%- assign color_is_available = false -%}\n                            {%- for variant in shsd_product_variants -%}\n                              {%- assign matches_color = false -%}\n                              {%- assign matches_other_options = true -%}\n\n                              {%- for opt_idx in (1..3) -%}\n                                {%- assign opt_key = 'option' | append: opt_idx -%}\n                                {%- assign variant_opt_val = variant[opt_key] -%}\n                                {%- if variant_opt_val != blank -%}\n                                  {%- assign variant_opt_handle = variant_opt_val | handle -%}\n\n                                  {%- comment %} Determine if this option index is the color option {%- endcomment -%}\n                                  {%- assign opt_idx_adjusted = opt_idx | minus: 1 -%}\n                                  {%- assign this_opt_name = product.options[opt_idx_adjusted] | downcase -%}\n\n                                  {%- if get_color contains this_opt_name -%}\n                                    {%- comment %} This is the color option - check if it matches our target color {%- endcomment -%}\n                                    {%- if variant_opt_handle == color_handle -%}\n                                      {%- assign matches_color = true -%}\n                                    {%- endif -%}\n                                  {%- else -%}\n                                    {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment -%}\n                                    {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}\n                                    {%- if current_selected_val != blank -%}\n                                      {%- assign current_selected_handle = current_selected_val | handle -%}\n                                      {%- unless variant_opt_handle == current_selected_handle -%}\n                                        {%- assign matches_other_options = false -%}\n                                      {%- endunless -%}\n                                    {%- endif -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n\n                              {%- if matches_color and matches_other_options and variant.available -%}\n                                {%- assign color_is_available = true -%}\n                                {%- break -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Compute available standard lengths for this color {%- endcomment -%}\n                            {%- assign avail_lengths = '' -%}\n                            {%- assign avail_lengths_seen = '' -%}\n                            {%- assign length_opt_key = 'option' | append: length_option_position -%}\n                            {%- if length_option_position > 0 and color_option_position > 0 -%}\n                              {%- for lv in shsd_product_variants -%}\n                                {%- assign v_color_key = 'option' | append: color_option_position -%}\n                                {%- assign v_color_val = lv[v_color_key] | handle -%}\n                                {%- if v_color_val == color_handle and lv.available -%}\n                                  {%- assign v_length_val = lv[length_opt_key] -%}\n                                  {%- if v_length_val != blank -%}\n                                    {%- assign is_custom_length = false -%}\n                                    {%- if custom_option_names -%}\n                                      {%- for custom_name in custom_option_names -%}\n                                        {%- assign custom_name_stripped = custom_name | strip -%}\n                                        {%- if v_length_val == custom_name_stripped -%}\n                                          {%- assign is_custom_length = true -%}\n                                          {%- break -%}\n                                        {%- endif -%}\n                                      {%- endfor -%}\n                                    {%- endif -%}\n                                    {%- unless is_custom_length -%}\n                                      {%- assign v_length_clean = v_length_val | replace: '\"', '' | strip -%}\n                                      {%- assign sentinel = '@@' | append: v_length_clean | append: '@@' -%}\n                                      {%- unless avail_lengths_seen contains sentinel -%}\n                                        {%- assign avail_lengths_seen = avail_lengths_seen | append: sentinel -%}\n                                        {%- if avail_lengths == '' -%}\n                                          {%- assign avail_lengths = v_length_clean -%}\n                                        {%- else -%}\n                                          {%- assign avail_lengths = avail_lengths | append: ', ' | append: v_length_clean -%}\n                                        {%- endif -%}\n                                      {%- endunless -%}\n                                    {%- endunless -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                            {%- endif -%}\n\n                            <div\n                              data-swatch-item\n                class=\"t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}{% unless color_is_available %} is--soldout is--out-of-stock{% if avail_lengths != '' %} pfd-has-lengths{% endif %}{% endunless %}\"\n                              data-value=\"{{ value | escape }}\"\n                              data-available=\"{{ color_is_available }}\"\n                            >\n                              <div\n                                data-img-el\n                                class=\"t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s\"\n                              >\n                                <img crossorigin=\"anonymous\">\n                                {%- unless color_is_available -%}\n                                  <span class=\"t4s-swatch__restock-badge\">Awaiting Restock</span>\n                                {%- endunless -%}\n                              </div>\n                              {%- unless color_is_available -%}\n                                {%- if avail_lengths != '' -%}\n                                  <span class=\"t4s-swatch__available-lengths is-visible\">Available in {{ avail_lengths }}</span>\n                                {%- endif -%}\n                              {%- endunless -%}\n                              {%- if color_nickname != blank -%}\n                                <span class=\"t4s-swatch__nickname\">{{ color_nickname }}</span>\n                              {%- endif -%}\n                            </div>\n\n                          {%- endfor -%}\n\n                        {%- endif -%}\n                      {%- else -%}\n                        <button\n                          type=\"button\"\n                          data-dropdown-open\n                          data-position=\"bottom-end\"\n                          data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                        >\n                          <span data-current-value>\n                            {{- selected_value | default: choose_an_option -}}\n                          </span>\n                          <svg\n                            class=\"t4s-icon-select-arrow\"\n                            role=\"presentation\"\n                            viewBox=\"0 0 19 12\"\n                          >\n                            <use xlink:href=\"#t4s-select-arrow\"></use>\n                          </svg>\n                        </button>\n                        <div\n                          data-dropdown-wrapper\n                          class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                          id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                        >\n                          <div class=\"t4s-drop-arrow\"></div>\n                          <div class=\"t4s-dropdown__header\">\n                            <span\n                              data-current-value\n                              class=\"t4s-dropdown__title\"\n                            >\n                              {{- selected_value | default: choose_an_option -}}\n                            </span>\n                            <button\n                              data-dropdown-close\n                              aria-label=\"{{ 'general.aria.close' | t }}\"\n                            >\n                              <svg\n                                role=\"presentation\"\n                                class=\"t4s-iconsvg-close\"\n                                viewBox=\"0 0 16 14\"\n                              >\n                                <path d=\"M15 0L1 14m14 0L1 0\" stroke=\"currentColor\" fill=\"none\" fill-rule=\"evenodd\"></path>\n                              </svg>\n                            </button>\n                          </div>\n                          <div class=\"t4s-dropdown__content\">\n                            {%- for value in option.values -%}\n                              <div\n                                data-swatch-item\n                                data-dropdown-off\n                                class=\"t4s-swatch__item t4s-truncate {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}\"\n                                data-value=\"{{ value | escape }}\"\n                              >\n                                {{ value | replace: '\"', '' }}\n                              </div>\n                            {%- endfor -%}\n                          </div>\n                        </div>\n                      {%- endif -%}\n                    </div>\n                    {%- render 'color-info-accordion' -%}\n                  </div>\n                {%- else -%}\n                  {% comment %}--MARK: Non-Color{% endcomment %}\n                  {%- liquid\n                    assign standard_values = ''\n                    assign custom_values = ''\n                    assign has_standard = false\n                    assign has_custom = false\n\n                    for value in option.values\n                      assign is_custom = false\n                      for custom_name in custom_option_names\n                        assign custom_name_clean = custom_name | strip\n                        if value contains custom_name_clean\n                          assign is_custom = true\n                          break\n                        endif\n                      endfor\n\n                      if is_custom\n                        if custom_values == ''\n                          assign custom_values = value\n                        else\n                          assign custom_values = custom_values | append: ',' | append: value\n                        endif\n                        assign has_custom = true\n                      else\n                        if standard_values == ''\n                          assign standard_values = value\n                        else\n                          assign standard_values = standard_values | append: ',' | append: value\n                        endif\n                        assign has_standard = true\n                      endif\n                    endfor\n\n                    assign standard_values_array = standard_values | split: ','\n                    assign custom_values_array = custom_values | split: ','\n                  -%}\n\n                  <div\n                    data-swatch-option\n                    data-option-name=\"{{ option_name | escape }}\"\n                    data-id=\"{{ forloop.index0 }}\"\n                    data-option-unit=\"\n                      {%- liquid\n                        assign option_unit = ''\n                        if se_stts and se_stts.option_units and se_stts.option_units != blank\n                          assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                          for pair in option_units_raw\n                            assign pair_cleaned = pair | strip\n                            if pair_cleaned contains ':'\n                              assign key_value = pair_cleaned | split: ':'\n                              assign key = key_value[0] | strip\n                              assign value = key_value[1] | strip\n                              if key == option_name and value != blank\n                                assign option_unit = value\n                                break\n                              endif\n                            endif\n                          endfor\n                        endif\n                      -%}{{ option_unit | escape }}\n                    \"\n                    class=\"t4s-swatch__option is-t4s-name__{{ option_name | handle }} pfd-split-option\"\n                  >\n                    <h4 class=\"t4s-swatch__title\">\n                      <span class=\"t4s-swatch__title--left\"\n                        >Select a\n                        <span class=\"bold\">\n                          {{- option_name -}}\n                        </span>\n                        {%- liquid\n                          assign option_unit = ''\n                          if se_stts and se_stts.option_units and se_stts.option_units != blank\n                            assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                            for pair in option_units_raw\n                              assign pair_cleaned = pair | strip\n                              if pair_cleaned contains ':'\n                                assign key_value = pair_cleaned | split: ':'\n                                assign key = key_value[0] | strip\n                                assign value = key_value[1] | strip\n                                if key == option_name and value != blank\n                                  assign option_unit = value\n                                  break\n                                endif\n                              endif\n                            endfor\n                          endif\n                        -%}\n                        {%- if option_unit != blank %} ({{ option_unit }}){%- endif -%}\n                      </span>\n                      <span class=\"t4s-swatch__title--right\"\n                        >Selected:\n                        <span class=\"bold\">\n                          {%- assign display_value = selected_value | default: choose_an_option | replace: '\"', '' -%}\n                          {{- display_value -}}\n                          {%- if option_unit != blank %} {{ option_unit }}{%- endif -%}\n                        </span></span\n                      >\n                      {%- if name_sizeg == name_downcase -%}\n                        {{- html_sizeg -}}\n                      {%- endif %}\n                    </h4>\n\n                    <div class=\"pfd-split-selection\">\n                      {%- if has_standard -%}\n                        <div class=\"pfd-standard-options\">\n                          {%- if selector_mode != 'dropdown' -%}\n                            {%- for value in standard_values_array -%}\n                              <div\n                                data-swatch-item\n                                class=\"t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}\"\n                                data-value=\"{{ value | escape }}\"\n                              >\n                                {{ value | replace: '\"', '' }}\n                              </div>\n                            {%- endfor -%}\n                          {%- else -%}\n                            <button\n                              type=\"button\"\n                              data-pfd-dropdown-open\n                              data-position=\"bottom-end\"\n                              data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_standard\"\n                            >\n                              <span data-current-value>\n                                {{- selected_value | default: choose_an_option -}}\n                              </span>\n                              <svg\n                                class=\"t4s-icon-select-arrow\"\n                                role=\"presentation\"\n                                viewBox=\"0 0 19 12\"\n                              >\n                                <use xlink:href=\"#t4s-select-arrow\"></use>\n                              </svg>\n                            </button>\n                            <div\n                              data-dropdown-wrapper\n                              class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                              id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_standard\"\n                            >\n                              <div class=\"t4s-drop-arrow\"></div>\n                              <div class=\"t4s-dropdown__content\">\n                                {%- for value in standard_values_array -%}\n                                  <div\n                                    data-swatch-item\n                                    data-dropdown-off\n                                    class=\"t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}\"\n                                    data-value=\"{{ value | escape }}\"\n                                  >\n                                    {{ value | replace: '\"', '' }}\n                                  </div>\n                                {%- endfor -%}\n                              </div>\n                            </div>\n                          {%- endif -%}\n                        </div>\n                      {%- endif -%}\n\n                      {%- if has_custom -%}\n                        <div class=\"pfd-custom-options\">\n                          {%- if has_standard and has_custom -%}\n                            <span class=\"pfd-or-separator\">or</span>\n                          {%- endif -%}\n                          <button\n                            type=\"button\"\n                            data-pfd-dropdown-open\n                            data-position=\"bottom-end\"\n                            data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_custom\"\n                            class=\"pfd-custom-dropdown\"\n                          >\n                            <span data-current-value>\n                              {%- assign is_custom_selected = false -%}\n                              {%- for custom_val in custom_values_array -%}\n                                {%- if selected_value == custom_val -%}\n                                  {%- assign display_custom_val = custom_val | replace: '\"', '' -%}\n                                  {%- if option_unit != blank -%}\n                                    {{ display_custom_val }}\n                                    {{ option_unit }}\n                                    <span class=\"pfd-custom-badge\">Custom</span>\n                                  {%- else -%}\n                                    {{ display_custom_val }}\n                                    <span class=\"pfd-custom-badge\">Custom</span>\n                                  {%- endif -%}\n                                  {%- assign is_custom_selected = true -%}\n                                  {%- break -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                              {%- unless is_custom_selected -%}\n                                Custom {{ option_name | downcase }}\n                              {%- endunless -%}\n                            </span>\n                            <svg\n                              class=\"t4s-icon-select-arrow\"\n                              role=\"presentation\"\n                              viewBox=\"0 0 19 12\"\n                            >\n                              <use xlink:href=\"#t4s-select-arrow\"></use>\n                            </svg>\n                          </button>\n                          <div\n                            data-dropdown-wrapper\n                            class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                            id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_custom\"\n                          >\n                            <div class=\"t4s-drop-arrow\"></div>\n                            <div class=\"t4s-dropdown__content\">\n                              {%- for value in custom_values_array -%}\n                                <div\n                                  data-swatch-item\n                                  data-dropdown-off\n                                  class=\"t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}\"\n                                  data-value=\"{{ value | escape }}\"\n                                >\n                                  <span class=\"pfd-checkmark\">✓</span>\n                                  <span class=\"pfd-option-text\">\n                                    {%- assign display_value = value | replace: '\"', '' -%}\n                                    {%- if option_unit != blank -%}\n                                      {{ display_value }}\n                                      {{ option_unit }}\n                                    {%- else -%}\n                                      {{ display_value }}\n                                    {%- endif -%}\n                                  </span>\n                                  <span class=\"pfd-custom-badge\">Custom</span>\n                                </div>\n                              {%- endfor -%}\n                            </div>\n                          </div>\n                        </div>\n                      {%- endif -%}\n\n                      {%- unless has_standard or has_custom -%}\n                        {%- comment %} Fallback to original rendering if no split detected {%- endcomment %}\n                        <div class=\"t4s-swatch__list pfd-fallback-list\">\n                          {%- if selector_mode != 'dropdown' -%}\n                            {%- for value in option.values -%}\n                              <div\n                                data-swatch-item\n                                class=\"t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}\"\n                                data-value=\"{{ value | escape }}\"\n                              >\n                                {{ value | replace: '\"', '' }}\n                              </div>\n                            {%- endfor -%}\n                          {%- else -%}\n                            <button\n                              type=\"button\"\n                              data-pfd-dropdown-open\n                              data-position=\"bottom-end\"\n                              data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                            >\n                              <span data-current-value>\n                                {{- selected_value | default: choose_an_option -}}\n                              </span>\n                              <svg\n                                class=\"t4s-icon-select-arrow\"\n                                role=\"presentation\"\n                                viewBox=\"0 0 19 12\"\n                              >\n                                <use xlink:href=\"#t4s-select-arrow\"></use>\n                              </svg>\n                            </button>\n                            <div\n                              data-dropdown-wrapper\n                              class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                              id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                            >\n                              <div class=\"t4s-drop-arrow\"></div>\n                              <div class=\"t4s-dropdown__content\">\n                                {%- for value in option.values -%}\n                                  <div\n                                    data-swatch-item\n                                    data-dropdown-off\n                                    class=\"t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}\"\n                                    data-value=\"{{ value | escape }}\"\n                                  >\n                                    {{ value | replace: '\"', '' }}\n                                  </div>\n                                {%- endfor -%}\n                              </div>\n                            </div>\n                          {%- endif -%}\n                        </div>\n                      {%- endunless -%}\n                    </div>\n\n                    {%- comment %} Custom order notice - shown when custom option is selected {%- endcomment %}\n                    {%- assign show_custom_notice = false -%}\n                    {%- for custom_val in custom_values_array -%}\n                      {%- if selected_value == custom_val -%}\n                        {%- assign show_custom_notice = true -%}\n                        {%- break -%}\n                      {%- endif -%}\n                    {%- endfor -%}\n                    <div\n                      class=\"pfd-custom-notice\"\n                      style=\"display: {% if show_custom_notice %}block{% else %}none{% endif %};\"\n                    >\n                      <div class=\"pfd-custom-notice-content\">\n                        <svg\n                          class=\"pfd-custom-notice-icon\"\n                          xmlns=\"http://www.w3.org/2000/svg\"\n                          width=\"24\"\n                          height=\"24\"\n                          viewBox=\"0 0 24 24\"\n                          fill=\"none\"\n                          stroke=\"currentColor\"\n                          stroke-width=\"2\"\n                          stroke-linecap=\"round\"\n                          stroke-linejoin=\"round\"\n                        >\n                          <circle cx=\"12\" cy=\"12\" r=\"10\"></circle>\n                          <polyline points=\"12 6 12 12 16 14\"></polyline>\n                        </svg>\n                        <p class=\"pfd-custom-notice-text\">\n                          Custom {{ option_name | downcase }}s are <strong>made to order</strong>. Please allow\n                          <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery.\n                        </p>\n                      </div>\n                    </div>\n\n                    {%- comment %} Configuration-based custom content for options {%- endcomment %}\n                    {%- comment %} Renders ALL matching option content, shows only the selected one {%- endcomment %}\n                    {%- assign option_name_lower = option_name | downcase -%}\n                    {%- assign selected_value_lower = selected_value | downcase -%}\n\n                    {%- capture all_option_info -%}\n  {%- for pair in option_content_pairs -%}\n    {%- assign pair_cleaned = pair | strip -%}\n    {%- if pair_cleaned contains '|' -%}\n      {%- assign parts = pair_cleaned | split: '|' -%}\n      {%- assign option_key_full = parts[0] | strip -%}\n      {%- assign content_value = parts[1] | strip -%}\n\n      {%- if option_key_full contains ':' -%}\n        {%- assign key_parts = option_key_full | split: ':' -%}\n        {%- assign option_key = key_parts[0] | strip | downcase -%}\n        {%- assign value_key = key_parts[1] | strip -%}\n        {%- assign value_key_lower = value_key | downcase -%}\n\n        {%- if option_name_lower == option_key -%}\n          {%- assign is_selected = false -%}\n          {%- if selected_value_lower == value_key_lower -%}\n            {%- assign is_selected = true -%}\n          {%- endif -%}\n          <div class=\"pfd-option-info-item\"\n               data-option-name=\"{{ option_name_lower }}\"\n               data-option-value=\"{{ value_key | handle }}\"\n               style=\"{% unless is_selected %}display: none;{% endunless %}\">\n            {{ content_value }}\n          </div>\n        {%- endif -%}\n      {%- endif -%}\n    {%- endif -%}\n  {%- endfor -%}\n{%- endcapture -%}\n\n                    {%- assign all_option_info_stripped = all_option_info | strip -%}\n                    {%- if all_option_info_stripped != blank -%}\n                      <div class=\"pfd-custom-option-info\" data-option-info-container=\"{{ option_name_lower }}\">\n                        {{ all_option_info }}\n                      </div>\n                    {%- endif -%}\n                  </div>\n                {%- endif -%}\n              {%- endfor -%}\n            </div>\n          {%- endif -%}\n\n          {%- liquid\n            if arr_properties.size > 0 and isProductAvailable\n              render 'frm_properties', arr_properties: arr_properties, product: product\n            endif\n          -%}\n\n          {%- if use_incoming_mess\n            and current_variant_incoming\n            and pr_variants.size == 1\n            and current_variant.next_incoming_date != blank\n          -%}\n            {%- assign format_date = current_variant.next_incoming_date | date: date_in -%}\n            {%- comment -%}<div class=\"t4s-incoming__mess\"><!-- will_not_ship_until / will_be_in_stock_after --></div>{%- endcomment -%}\n\n          {%- elsif use_incoming_mess and pr_variants.size > 1 -%}\n            {%- liquid\n              assign format_date = current_variant.next_incoming_date | date: date_in\n              unless format_date\n                assign format_date = '19041994'\n              endunless\n            -%}\n            {%- comment -%}<div data-incoming__mess class=\"t4s-incoming__mess\"><!-- will_not_ship_until / will_be_in_stock_after with incoming date --></div>{%- endcomment -%}\n\n          {%- endif -%}\n\n          {{ 'button-style.css' | asset_url | stylesheet_tag }}\n          <link\n            href=\"{{ 'custom-effect.css' | asset_url }}\"\n            rel=\"stylesheet\"\n            media=\"print\"\n            onload=\"this.media='all'\"\n          >\n\n          {{- html_price -}}\n\n          <div\n            class=\"t4s-product-form__buttons\"\n            style=\"--pr-btn-round: {{ bk_stts.pr_btn_round }}px;--wis-cp-btn-round: {{ bk_stts.wis_cp_btn_round }}px;\"\n          >\n            <div class=\"t4s-pr__qty_cart t4s-d-flex t4s-flex-wrap\">\n              {%- if isExternal -%}\n                <a\n                  href=\"{{ external_link }}\"\n                  rel=\"nofollow\"\n                  target=\"_blank\"\n                  class=\"t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ bk_stts.button_style }} t4s-btn-color-{{ bk_stts.button_color }} t4s-w-100 t4s-justify-content-center {% if bk_stts.button_style == 'default' or bk_stts.button_style == 'outline' %} t4s-btn-effect-{{ bk_stts.button_effect }}{% endif %} t4s-truncate is--btn-external t4s-btn-loading__svg\"\n                >\n                  {%- if bk_stts.btn_icon -%}\n                    <svg class=\"t4s-btn-icon\" viewBox=\"0 0 24 24\">\n                      <use xlink:href=\"#t4s-icon-atc\"></use>\n                    </svg>\n                  {%- endif -%}\n                  <span class=\"t4s-btn-atc_text\">\n                    {{- external_title -}}\n                  </span>\n                  <span class=\"t4s-loading__spinner\" hidden>\n                    <svg\n                      width=\"16\"\n                      height=\"16\"\n                      hidden\n                      class=\"t4s-svg-spinner\"\n                      focusable=\"false\"\n                      role=\"presentation\"\n                      viewBox=\"0 0 66 66\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <circle class=\"t4s-path\" fill=\"none\" stroke-width=\"6\" cx=\"33\" cy=\"33\" r=\"30\"></circle>\n                    </svg>\n                  </span>\n                </a>\n              {%- else -%}\n                {%- if bk_stts.show_qty and isProductAvailable -%}\n                  <div\n                    data-quantity-wrapper\n                    class=\"t4s-quantity-wrapper t4s-product-form__qty\"\n                  >\n                    <button\n                      data-quantity-selector\n                      data-decrease-qty\n                      type=\"button\"\n                      class=\"t4s-quantity-selector is--minus\"\n                    ></button>\n                    <input\n                      data-quantity-value\n                      type=\"number\"\n                      class=\"t4s-quantity-input\"\n                      step=\"1\"\n                      min=\"{{cus_qty}}\"\n                      max=\"{{max_qty}}\"\n                      name=\"quantity\"\n                      value=\"{{cus_qty}}\"\n                      size=\"4\"\n                      pattern=\"[0-9]*\"\n                      inputmode=\"numeric\"\n                    >\n                    <button\n                      data-quantity-selector\n                      data-increase-qty\n                      type=\"button\"\n                      class=\"t4s-quantity-selector is--plus\"\n                    ></button>\n                  </div>\n                {%- else -%}\n                  <input type=\"hidden\" name=\"quantity\" value=\"1\">\n                {%- endif -%}\n                {% if customer %}\n                  <button\n                    data-animation-atc='{ \"ani\": \"{{ bk_stts.ani }}\",\"time\": {{ bk_stts.time }}000 }'\n                    type=\"submit\"\n                    name=\"add\"\n                    data-atc-form\n                    class=\"t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ bk_stts.button_style }} t4s-btn-color-{{ bk_stts.button_color }} t4s-w-100 t4s-justify-content-center {% if bk_stts.button_style == 'default' or bk_stts.button_style == 'outline' %} t4s-btn-effect-{{ bk_stts.button_effect }}{% endif %} t4s-btn-loading__svg\"\n                    {% unless current_variant_available %}\n                      aria-disabled=\"true\"\n                    {% endunless -%}\n                    {% unless isProductAvailable %}\n                      disabled=\"disabled\"\n                    {% endunless %}\n                  >\n                    {%- if bk_stts.btn_icon -%}\n                      <svg\n                        class=\"t4s-btn-icon\"\n                        viewBox=\"0 0 24 24\"\n                      >\n                        <use xlink:href=\"#t4s-icon-atc\"></use>\n                      </svg>\n                    {%- endif -%}\n                    <span class=\"t4s-btn-atc_text\">\n                      {%- if current_variant_available == false or isProductAvailable == false -%}\n                        {{- 'products.product.sold_out' | t -}}\n                      {%- elsif isPreoder -%}\n                        {{- 'products.product.pre_order' | t }}\n                      {%- else -%}\n                        {{ 'products.product.add_to_cart' | t }}\n                      {%- endif -%}\n                    </span>\n                    <span class=\"t4s-loading__spinner\" hidden>\n                      <svg\n                        width=\"16\"\n                        height=\"16\"\n                        hidden\n                        class=\"t4s-svg-spinner\"\n                        focusable=\"false\"\n                        role=\"presentation\"\n                        viewBox=\"0 0 66 66\"\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                      >\n                        <circle class=\"t4s-path\" fill=\"none\" stroke-width=\"6\" cx=\"33\" cy=\"33\" r=\"30\"></circle>\n                      </svg>\n                    </span>\n                  </button>\n                {% else %}\n                  <a\n                    href=\"/account/login\"\n                    onclick=\"rememberPage(event)\"\n                    data-drawer-delay-\n                    data-drawer-options='{ \"id\": \"#t4s-login-sidebar\" }'\n                    class=\"atc-btn t4s-btn t4s-btn-base t4s-btn-style-default t4s-btn-color-dark t4s-w-100 t4s-justify-content-center t4s-btn-effect-sweep-to-right t4s-btn-loading__svg\"\n                  >\n                    <svg\n                      class=\"t4s-btn-icon\"\n                      viewBox=\"0 0 24 24\"\n                      style=\"margin-right:4px\"\n                    >\n                      <use xlink:href=\"#t4s-icon-atc\"></use>\n                    </svg>\n                    <span class=\"t4s-btn-atc_text\">Login to Shop</span>\n                    <span class=\"t4s-loading__spinner\" hidden=\"\">\n                      <svg\n                        width=\"16\"\n                        height=\"16\"\n                        hidden=\"\"\n                        class=\"t4s-svg-spinner\"\n                        focusable=\"false\"\n                        role=\"presentation\"\n                        viewBox=\"0 0 66 66\"\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                      >\n                        <circle class=\"t4s-path\" fill=\"none\" stroke-width=\"6\" cx=\"33\" cy=\"33\" r=\"30\"></circle>\n                      </svg>\n                    </span>\n                  </a>\n                {% endif %}\n              {%- endif -%}\n            </div>\n            {%- if PR_buy_pr and type != 'main_sticky' %}\n              {{- form | payment_button -}}\n            {% endif -%}\n            {%- if settings.use_notify_me -%}\n              {% if customer -%}\n                <button\n                  data-class=\"t4s-mfp-btn-close-inline\"\n                  data-id=\"t4s-pr-popup__notify-stock\"\n                  data-storageid=\"notify-stock{{ current_variant.id }}\"\n                  data-mfp-src\n                  data-open-mfp-ajax\n                  class=\"t4s-pr__notify-stock{% if current_variant_available or current_variant == blank %} t4s-d-none{% endif %}\"\n                  type=\"button\"\n                  data-notify-stock-btn\n                  data-variant-id=\"{{ current_variant.id }}\"\n                  data-root-url=\"{{ routes.root_url }}\"\n                >\n                  {{ 'products.notify_stock.trigger' | t }}\n                </button>\n              {%- endif %}\n            {%- endif -%}\n            {%- if bk_stts.enable_wishlist or bk_stts.enable_compare -%}\n              <div class=\"t4s-pr__wis_cp\">\n                {%- render 't4s_wis_cp', product: product, bk_stts: bk_stts, disableTooltip: true -%}\n              </div>\n            {%- endif -%}\n          </div>\n        {%- endform -%}\n        {%- unless isProductDefault or type == 'main_sticky' -%}\n          <script type=\"application/json\" class=\"pr_variants_json\">\n            {{ shsd_product_variants | json }}\n          </script>\n          <script type=\"application/json\" class=\"pr_options_json\">\n            {{ shsd_product_options_with_values | json }}\n          </script>\n        {%- endunless -%}\n        {%- if bk_stts.ani != 'none' -%}\n          <link\n            href=\"{{ 'ani-atc.min.css' | asset_url }}\"\n            rel=\"stylesheet\"\n            media=\"print\"\n            onload=\"this.media='all'\"\n          >\n        {%- endif -%}\n      </div>\n    </div>\n  </div>\n\n  <script>\n    (function () {\n      'use strict';\n\n      function updateOptionInfo(container, selectedValue) {\n        var optionName = container.getAttribute('data-option-name');\n        if (!optionName) return;\n        optionName = optionName.toLowerCase();\n\n        var infoContainer = container.querySelector('[data-option-info-container=\"' + optionName + '\"]');\n        if (!infoContainer) return;\n\n        var valueHandle = selectedValue\n          .toLowerCase()\n          .replace(/\\s+/g, '-')\n          .replace(/[^a-z0-9-]/g, '');\n        var infoItems = infoContainer.querySelectorAll('.pfd-option-info-item');\n\n        infoItems.forEach(function (item) {\n          var itemValue = item.getAttribute('data-option-value');\n          item.style.display = itemValue === valueHandle ? '' : 'none';\n        });\n      }\n\n      function initOptionInfoHandler() {\n        var swatchContainers = document.querySelectorAll('[data-swatch-option]');\n\n        swatchContainers.forEach(function (container) {\n          // Method 1: MutationObserver for instant updates\n          var observer = new MutationObserver(function (mutations) {\n            mutations.forEach(function (mutation) {\n              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {\n                var target = mutation.target;\n                if (target.classList.contains('is--selected') && target.hasAttribute('data-value')) {\n                  var selectedValue = target.getAttribute('data-value');\n                  updateOptionInfo(container, selectedValue);\n                }\n              }\n            });\n          });\n\n          observer.observe(container, {\n            attributes: true,\n            subtree: true,\n            attributeFilter: ['class'],\n          });\n\n          // Method 2: Backup click handler with small delay\n          var swatchItems = container.querySelectorAll('[data-swatch-item]');\n          swatchItems.forEach(function (swatch) {\n            swatch.addEventListener('click', function () {\n              var selectedValue = this.getAttribute('data-value');\n              if (!selectedValue) return;\n              setTimeout(function () {\n                updateOptionInfo(container, selectedValue);\n              }, 10);\n            });\n          });\n        });\n      }\n\n      if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', initOptionInfoHandler);\n      } else {\n        initOptionInfoHandler();\n      }\n\n      document.addEventListener('shopify:section:load', initOptionInfoHandler);\n    })();\n  </script>\n</div>\n{%- if PR_buy_pr and current_variant_available != true and type != 'main_sticky' -%}\n  <style>\n    #t4s-callBackVariant{{ product_form_id }} .shopify-payment-button { display: none;}\n  </style>\n{% endif -%}\n",
              "reasoning": "Inject the full color option names array (get_color) so JS isColorOption() uses the same set as Liquid, matching store-level custom color option names beyond just \"color\"/\"colour\"."
            },
            "result": "(no result received)",
            "isError": true,
            "elapsedMs": 0
          },
          {
            "name": "edit_lines",
            "id": "toolu_01F9WCHNDwhDkJksfJnCFueb",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "startLine": 132,
              "endLine": 135,
              "newContent": "<script>\n  window.__CUSTOM_OPTION_NAMES__ = {{ custom_option_names | json }};\n  window.__LENGTH_OPTION_INDEX__ = {{ length_option_position | minus: 1 }};\n  window.__COLOR_OPTION_NAMES__ = {{ get_color | json }};\n</script>\n",
              "reasoning": "Inject the full color option names array (get_color) so JS isColorOption() uses the same set as Liquid, matching store-level custom color option names beyond just \"color\"/\"colour\"."
            },
            "result": "(no result received)",
            "isError": true,
            "elapsedMs": 0
          }
        ],
        "reasoningBlocks": [],
        "responseText": "",
        "outcome": {
          "status": "applied",
          "changedFiles": 2,
          "changeSummary": "product-form-dynamic.js: Fix the broken error event listener (missing closing braces) and remove the duplicate isColorOption definition that shadowed the correct one using __COLOR_OPTION_NAMES__.\nproduct-form-dynamic.liquid: Inject the full color option names array (get_color) so JS isColorOption() uses the same set as Liquid, matching store-level custom color option names beyond just \"color\"/\"colour\".",
          "validationIssues": [
            {
              "gate": "syntax",
              "errors": [
                "templates/page.ecom-deadfest2025.json:0 — Invalid JSON in template file",
                "templates/article.portfolio.json:0 — Invalid JSON in template file",
                "templates/page.ecom-deaducation-live-phoenix.json:0 — Invalid JSON in template file",
                "templates/index.ecom-preview-home.json:0 — Invalid JSON in template file",
                "templates/index.ecom-preview-page.json:0 — Invalid JSON in template file"
              ],
              "changesKept": true
            },
            {
              "gate": "theme_check",
              "errors": [
                "templates/page.ecom-deadfest2025.json — Invalid JSON in template file",
                "templates/article.portfolio.json — Invalid JSON in template file",
                "templates/page.ecom-deaducation-live-phoenix.json — Invalid JSON in template file",
                "templates/index.ecom-preview-home.json — Invalid JSON in template file",
                "templates/index.ecom-preview-page.json — Invalid JSON in template file"
              ],
              "changesKept": true
            }
          ]
        },
        "metrics": {
          "totalToolCalls": 23,
          "editToolCalls": 4,
          "readToolCalls": 17,
          "searchToolCalls": 0,
          "elapsedMs": 162258,
          "costCents": 151,
          "inputTokens": 483747,
          "outputTokens": 3578
        }
      },
      "analysis": {
        "diagnosis": {
          "summary": "Agent successfully identified the root issues (broken error listener and duplicate isColorOption definition in JS; missing color option names array injection in Liquid) but failed to apply edits. Despite 23 tool calls (4 edits, 17 reads, 0 searches), only 2 files were changed with no evidence of actual code modifications. The agent reached the correct diagnosis but the edit execution layer collapsed, returning no results on tool calls 20-23 (propose_code_edit and edit_lines both errored).",
          "rootCause": "Tool executor (lib/agents/tools/v2-tool-executor.ts) or edit_lines handler failed silently or returned error responses that were not properly surfaced. The coordinator continued iteration despite [ERROR] responses on critical edit operations, indicating missing validation gates for edit success. No error details were captured in reasoning blocks.",
          "agentBehavior": "Agent correctly performed reconnaissance (17 read_lines calls across 3 files), diagnosed the issue accurately (duplicate variable shadowing, missing braces, missing data injection), but failed at the execution phase. Calls 20-23 show edit attempts that returned no result, yet the agent did not escalate, retry with different strategy, or request clarification. The 'Actual outcome: applied (2 files changed)' suggests partial success outside the transcript (possibly from a fallback or manual intervention), but the transcript shows 0 successful edits in the tool sequence."
        },
        "recommendations": [
          {
            "priority": "critical",
            "category": "tools",
            "title": "Add error handling and result validation in edit_lines tool executor",
            "description": "The edit_lines and propose_code_edit tools are returning [ERROR] with no result data. The tool executor must validate edit responses, capture error details, and propagate them to the coordinator. Currently, failed edits are silently dropped.",
            "targetFile": "lib/agents/tools/v2-tool-executor.ts",
            "targetArea": "edit_lines and propose_code_edit execution handlers",
            "suggestedChange": "Wrap edit tool calls in try-catch, validate response.success === true, log detailed error messages (file path, line range, error reason), and return structured error objects with retry hints. Add assertion that edit operations must return { success: true, appliedLines: number[] } or throw with context."
          },
          {
            "priority": "critical",
            "category": "coordinator",
            "title": "Add validation gate for edit tool success in main loop",
            "description": "The coordinator must detect failed edits and halt iteration or escalate. Currently, [ERROR] responses are logged but iteration continues, leading to incomplete task execution.",
            "targetFile": "lib/agents/coordinator-v2.ts",
            "targetArea": "Main think-tool-observe loop, observation phase after tool execution",
            "suggestedChange": "After each tool execution, check if tool.type in ['edit_lines', 'propose_code_edit'] and result.success !== true. If edit failed, either: (1) escalate to run_review for validation, (2) break iteration with error state, or (3) log as stagnation trigger. Do not continue iteration with unvalidated failed edits."
          },
          {
            "priority": "high",
            "category": "tools",
            "title": "Ensure edit_lines tool includes full file path resolution",
            "description": "Tool calls 20-23 show filePath inconsistencies: 'product-form-dynamic.js' vs 'assets/product-form-dynamic.js', 'product-form-dynamic.liquid' vs 'snippets/product-form-dynamic.liquid'. The tool executor may be failing to resolve partial paths.",
            "targetFile": "lib/agents/tools/v2-tool-executor.ts",
            "targetArea": "edit_lines path normalization and file lookup",
            "suggestedChange": "Before executing edit_lines, normalize filePath: if path does not start with 'assets/', 'snippets/', 'sections/', etc., check theme-map cache (lib/agents/theme-map/lookup.ts) for full path. Reject edit with clear error if path is ambiguous or file not found."
          },
          {
            "priority": "high",
            "category": "context",
            "title": "Preload and inject color option names array into Liquid context",
            "description": "The agent correctly identified that get_color array must be injected into Liquid template so JS can access __COLOR_OPTION_NAMES__. This requires context preparation before agent execution.",
            "targetFile": "lib/agents/scout/structural-scout.ts",
            "targetArea": "Brief generation for Liquid/JS sync tasks",
            "suggestedChange": "When scout detects a task involving both Liquid and JS color/variant handling, query theme-map for custom_field definitions and color option names. Inject a 'Sync Note' into brief: 'Color option names: [list]. Ensure Liquid injects this array as window.__COLOR_OPTION_NAMES__ or data attribute for JS consumption.'"
          },
          {
            "priority": "high",
            "category": "prompt",
            "title": "Enhance PM prompt with multi-file sync requirements and validation checklist",
            "description": "The agent diagnosed the issue but lacked explicit guidance on how to validate cross-file consistency (Liquid injecting data → JS consuming it). The PM prompt should include a pre-edit checklist for multi-layer tasks.",
            "targetFile": "lib/agents/prompts/v2-pm-prompt.ts",
            "targetArea": "Tool instructions section, edit_lines guidance",
            "suggestedChange": "Add section: 'For multi-layer tasks (Liquid + CSS + JS), before editing: (1) Verify all three files are in scope, (2) Map data flow (where data originates, where it's consumed), (3) Identify sync points (e.g., Liquid injects array, JS reads it), (4) After each edit, validate syntax with check_lint, (5) If any edit fails, use run_review to diagnose before retry.'"
          },
          {
            "priority": "medium",
            "category": "coordinator",
            "title": "Implement stagnation detection for repeated failed edits",
            "description": "If the same file is targeted for edit 2+ times with failures, the coordinator should detect stagnation and trigger escalation (run_review or strategy pivot).",
            "targetFile": "lib/agents/coordinator-v2.ts",
            "targetArea": "Stagnation detection logic",
            "suggestedChange": "Track failed edit attempts per file in iteration state. If file X fails edit twice, mark as stagnation and either: (1) call run_review(file=X, context=last_edit_reasoning), (2) switch to HYBRID strategy with specialist review, or (3) request clarification from user."
          },
          {
            "priority": "medium",
            "category": "validation",
            "title": "Add post-edit lint validation for JS and Liquid files",
            "description": "Tool calls 17-18 show check_lint was called but results not shown. Lint should be mandatory after every edit to catch syntax errors (e.g., missing braces) before iteration continues.",
            "targetFile": "lib/agents/orchestration-policy.ts",
            "targetArea": "Context gates and post-edit validation rules",
            "suggestedChange": "Add rule: after edit_lines on .js or .liquid file, automatically call check_lint. If lint fails, block iteration and require fix or escalation. Surface lint errors in observation block so agent can reason about them."
          },
          {
            "priority": "medium",
            "category": "tools",
            "title": "Capture and surface tool error details in coordinator observation",
            "description": "Tool calls 20-23 show [ERROR] with no diagnostic info. The coordinator's observe phase must extract error reasons from tool responses and include them in reasoning.",
            "targetFile": "lib/agents/coordinator-v2.ts",
            "targetArea": "Observation phase, error handling",
            "suggestedChange": "When tool returns error response, extract error.reason, error.details, error.suggestion from response. Include in observation block: 'Tool [name] failed: [reason]. Suggestion: [suggestion].' This enables agent to reason about why edit failed and adapt strategy."
          }
        ]
      }
    }
  ],
  "summary": {
    "passRate": "1/1 (100%)",
    "avgToolCalls": 23,
    "avgTimeSeconds": 162,
    "totalCostCents": 151,
    "failureReasons": []
  },
  "aggregateAnalysis": {
    "diagnosis": {
      "summary": "Single successful run (1/1) with 100% pass rate. Agent applied changes to 2 files using 23 tools over 162 seconds. However, 4 tool invocations (2x propose_code_edit, 2x edit_lines) reported '(no result received)' errors, indicating communication or response handling issues despite task completion.",
      "rootCause": "Tool executor or response parsing layer intermittently fails to return results from propose_code_edit and edit_lines operations, even when the underlying operations may succeed. This suggests either: (1) async/await handling in tool executor missing result capture, (2) response serialization/deserialization mismatch, or (3) timeout on result collection without fallback.",
      "agentBehavior": "Agent demonstrates correct strategic behavior: extensive file reading (16 read_lines calls) to understand context, followed by linting checks, then code proposals and edits. Despite tool result errors, agent continued iteration and ultimately applied changes successfully, suggesting error handling allows graceful degradation but masks underlying reliability issues."
    },
    "patterns": {
      "consistentFailureMode": null,
      "intermittentIssues": [
        "propose_code_edit returns '(no result received)' intermittently (2 instances in single run)",
        "edit_lines returns '(no result received)' intermittently (2 instances in single run)",
        "Tool result loss does not block task completion, masking severity"
      ],
      "toolUsageAntiPatterns": [
        "16 sequential read_lines calls on same/related files suggests inefficient file exploration strategy; could consolidate with grep_content or scout briefing",
        "check_lint called twice in sequence without intervening edits; suggests uncertainty about file state",
        "propose_code_edit → (no result) → edit_lines → (no result) → likely retry loop indicates agent attempting recovery without visibility into root cause"
      ],
      "contextGaps": [
        "product metafield structure (custom_values) not confirmed via read_lines before proposing data handling logic",
        "variant option1 schema not explicitly validated before proposing JavaScript implementation",
        "CSS contrast requirements not validated against existing theme color palette before styling proposal"
      ]
    },
    "recommendations": [
      {
        "priority": "critical",
        "category": "tools",
        "title": "Fix tool executor result handling for propose_code_edit and edit_lines",
        "description": "Implement robust result capture in v2-tool-executor.ts for run_specialist invocations. Ensure all Promise chains properly await and capture responses. Add explicit error logging distinguishing 'no result received' (network/timeout) from 'result is null' (tool rejection). Implement timeout with fallback and retry logic.",
        "targetFile": "lib/agents/tools/v2-tool-executor.ts",
        "targetArea": "run_specialist function, Promise handling for propose_code_edit and edit_lines",
        "suggestedChange": "Wrap specialist tool calls in try-catch with explicit result validation. Log response status before returning. Add configurable timeout (default 30s) with exponential backoff retry (max 2 attempts). Return { success: bool, result: any, error?: string } tuple."
      },
      {
        "priority": "high",
        "category": "context",
        "title": "Add pre-execution validation gates for multi-layer changes",
        "description": "For complex tasks requiring Liquid + CSS + JS coordination, add orchestration policy gates that validate key structural assumptions before tool execution begins. Read and cache: (1) product metafield schema, (2) variant option structure, (3) theme color/contrast rules. Store in context for tool access.",
        "targetFile": "lib/agents/orchestration-policy.ts",
        "targetArea": "Context gate validation for HYBRID/GOD_MODE strategies",
        "suggestedChange": "Add pre-flight validation function that runs before iteration loop. For product form tasks, enforce: read_lines on product metafield definitions, read_lines on variant schema, grep_content for existing contrast handling. Populate context['validatedAssumptions'] before PM begins."
      },
      {
        "priority": "high",
        "category": "prompt",
        "title": "Enhance PM prompt with explicit result validation instructions",
        "description": "PM prompt should instruct agent to verify tool result receipt and explicitly handle '(no result received)' errors. Add decision tree: if propose_code_edit returns no result, either retry or use read_lines + manual instruction to edit_lines. Reduce reliance on implicit recovery.",
        "targetFile": "lib/agents/prompts/v2-pm-prompt.ts",
        "targetArea": "Tool usage instructions, error handling guidance",
        "suggestedChange": "Add section: 'If a tool returns (no result received), you must: (1) log the error explicitly, (2) verify file state with read_lines, (3) either retry the tool or use alternative approach (e.g., direct edit_lines with full content). Do not assume success if result is missing.'"
      },
      {
        "priority": "high",
        "category": "coordinator",
        "title": "Implement stagnation detection for repeated tool errors",
        "description": "Coordinator should track consecutive tool result failures. If same tool (propose_code_edit, edit_lines) fails 3+ times in succession, escalate: switch strategy, invoke get_second_opinion, or fail fast with diagnostic output. Currently agent masks failures and continues.",
        "targetFile": "lib/agents/coordinator-v2.ts",
        "targetArea": "Iteration loop, error aggregation, stagnation detection",
        "suggestedChange": "Add errorHistory: Map<toolName, number> tracking consecutive failures. If count >= 3, break loop and return { status: 'stagnant', tool: name, suggestions: [...] }. Log diagnostic to help identify whether issue is tool executor, model, or context."
      },
      {
        "priority": "medium",
        "category": "tools",
        "title": "Consolidate redundant file reads with grep or scout briefing",
        "description": "16 read_lines calls in single run suggests inefficient exploration. Enhance scout to provide initial brief of file structure (line ranges for key sections: Liquid templates, CSS rules, JS handlers). Use grep_content to locate specific patterns (e.g., 'Awaiting Restock', 'custom_values') before reading entire files.",
        "targetFile": "lib/agents/scout/structural-scout.ts",
        "targetArea": "Scout brief generation for multi-file tasks",
        "suggestedChange": "For tasks with 3+ target files, scout should return: { files: [...], keyPatterns: [{ pattern, files, lineRanges }], suggestedReadOrder: [...] }. PM uses this to issue targeted read_lines calls instead of sequential full-file reads."
      },
      {
        "priority": "medium",
        "category": "validation",
        "title": "Add post-execution validation for multi-layer consistency",
        "description": "After edits to Liquid, CSS, and JS, run validation to ensure: (1) Liquid references match CSS class names, (2) JS data keys match Liquid data attributes, (3) CSS selectors target correct DOM elements. Currently no cross-layer validation occurs.",
        "targetFile": "lib/agents/orchestration-policy.ts",
        "targetArea": "Post-execution validation gates",
        "suggestedChange": "Add validateMultiLayerConsistency() that runs after all edits complete. Use grep_content to cross-reference: Liquid class names in CSS, JS event handlers in Liquid attributes, CSS selectors in DOM. Return inconsistencies to agent for remediation."
      },
      {
        "priority": "medium",
        "category": "context",
        "title": "Cache and reuse file content across multiple read operations",
        "description": "Coordinator should maintain a file content cache populated on first read_lines call. Subsequent reads from same file should return cached content (with option to refresh). Reduces redundant tool calls and improves iteration speed.",
        "targetFile": "lib/agents/coordinator-v2.ts",
        "targetArea": "Context management, file cache initialization",
        "suggestedChange": "Add context['fileCache']: Map<path, { content, lineCount, lastRead }> initialized at loop start. read_lines tool checks cache before executing; PM can request cache refresh with flag. Populate cache during scout phase."
      }
    ]
  }
}