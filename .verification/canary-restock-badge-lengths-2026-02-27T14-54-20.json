{
  "timestamp": "2026-02-27T14:54:20.271Z",
  "projectId": "838e7498-6dc5-4268-9fcd-e6f6148f65ad",
  "scenario": "restock-badge-lengths",
  "prompt": "On the product page template, update product-form-dynamic so out-of-stock color swatches with \"Awaiting Restock\" also show a second line listing available longer lengths for that color. Implement all three layers in one pass: (1) Liquid markup in snippets/product-form-dynamic.liquid, (2) styling in assets/product-form-dynamic.css, and (3) behavior/data handling in assets/product-form-dynamic.js. The length list must come from variant option1 availability and must exclude any lengths present in the product metafield list custom_values. Ensure text contrast is background-aware over swatch images.",
  "totalRuns": 1,
  "results": [
    {
      "run": 1,
      "passed": true,
      "reason": "Applied required files (3/3) in 20 tool calls",
      "metrics": {
        "totalToolCalls": 20,
        "editToolCalls": 2,
        "readToolCalls": 18,
        "searchToolCalls": 0,
        "elapsedMs": 149842,
        "costCents": 0,
        "inputTokens": 0,
        "outputTokens": 0
      },
      "tier": "COMPLEX",
      "strategy": "GOD_MODE",
      "changedFiles": [
        "snippets/product-form-dynamic.liquid",
        "assets/product-form-dynamic.js",
        "assets/product-form-dynamic.css",
        "product-form-dynamic.liquid"
      ],
      "transcript": {
        "runId": "run-1",
        "scenario": "restock-badge-lengths",
        "decisions": [
          {
            "phase": "analyzing",
            "label": "Loading context...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Context ready",
            "detail": "606 files, 5 prefs",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Building context...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Classifying request...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Preparing file context...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Building structural brief...",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Starting agent...",
            "timestamp": 0
          },
          {
            "phase": "strategy",
            "label": "Strategy: GOD_MODE",
            "detail": "strategy=GOD_MODE, tier=COMPLEX",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "COMPLEX tier — GOD_MODE strategy — claude-sonnet-4-6",
            "detail": "routingTier=COMPLEX, strategy=GOD_MODE",
            "timestamp": 0
          },
          {
            "phase": "analyzing",
            "label": "Style profile loaded",
            "detail": "styleProfileRules=8, designTokenCount=0, patternConflictResolutions=0, referenceSectionsLoaded=0, cssPreloaded=false, snippetConsumers=0",
            "timestamp": 0
          }
        ],
        "toolSequence": [
          {
            "name": "read_lines",
            "id": "toolu_01BC4o4PgCNdRcw8pZuZ54xe",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 1,
                  "endLine": 80
                }
              ]
            },
            "result": "--- product-form-dynamic.liquid lines 1-82 ---\n    1| {% comment %} Custom options configuration - options listed here will render as dropdowns {% endcomment %}\n    2| {% assign custom_option_names = product.metafields.custom.custom_values.value %}\n    3| \n    4| {% comment %} Custom content configuration for specific options {% endcomment %}\n    5| {% comment %} Format: option_name:option_value|<html content> - separated by semicolons for multiple {% endcomment %}\n    6| \n    7| {% assign option_content_config = 'texture:Straight|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our straight texture has slight natural wave texture to it when washed and dried. It is not pin straight hair, nor is that desirable among most clientele.</span></div>;texture:Natural Wave|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our natural wave texture features soft, beachy waves that blend seamlessly with most natural hair textures. Low maintenance and versatile for everyday styling.</span></div>;texture:Loose Curl|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our loose curl texture offers bouncy, defined curls that hold their shape beautifully. Perfect for adding volume and movement with minimal styling required.</span></div>;texture:Tight Curl|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our tight curl texture provides well-defined, springy curls with maximum volume. Ideal for protective styles and blending with naturally curly hair.</span></div>' %}\n    8| \n    9| {% assign option_content_pairs = option_content_config | split: ';' %}\n   10| \n   11| {% comment %} SellersDash collect child product details {% endcomment %}\n   12| {% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}\n   13| {% if shsd_product_details.product_type == 'shsd_parent' %}\n   14|   {% assign shsd\n... [truncated 3655 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_019tP8SThXiYzWHG6S2gcQPU",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1,
                  "endLine": 80
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1-82 ---\n    1| (() => {\n    2|   /*\n    3|    * Product Form Dynamic (PFD) - Unique Class Names:\n    4|    * - .pfd-variant-images (container for variant image data)\n    5|    * - .pfd-main-imgs (main images container)\n    6|    * - .pfd-thumb-imgs (thumbnail images container)\n    7|    * - .pfd-img-listing (individual variant image listing)\n    8|    * - .pfd-media-item (main image item)\n    9|    * - .pfd-media-thumb (thumbnail item)\n   10|    * - .pfd-img (thumbnail background image div)\n   11|    * - data-pfd-variant-id (variant ID attribute)\n   12|    * - .pfd-split-selection (split selection container)\n   13|    * - .pfd-standard-options (standard swatch options)\n   14|    * - .pfd-custom-options (custom dropdown options)\n   15|    * - .pfd-custom-dropdown (custom dropdown button)\n   16|    */\n   17| \n   18|   // Get custom option names from metafield (passed from Liquid)\n   19|   const CUSTOM_OPTION_NAMES = window.__CUSTOM_OPTION_NAMES__ || [];\n   20| \n   21|   function isCustomOption(optionValue) {\n   22|     // Handle both cleaned (quotes removed) and uncleaned values\n   23|     const cleanedOptionValue = optionValue.replace(/\"/g, \"\");\n   24|     return CUSTOM_OPTION_NAMES.some((customName) => {\n   25|       const cleanedCustomName = customName.replace(/\"/g, \"\");\n   26|       return (\n   27|         optionValue.toLowerCase().includes(customName.toLowerCase()) ||\n   28|         cleanedOptionValue\n   29|           .toLowerCase()\n   30|           .includes(cleanedCustomName.toLowerCase())\n   31|       );\n   32|     });\n   33|   }\n   34| \n   35|   // Check if ANY currently selected option is a custom option\n   36|   // Note: selectedValues is defined later, so this function is used after initialization\n   37|   function hasCustomOptionSelected(selectedValuesArray) {\n   38|     for (const val of selectedValuesArray) {\n   39|       if (val && isCustomOption(val)) {\n   40|         return true;\n   41|       }\n   42|     }\n   43|  \n... [truncated 1519 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01978pd8CUFLsW33ZC2bexgx",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 80,
                  "endLine": 280
                }
              ]
            },
            "result": "--- product-form-dynamic.liquid lines 78-282 ---\n   78|     assign class_frm = class_frm | append: ' is--atc-sticky'\n   79|   endif\n   80| \n   81|   assign color_swatch = 'disabled-'\n   82|   assign color_mode = bk_stts.color_mode\n   83|   assign selector_mode = bk_stts.selector_mode\n   84|   assign stt_color_ck = settings.color_ck | default: ';'\n   85|   assign color_ck = stt_color_ck | append: ',color,colors,couleur,colour' | remove: ';,'\n   86|   assign get_color = color_ck | downcase | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | uniq\n   87|   assign color_mode_list = 'color, color is-sw-cl__round, color is-sw-cl__round is-sw-cl__label, variant_image, variant_image is-sw-cl__round, variant_image is-sw-cl__round is-sw-cl__label' | split: ', '\n   88|   if color_mode_list contains color_mode\n   89|     assign color_swatch = 'is-sw__color '\n   90|   endif\n   91|   assign current_variant_available = current_variant.available\n   92|   assign use_incoming_mess = settings.use_incoming_mess\n   93|   assign current_variant_incoming = false\n   94|   assign current_inventory_quantity = current_variant.inventory_quantity\n   95|   if current_inventory_quantity <= 0 and current_variant.inventory_management == 'shopify' and current_variant.incoming\n   96|     assign current_variant_incoming = true\n   97|   endif\n   98|   if pos_sizeg == '1'\n   99|     assign html_sizeg = ''\n  100|   endif\n  101|   if current_variant.inventory_management != null and current_inventory_quantity > 0 and current_variant.inventory_policy != 'continue'\n  102|     assign max_qty = current_inventory_quantity\n  103|   else\n  104|     assign max_qty = 9999\n  105|   endif\n  106|   if color_mode contains 'color' or color_mode contains 'variant'\n  107|     assign show_tooltip = ''\n  108|   else\n  109|     assign show_tooltip = '-off'\n  110|   endif\n  111| -%}\n  112| \n  113| {%- if product.metafields.custom.default_variant.value -%}\n  114|   <script>\n  115|     window.__HAS_SELECTED__ = {{ product.s\n... [truncated 9359 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_019EBm2QATUeBVHL3p5hr9A2",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 80,
                  "endLine": 300
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 78-302 ---\n   78|     const optionIndex = Number(optEl.getAttribute(\"data-id\"));\n   79|     if (Number.isNaN(optionIndex)) return;\n   80| \n   81|     // Handle split selection - clear selections from both standard and custom areas\n   82|     if (optEl.classList.contains(\"pfd-split-option\")) {\n   83|       optEl\n   84|         .querySelectorAll(\"[data-swatch-item].is--selected\")\n   85|         .forEach((el) => el.classList?.remove(\"is--selected\"));\n   86| \n   87|       // Update custom dropdown text if selecting a standard option\n   88|       const value = swatchItem.getAttribute(\"data-value\") || \"\";\n   89| \n   90|       // Check if this swatch item is from the custom options area\n   91|       const isFromCustomDropdown = swatchItem.closest(\".pfd-custom-options\");\n   92| \n   93|       if (!isFromCustomDropdown) {\n   94|         // Reset custom dropdown to default state when selecting standard option\n   95|         const customDropdown = optEl.querySelector(\n   96|           \".pfd-custom-dropdown [data-current-value]\",\n   97|         );\n   98|         if (customDropdown) {\n   99|           const optionName = optEl.getAttribute(\"data-option-name\") || \"\";\n  100|           customDropdown.textContent = `Custom ${optionName.toLowerCase()}`;\n  101|         }\n  102| \n  103|         // Hide custom notice when standard option is selected\n  104|         const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n  105|         if (customNotice) {\n  106|           customNotice.style.display = \"none\";\n  107|         }\n  108| \n  109|         // Remove active state from dropdown button when standard option is selected\n  110|         const dropdownButton = optEl.querySelector(\".pfd-custom-dropdown\");\n  111|         if (dropdownButton) {\n  112|           dropdownButton.classList.remove(\"is--selected\");\n  113|         }\n  114|       }\n  115|     } else {\n  116|       // Standard handling for non-split options\n  117|       optEl\n  118|         .que\n... [truncated 8279 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01JEL5XvMmFFep1675Kt1wvu",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 280,
                  "endLine": 520
                }
              ]
            },
            "result": "--- product-form-dynamic.liquid lines 278-522 ---\n  278|                   {%- capture color_nicknames_map -%}\n  279|                     {%- for variant in shsd_product_variants -%}\n  280|                       {%- if variant.metafields.custom.variant_color != blank -%}\n  281|                         {%- for opt_index in (1..3) -%}\n  282|                           {%- assign opt_key = 'option' | append: opt_index -%}\n  283|                           {%- assign opt_val = variant[opt_key] -%}\n  284|                           {%- if opt_val != blank -%}\n  285|                             {%- comment %} Use color_option_position (reordered) instead of product.options lookup {%- endcomment -%}\n  286|                             {%- if opt_index == color_option_position -%}\n  287|                               {{ opt_val | handle }}:{{ variant.metafields.custom.variant_color }};\n  288|                             {%- endif -%}\n  289|                           {%- endif -%}\n  290|                         {%- endfor -%}\n  291|                       {%- endif -%}\n  292|                     {%- endfor -%}\n  293|                   {%- endcapture -%}\n  294|                   {%- assign color_nicknames_map = color_nicknames_map | strip -%}\n  295| \n  296|                   <div\n  297|                     data-swatch-option\n  298|                     data-option-name=\"{{ option_name | escape }}\"\n  299|                     data-id=\"{{ forloop.index0 }}\"\n  300|                     data-option-unit=\"\n  301|                       {%- liquid\n  302|                         assign option_unit = ''\n  303|                         if se_stts and se_stts.option_units and se_stts.option_units != blank\n  304|                           assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n  305|                           for pair in option_units_raw\n  306|                             assign pair_cleaned = pair | strip\n  307|                             if pai\n... [truncated 15753 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01TxsK58dVUtHgnEf7cwG2F8",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 300,
                  "endLine": 600
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 298-602 ---\n  298|           \"']\",\n  299|       ).html();\n  300|       var data_var_img = $(\n  301|         \".pfd-variant-images .pfd-main-imgs .pfd-img-listing[data-pfd-variant-id='\" +\n  302|           sel_var_id +\n  303|           \"']\",\n  304|       ).attr(\"data-var-img\");\n  305| \n  306|       // Check if we have variant images or just a single image\n  307|       var mediaItemCount = 0;\n  308|       if (sel_images && sel_images.trim() !== \"\") {\n  309|         mediaItemCount = $(sel_images).filter(\".pfd-media-item\").length;\n  310|       }\n  311| \n  312|       var hasMultipleImages = mediaItemCount > 1;\n  313| \n  314|       if (!hasMultipleImages) {\n  315|         // Show single image or fallback\n  316|         $(\".t4s-product__media-wrapper .slider_sec_main\")\n  317|           .show()\n  318|           .css(\"opacity\", \"1\");\n  319|         if (data_var_img) {\n  320|           $(\".slider_sec_main\").html(\"<img src='\" + data_var_img + \"' />\");\n  321|         }\n  322|         $(\".slick_gallery\").hide();\n  323|       } else {\n  324|         // Show gallery with multiple images\n  325|         $(\".slick_gallery\").css(\"opacity\", \"0\");\n  326|         $(\".t4s-product__media-wrapper .slider_sec_main\").hide();\n  327|         $(\".slick_gallery\").show();\n  328|         $(\n  329|           \".t4s-product__media-wrapper .t4s-col-thumb .t4s-carousel__nav\",\n  330|         ).hide();\n  331|         $(\".t4s-product__media-wrapper .slick_gallery .slider_for\").html(\n  332|           sel_images,\n  333|         );\n  334|         $(\".t4s-product__media-wrapper .slick_gallery .slider_nav\").html(\n  335|           sel_thumb_img,\n  336|         );\n  337|         $(\".slick-initialized\").removeClass(\"slick-initialized\");\n  338|         $(\".slick-slider\").removeClass(\"slick-slider\");\n  339|         $(\".slick-vertical\").removeClass(\"slick-vertical\");\n  340| \n  341|         var s = document.createElement(\"script\");\n  342|         s.type = \"text/javascript\";\n  343|      \n... [truncated 10080 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01LEEFvpr9tot6cL9EjFXsiT",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 520,
                  "endLine": 750
                }
              ]
            },
            "result": "--- product-form-dynamic.liquid lines 518-752 ---\n  518|                                       {%- assign matches_color = true -%}\n  519|                                     {%- endif -%}\n  520|                                   {%- else -%}\n  521|                                     {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment -%}\n  522|                                     {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}\n  523|                                     {%- if current_selected_val != blank -%}\n  524|                                       {%- assign current_selected_handle = current_selected_val | handle -%}\n  525|                                       {%- unless variant_opt_handle == current_selected_handle -%}\n  526|                                         {%- assign matches_other_options = false -%}\n  527|                                       {%- endunless -%}\n  528|                                     {%- endif -%}\n  529|                                   {%- endif -%}\n  530|                                 {%- endif -%}\n  531|                               {%- endfor -%}\n  532| \n  533|                               {%- if matches_color and matches_other_options and variant.available -%}\n  534|                                 {%- assign color_is_available = true -%}\n  535|                                 {%- break -%}\n  536|                               {%- endif -%}\n  537|                             {%- endfor -%}\n  538| \n  539|                             {%- comment %} Compute available standard lengths for this color {%- endcomment -%}\n  540|                             {%- assign avail_lengths = '' -%}\n  541|                             {%- assign avail_lengths_seen = '' -%}\n  542|                             {%- assign length_opt_key = 'option' | append: length_option_position -%}\n  543|                             {%- if length_option_position >\n... [truncated 12888 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01WrBwnB3rvxAvcZePRdbLMm",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 600,
                  "endLine": 900
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 598-902 ---\n  598|       imageUrl: imageUrl,\n  599|       variantImages: imageUrl ? [imageUrl] : [],\n  600|     });\n  601|   }\n  602| \n  603|   function getSelectedFromDOM() {\n  604|     const values = Array(optionCount).fill(\"\");\n  605|     for (const optEl of getSwatchOptions()) {\n  606|       const idx = Number(optEl.getAttribute(\"data-id\"));\n  607|       if (Number.isNaN(idx)) continue;\n  608| \n  609|       const selectedItem = optEl.querySelector(\n  610|         \"[data-swatch-item].is--selected\",\n  611|       );\n  612|       if (selectedItem)\n  613|         values[idx] = normVal(selectedItem.getAttribute(\"data-value\") || \"\");\n  614|     }\n  615|     return values;\n  616|   }\n  617| \n  618|   function resolveVariantId(values) {\n  619|     return idByKey.get(keyFromValues(values));\n  620|   }\n  621| \n  622|   // IMPORTANT: do NOT dispatch change unless variant truly changed\n  623|   let lastAppliedVariantId = null;\n  624|   function applyVariantToSelect(variantId) {\n  625|     if (!variantId) return;\n  626|     const nextId = String(variantId);\n  627|     if (lastAppliedVariantId === nextId) return;\n  628| \n  629|     lastAppliedVariantId = nextId;\n  630|     selectEl.value = nextId;\n  631| \n  632|     // Ensure DOM exists for this variant before theme processes it\n  633|     ensureDOMForVariant(nextId);\n  634| \n  635|     // Let theme update its own UI\n  636|     selectEl.dispatchEvent(new Event(\"change\", { bubbles: true }));\n  637|   }\n  638| \n  639|   // Progressive prefix matching for availability\n  640|   function variantMatchesPrefix(v, optionIndex) {\n  641|     for (let i = 0; i < optionIndex; i++) {\n  642|       const sel = normVal(selectedValues[i]);\n  643|       if (!sel) continue;\n  644|       if (normVal(v[`option${i + 1}`] ?? \"\") !== sel) return false;\n  645|     }\n  646|     return true;\n  647|   }\n  648| \n  649|   // Visual \"sold out marker\" handling:\n  650|   // We only toggle the visual class but keep items click\n... [truncated 10626 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_013oBRCGhvELygjsPG7kNJkx",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 900,
                  "endLine": 1100
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 898-1102 ---\n  898|     } catch (e) {\n  899|       console.error(\"[Luminance] Error analyzing image:\", e.message, \"| Image:\", img.src);\n  900|       applyLuminance(\"dark\");\n  901|     }\n  902|   };\n  903| \n  904|   if (img.complete && img.naturalWidth > 0) {\n  905|     analyze();\n  906|   } else {\n  907|     img.addEventListener(\"load\", analyze, { once: true });\n  908|     img.addEventListener(\"error\", () => {\n  909|       applyLuminance(\"dark\");\n  910|     }, { once: true });\n  911|   }\n  912| }\n  913| \n  914| // Check if an option is a Color option based on the option name.\n  915| // Primary: uses __COLOR_OPTION_INDEX__ injected by Liquid from the reordered\n  916| // shsd_product_options_with_values — the same source as pr_options_json and\n  917| // __LENGTH_OPTION_INDEX__, so all indices are consistent.\n  918| // Fallback: name-matching against __COLOR_OPTION_NAMES__ for robustness.\n  919| function isColorOption(optionIndex) {\n  920|   const explicitColorIdx = typeof window.__COLOR_OPTION_INDEX__ === \"number\"\n  921|     ? window.__COLOR_OPTION_INDEX__\n  922|     : -1;\n  923|   if (explicitColorIdx >= 0) return optionIndex === explicitColorIdx;\n  924|   const optionName = normName(options?.[optionIndex]?.name || \"\");\n  925|   const colorNames = window.__COLOR_OPTION_NAMES__ || [\"color\", \"colours\", \"couleur\", \"colour\", \"colors\"];\n  926|   return colorNames.some((n) => normName(n) === optionName);\n  927| }\n  928| \n  929| // Find variant matching current selections + given color value\n  930| function getVariantForColorValue(colorValue, currentSelection, colorIndex) {\n  931|   for (const v of variantById.values()) {\n  932|     if (!v) continue;\n  933| \n  934|     const variantColorVal = normVal(v[`option${colorIndex + 1}`] || \"\");\n  935|     if (variantColorVal !== colorValue) continue;\n  936| \n  937|     let matches = true;\n  938|     for (let i = 0; i < optionCount; i++) {\n  939|       if (i === colorIndex) continue;\n  940|       co\n... [truncated 6396 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01D55cVvaebNAzDSSd6P8HjE",
            "input": {
              "filePath": "assets/product-form-dynamic.css",
              "ranges": [
                {
                  "startLine": 680,
                  "endLine": 819
                }
              ]
            },
            "result": "--- product-form-dynamic.css lines 678-819 ---\n  678| \n  679| /* For non-image swatches (length/text options): badge on the item itself */\n  680| .t4s-swatch__item > .t4s-swatch__restock-badge {\n  681|   display: none !important;\n  682| }\n  683| \n  684| .t4s-swatch__item > .t4s-swatch__restock-badge.is-visible {\n  685|   display: block !important;\n  686| }\n  687| \n  688| /* Content-aware contrast: Light background (dark hair) = dark text */\n  689| [data-luminance=\"light\"] .t4s-swatch__restock-badge {\n  690|   background: rgba(0, 0, 0, 0.05);\n  691|   color: rgba(0, 0, 0, 0.85);\n  692|   border-color: rgba(0, 0, 0, 0.1);\n  693| }\n  694| \n  695| /* Content-aware contrast: Dark background (light hair) = light text */\n  696| [data-luminance=\"dark\"] .t4s-swatch__restock-badge {\n  697|   background: rgba(255, 255, 255, 0.05);\n  698|   color: rgba(255, 255, 255, 0.95);\n  699|   border-color: rgba(255, 255, 255, 0.15);\n  700|   text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n  701| }\n  702| \n  703| /* Subtle hover effect on out-of-stock swatches */\n  704| .t4s-swatch__btn-wrap.is--out-of-stock:hover .t4s-swatch__restock-badge,\n  705| .t4s-swatch__item.is--out-of-stock:hover .t4s-swatch__restock-badge {\n  706|   backdrop-filter: blur(12px) saturate(1.3);\n  707|   -webkit-backdrop-filter: blur(12px) saturate(1.3);\n  708|   opacity: 0.9;\n  709| }\n  710| \n  711| /* Keep full opacity on out-of-stock swatches for badge legibility */\n  712| .t4s-swatch__btn-wrap.is--out-of-stock .t4s-swatch__item,\n  713| .t4s-swatch__item.is--out-of-stock,\n  714| .t4s-swatch__btn-wrap.is--out-of-stock div[data-img-el],\n  715| .t4s-swatch__btn-wrap.is--out-of-stock div[data-img-el] img {\n  716|   opacity: 1 !important;\n  717| }\n  718| \n  719| /* ============================================\n  720|    AVAILABLE LENGTHS TEXT\n  721|    Shown below the swatch image, as a sibling in .t4s-swatch__btn-wrap\n  722|    Displayed when a color is out of stock at the selected length\n  723|    but available in other l\n... [truncated 4046 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_013K3NSo7PP6gV7KydrPXoQb",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1100,
                  "endLine": 1300
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1098-1302 ---\n 1098|       // Use the first matching variant's image (prioritizing available variants)\n 1099|       const preferredVariant =\n 1100|         matchingVariants.find((v) => v.available && v.imageUrl) ||\n 1101|         matchingVariants.find((v) => v.imageUrl);\n 1102| \n 1103|       const imgEl =\n 1104|         item.querySelector(\"[data-img-el] img\") || item.querySelector(\"img\");\n 1105|       if (imgEl) {\n 1106|         if (preferredVariant && preferredVariant.imageUrl) {\n 1107|           item.setAttribute(\"data-var-img\", preferredVariant.imageUrl);\n 1108|           setupSwatchImageLoad(imgEl, preferredVariant.imageUrl, item);\n 1109|         } else {\n 1110|           // No image available, show placeholder\n 1111|           item.classList.add(\"swatch-placeholder\");\n 1112|           imgEl.src = \"\";\n 1113|         }\n 1114|       }\n 1115|     }\n 1116|   }\n 1117| \n 1118|   function setupSwatchImageLoad(imgEl, imageUrl, swatchItem) {\n 1119|     // Add loading state\n 1120|     swatchItem.classList.add(\"swatch-loading\");\n 1121|     swatchItem.classList.remove(\n 1122|       \"swatch-loaded\",\n 1123|       \"swatch-error\",\n 1124|       \"swatch-placeholder\",\n 1125|     );\n 1126| \n 1127|     // Handle load success\n 1128|     // Handle load success — also re-run luminance so contrast is based on\n 1129|     // the actual loaded image, not the placeholder/previous state.\n 1130|     imgEl.onload = function () {\n 1131|       swatchItem.classList.remove(\"swatch-loading\", \"swatch-placeholder\");\n 1132|       swatchItem.classList.add(\"swatch-loaded\");\n 1133|       // Re-detect luminance for this swatch's image container\n 1134|       const btnWrap = swatchItem.closest(\".t4s-swatch__btn-wrap\") || swatchItem;\n 1135|       if (btnWrap.classList.contains(\"is--out-of-stock\")) {\n 1136|         const imgContainer = btnWrap.querySelector(\"[data-img-el]\");\n 1137|         if (imgContainer) {\n 1138|           luminanceCache.delete(imgEl.src);\n 1139|          \n... [truncated 7141 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_018XYFm9B3HXyfun4zETYu2w",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1300,
                  "endLine": 1500
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1298-1502 ---\n 1298| \n 1299|     const mainImgsEl = varinImagesEl.querySelector(\".pfd-main-imgs\");\n 1300|     const thumbImgsEl = varinImagesEl.querySelector(\".pfd-thumb-imgs\");\n 1301| \n 1302|     // Ensure main listing exists\n 1303|     if (mainImgsEl) {\n 1304|       let mainListing = mainImgsEl.querySelector(\n 1305|         `.pfd-img-listing[data-pfd-variant-id=\"${variantId}\"]`,\n 1306|       );\n 1307| \n 1308|       if (!mainListing) {\n 1309|         mainListing = document.createElement(\"div\");\n 1310|         mainListing.className = \"pfd-img-listing\";\n 1311|         mainListing.setAttribute(\"data-pfd-variant-id\", variantId);\n 1312|         mainListing.setAttribute(\"data-var-img\", variant.imageUrl || \"\");\n 1313|         mainImgsEl.appendChild(mainListing);\n 1314| \n 1315|         // Populate with images\n 1316|         for (const imageUrl of variant.variantImages) {\n 1317|           const mediaItem = document.createElement(\"div\");\n 1318|           mediaItem.className = \"pfd-media-item\";\n 1319|           const img = document.createElement(\"img\");\n 1320|           img.src = imageUrl;\n 1321|           mediaItem.appendChild(img);\n 1322|           mainListing.appendChild(mediaItem);\n 1323|         }\n 1324|       }\n 1325|     }\n 1326| \n 1327|     // Ensure thumb listing exists\n 1328|     if (thumbImgsEl) {\n 1329|       let thumbListing = thumbImgsEl.querySelector(\n 1330|         `.pfd-img-listing[data-pfd-variant-id=\"${variantId}\"]`,\n 1331|       );\n 1332| \n 1333|       if (!thumbListing) {\n 1334|         thumbListing = document.createElement(\"div\");\n 1335|         thumbListing.className = \"pfd-img-listing\";\n 1336|         thumbListing.setAttribute(\"data-pfd-variant-id\", variantId);\n 1337|         thumbImgsEl.appendChild(thumbListing);\n 1338| \n 1339|         // Populate with thumbnails\n 1340|         for (const imageUrl of variant.variantImages) {\n 1341|           const mediaThumb = document.createElement(\"div\");\n 1342|           mediaThumb\n... [truncated 7168 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01M92eMwfwcZLWurzbv3gGUD",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1500,
                  "endLine": 1700
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1498-1702 ---\n 1498|           );\n 1499|           selectedOption.setAttribute(\n 1500|             \"data-inventorypolicy\",\n 1501|             variant.inventoryPolicy || \"deny\",\n 1502|           );\n 1503|           selectedOption.setAttribute(\n 1504|             \"data-inventoryquantity\",\n 1505|             variant.inventoryQuantity || (variant.available ? \"999\" : \"0\"),\n 1506|           );\n 1507|         }\n 1508|       }\n 1509| \n 1510|       // Ensure DOM exists before applying variant\n 1511|       ensureDOMForVariant(variantId);\n 1512|       applyVariantToSelect(variantId);\n 1513|     }\n 1514| \n 1515|     // re-patch sold-out\n 1516|     patchAllAvailability();\n 1517|   }\n 1518| \n 1519|   // Make function available globally for our override\n 1520|   window.handlePFDSwatchClick = handlePFDSwatchClick;\n 1521| \n 1522|   // Setup split selection dropdown handlers\n 1523|   function setupSplitSelectionHandlers() {\n 1524|     document.addEventListener(\"click\", function (e) {\n 1525|       // Handle custom dropdown item selection\n 1526|       const dropdownItem = e.target.closest(\n 1527|         \"[data-swatch-item][data-dropdown-off]\",\n 1528|       );\n 1529|       if (dropdownItem && dropdownItem.closest(\".pfd-custom-options\")) {\n 1530|         e.preventDefault();\n 1531|         e.stopPropagation();\n 1532| \n 1533|         const value = dropdownItem.getAttribute(\"data-value\") || \"\";\n 1534|         const cleanedValue = getDisplayValue(value);\n 1535| \n 1536|         // Find the custom dropdown button\n 1537|         const dropdownWrapper = dropdownItem.closest(\".t4s-dropdown__wrapper\");\n 1538|         if (dropdownWrapper) {\n 1539|           const dropdownId = dropdownWrapper.id;\n 1540|           const customButton = document.querySelector(\n 1541|             `[data-pfd-dropdown-open][data-id=\"${dropdownId}\"]`,\n 1542|           );\n 1543| \n 1544|           if (customButton) {\n 1545|             // Update the dropdown button text to show the selected\n... [truncated 6851 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01NtKWwBnFy6mywYoVoHZjHK",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1700,
                  "endLine": 1850
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1698-1852 ---\n 1698|   // contrast CSS cascade fires immediately — before hydration completes.\n 1699|   (function initLuminanceForSSRSwatches() {\n 1700|     const outOfStockWraps = root.querySelectorAll(\n 1701|       \".t4s-swatch__btn-wrap.is--out-of-stock\"\n 1702|     );\n 1703|     for (const wrap of outOfStockWraps) {\n 1704|       const imgContainer = wrap.querySelector(\"[data-img-el]\");\n 1705|       if (!imgContainer) continue;\n 1706|       // Ensure badge is visible (Liquid SSR now adds is-visible, but guard\n 1707|       // against older cached HTML that may not have it yet).\n 1708|       const badge = imgContainer.querySelector(\".t4s-swatch__restock-badge\");\n 1709|       if (badge) badge.classList.add(\"is-visible\");\n 1710|       detectSwatchLuminance(imgContainer, badge);\n 1711|     }\n 1712|   })();\n 1713| \n 1714|   // Show custom notice on page load if custom option is already selected\n 1715|   setTimeout(() => {\n 1716|     const swatchOptions = document.querySelectorAll(\"[data-swatch-option]\");\n 1717|     swatchOptions.forEach((optEl) => {\n 1718|       const selectedCustomItem = optEl.querySelector(\n 1719|         \".pfd-custom-options [data-swatch-item].is--selected\",\n 1720|       );\n 1721|       const customNotice = optEl.querySelector(\".pfd-custom-notice\");\n 1722|       const customDropdownButton = optEl.querySelector(\".pfd-custom-dropdown\");\n 1723| \n 1724|       if (selectedCustomItem && customNotice) {\n 1725|         const optionName = optEl.getAttribute(\"data-option-name\") || \"item\";\n 1726|         const noticeText = customNotice.querySelector(\n 1727|           \".pfd-custom-notice-text\",\n 1728|         );\n 1729|         if (noticeText) {\n 1730|           noticeText.innerHTML = `Custom ${optionName.toLowerCase()}s are <strong>made to order</strong>. Please allow <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery.`;\n 1731|         }\n 1732|         customNotice.style.display = \"block\";\n 1733| \n 1734|    \n... [truncated 3786 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01XY9KzV6JcQ7aSs5RYvmAXw",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1850,
                  "endLine": 1980
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1848-1982 ---\n 1848|       const pageInfo = res?.data?.product?.variants?.pageInfo;\n 1849|       const productRequiresSellingPlan =\n 1850|         res?.data?.product?.requiresSellingPlan || false;\n 1851| \n 1852|       for (const n of nodes) {\n 1853|         const gid = String(n.id);\n 1854|         const numericId = gid.includes(\"/\") ? gid.split(\"/\").pop() : gid;\n 1855| \n 1856|         const optMap = new Map(\n 1857|           (n.selectedOptions || []).map((o) => [\n 1858|             normName(o.name),\n 1859|             normVal(o.value),\n 1860|           ]),\n 1861|         );\n 1862| \n 1863|         // Extract variant images - collect all images from variant_image metafield\n 1864|         const variantImageNodes = n.variant_image?.references?.nodes || [];\n 1865|         const variantImages = variantImageNodes\n 1866|           .map((node) => node.image?.url)\n 1867|           .filter(Boolean);\n 1868|         const mainImageUrl = n.image?.url;\n 1869|         const imageUrl = mainImageUrl;\n 1870| \n 1871|         // Build featured_image object to match theme format\n 1872|         const featuredImage = n.image\n 1873|           ? {\n 1874|               id: n.image.id\n 1875|                 ? String(n.image.id).includes(\"/\")\n 1876|                   ? String(n.image.id).split(\"/\").pop()\n 1877|                   : n.image.id\n 1878|                 : null,\n 1879|               src: n.image.url,\n 1880|               width: n.image.width || 600,\n 1881|               height: n.image.height || 600,\n 1882|               alt: n.image.altText || null,\n 1883|             }\n 1884|           : null;\n 1885| \n 1886|         // Build featured_media object to match theme format\n 1887|         const featuredMedia = n.image\n 1888|           ? {\n 1889|               id: n.image.id\n 1890|                 ? String(n.image.id).includes(\"/\")\n 1891|                   ? String(n.image.id).split(\"/\").pop()\n 1892|                   : n.image.id\n 1893|                 : \n... [truncated 3762 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01V7jm9xrhEJ7gK3Ym1F4Xkr",
            "input": {
              "filePath": "assets/product-form-dynamic.js",
              "ranges": [
                {
                  "startLine": 1980,
                  "endLine": 2050
                }
              ]
            },
            "result": "--- product-form-dynamic.js lines 1978-2052 ---\n 1978|       const imgContainer = wrap.querySelector(\"[data-img-el]\");\n 1979|       if (!imgContainer) return;\n 1980|       const badge = imgContainer.querySelector(\".t4s-swatch__restock-badge\");\n 1981|       detectSwatchLuminance(imgContainer, badge);\n 1982|     });\n 1983| \n 1984|     // Update thumbnails after hydration completes\n 1985|     if (typeof $ !== \"undefined\") {\n 1986|       setTimeout(() => {\n 1987|         triggerThumbnailUpdate();\n 1988|       }, 200);\n 1989|     }\n 1990| \n 1991|   }\n 1992| \n 1993|   function setDefaultVariant() {\n 1994|     console.log(\"[PFD] Selected Variant\", window.__HAS_SELECTED__);\n 1995|     console.log(\"[PFD] Default Variant\", window.__DEFAULT_VARIANT__);\n 1996| \n 1997|     // If there is a selected variant, do nothing (handled by server)\n 1998|     if (window.__HAS_SELECTED__) {\n 1999|       console.log(\n 2000|         \"[PFD] Selected variant exists, skipping default variant logic\",\n 2001|       );\n 2002|       return;\n 2003|     }\n 2004| \n 2005|     // If there is no selected variant, set the default variant\n 2006|     const defaultVariant = window.__DEFAULT_VARIANT__;\n 2007|     if (!defaultVariant || !defaultVariant.id) {\n 2008|       console.log(\"[PFD] No default variant specified\");\n 2009|       return;\n 2010|     }\n 2011| \n 2012|     console.log(\"[PFD] Setting default variant:\", defaultVariant.id);\n 2013| \n 2014|     // Get the variant from our data\n 2015|     const variant = variantById.get(String(defaultVariant.id));\n 2016|     console.log(\"variant\", { ...variant });\n 2017|     if (!variant) {\n 2018|       console.log(\"[PFD] Variant not found in cache:\", defaultVariant.id);\n 2019|       return;\n 2020|     }\n 2021| \n 2022|     // Step 1: Update selectedValues array (critical for system to work)\n 2023|     for (let i = 0; i < optionCount; i++) {\n 2024|       selectedValues[i] = variant[`option${i + 1}`] || \"\";\n 2025|     }\n 2026| \n 2027|     // Step 2: Clear all current vi\n... [truncated 1032 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01FFLwEUC2t39ByUs2xLpjWm",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 415,
                  "endLine": 453
                }
              ]
            },
            "result": "--- product-form-dynamic.liquid lines 413-455 ---\n  413|                             {%- endfor -%}\n  414| \n  415|                             {%- comment %} Compute available standard lengths for this color (used for both classes and content) {%- endcomment -%}\n  416|                             {%- assign avail_lengths = '' -%}\n  417|                             {%- assign avail_lengths_seen = '' -%}\n  418|                             {%- assign length_opt_key = 'option' | append: length_option_position -%}\n  419|                             {%- if length_option_position > 0 and color_option_position > 0 -%}\n  420|                               {%- for lv in shsd_product_variants -%}\n  421|                                 {%- assign v_color_key = 'option' | append: color_option_position -%}\n  422|                                 {%- assign v_color_val = lv[v_color_key] | handle -%}\n  423|                                 {%- if v_color_val == color_handle and lv.available -%}\n  424|                                   {%- assign v_length_val = lv[length_opt_key] -%}\n  425|                                   {%- if v_length_val != blank -%}\n  426|                                     {%- assign is_custom_length = false -%}\n  427|                                     {%- if custom_option_names -%}\n  428|                                       {%- for custom_name in custom_option_names -%}\n  429|                                         {%- assign custom_name_stripped = custom_name | strip -%}\n  430|                                         {%- if v_length_val == custom_name_stripped -%}\n  431|                                           {%- assign is_custom_length = true -%}\n  432|                                           {%- break -%}\n  433|                                         {%- endif -%}\n  434|                                       {%- endfor -%}\n  435|                                     {%- endif -%}\n  436|                                     {%- unless is_custom_le\n... [truncated 1330 chars]",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "propose_code_edit",
            "id": "pm-change-1772203963990",
            "input": {
              "filePath": "product-form-dynamic.liquid",
              "newContent": "{% comment %} Custom options configuration - options listed here will render as dropdowns {% endcomment %}\n{% assign custom_option_names = product.metafields.custom.custom_values.value %}\n\n{% comment %} Custom content configuration for specific options {% endcomment %}\n{% comment %} Format: option_name:option_value|<html content> - separated by semicolons for multiple {% endcomment %}\n\n{% assign option_content_config = 'texture:Straight|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our straight texture has slight natural wave texture to it when washed and dried. It is not pin straight hair, nor is that desirable among most clientele.</span></div>;texture:Natural Wave|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our natural wave texture features soft, beachy waves that blend seamlessly with most natural hair textures. Low maintenance and versatile for everyday styling.</span></div>;texture:Loose Curl|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our loose curl texture offers bouncy, defined curls that hold their shape beautifully. Perfect for adding volume and movement with minimal styling required.</span></div>;texture:Tight Curl|<div class=\"pfd-info-content\"><span class=\"pfd-info-icon\">i</span><span class=\"pfd-info-text\">Our tight curl texture provides well-defined, springy curls with maximum volume. Ideal for protective styles and blending with naturally curly hair.</span></div>' %}\n\n{% assign option_content_pairs = option_content_config | split: ';' %}\n\n{% comment %} SellersDash collect child product details {% endcomment %}\n{% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}\n{% if shsd_product_details.product_type == 'shsd_parent' %}\n  {% assign shsd_product_handles = product.handle %}\n  {% assign shsd_product_handles = shsd_product_handles | concat: shsd_product_details.handles %}\n  {% for shsd_handle in shsd_product_handles %}\n    {% assign shsd_single_product = all_products[shsd_handle] %}\n    {% assign shsd_product_variants = shsd_product_variants | concat: shsd_single_product.variants %}\n    {% assign shsd_product_media = shsd_product_media | concat: shsd_single_product.media %}\n    {% assign shsd_product_images = shsd_product_images | concat: shsd_single_product.images %}\n  {% endfor %}\n  {% assign shsd_product_options_with_values = shsd_product_details.options_with_values %}\n{% else %}\n  {% assign shsd_product_options_with_values = product.options_with_values %}\n  {% assign shsd_product_variants = product.variants %}\n  {% assign shsd_product_media = product.media %}\n  {% assign shsd_product_images = product.images %}\n{% endif %}\n\n{% comment %} Reorder options: Length, Texture, Color, then remaining {% endcomment %}\n{% assign reordered_options = '' | split: '' %}\n{% assign remaining_options = '' | split: '' %}\n\n{% for option in shsd_product_options_with_values %}\n  {% assign opt_name_lower = option.name | downcase | strip %}\n  {% if opt_name_lower == 'length' %}\n    {% assign length_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n  {% elsif opt_name_lower == 'texture' %}\n    {% assign texture_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n  {% elsif opt_name_lower == 'color' or opt_name_lower == 'colour' or opt_name_lower == 'colors' %}\n    {% assign color_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n  {% else %}\n    {% assign other_slice = shsd_product_options_with_values | slice: forloop.index0, 1 %}\n    {% assign remaining_options = remaining_options | concat: other_slice %}\n  {% endif %}\n{% endfor %}\n\n{% if length_slice %}\n  {% assign reordered_options = reordered_options | concat: length_slice %}\n{% endif %}\n{% if texture_slice %}\n  {% assign reordered_options = reordered_options | concat: texture_slice %}\n{% endif %}\n{% if color_slice %}\n  {% assign reordered_options = reordered_options | concat: color_slice %}\n{% endif %}\n{% assign shsd_product_options_with_values = reordered_options | concat: remaining_options %}\n\n{%- assign product_form_id = 'product-form-' | append: pr_sid -%}\n{%- liquid\n  assign pr_variants = shsd_product_variants\n  assign PR_buy_pr = false\n  if bk_stts.show_dynamic_checkout and isExternal == false and isProductAvailable\n    assign PR_buy_pr = true\n  endif\n  assign choose_an_option = 'products.product.choose_an_option' | t\n  assign date_in = settings.date_in\n  assign class_frm = 't4s-form__product has--form__swatch'\n  if isProductDefault\n    assign class_frm = 't4s-form__product'\n  endif\n  if arr_properties.size > 0 and isProductAvailable\n    assign class_frm = class_frm | append: ' has--properties'\n  endif\n  if settings.sticky_atc and type == 'main'\n    assign class_frm = class_frm | append: ' is--main-sticky'\n  else\n    assign class_frm = class_frm | append: ' is--atc-sticky'\n  endif\n\n  assign color_swatch = 'disabled-'\n  assign color_mode = bk_stts.color_mode\n  assign selector_mode = bk_stts.selector_mode\n  assign stt_color_ck = settings.color_ck | default: ';'\n  assign color_ck = stt_color_ck | append: ',color,colors,couleur,colour' | remove: ';,'\n  assign get_color = color_ck | downcase | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | uniq\n  assign color_mode_list = 'color, color is-sw-cl__round, color is-sw-cl__round is-sw-cl__label, variant_image, variant_image is-sw-cl__round, variant_image is-sw-cl__round is-sw-cl__label' | split: ', '\n  if color_mode_list contains color_mode\n    assign color_swatch = 'is-sw__color '\n  endif\n  assign current_variant_available = current_variant.available\n  assign use_incoming_mess = settings.use_incoming_mess\n  assign current_variant_incoming = false\n  assign current_inventory_quantity = current_variant.inventory_quantity\n  if current_inventory_quantity <= 0 and current_variant.inventory_management == 'shopify' and current_variant.incoming\n    assign current_variant_incoming = true\n  endif\n  if pos_sizeg == '1'\n    assign html_sizeg = ''\n  endif\n  if current_variant.inventory_management != null and current_inventory_quantity > 0 and current_variant.inventory_policy != 'continue'\n    assign max_qty = current_inventory_quantity\n  else\n    assign max_qty = 9999\n  endif\n  if color_mode contains 'color' or color_mode contains 'variant'\n    assign show_tooltip = ''\n  else\n    assign show_tooltip = '-off'\n  endif\n-%}\n\n{%- if product.metafields.custom.default_variant.value -%}\n  <script>\n    window.__HAS_SELECTED__ = {{ product.selected_variant | json }};\n    window.__DEFAULT_VARIANT__ = {{ product.metafields.custom.default_variant.value | json }};\n  </script>\n{%- endif -%}\n\n{%- assign length_option_position = -1 -%}\n{%- assign color_option_position = -1 -%}\n{%- comment -%}\n  Derive positions from the REORDERED shsd_product_options_with_values so\n  that length_option_position / color_option_position match the indices used\n  by pr_options_json (consumed by JS) and by the avail_lengths loop below.\n  Using product.options here would give the original (pre-reorder) positions,\n  which diverge for SHSD parent products and break the lengths calculation.\n{%- endcomment -%}\n{%- for shsd_opt in shsd_product_options_with_values -%}\n  {%- assign shsd_opt_name_down = shsd_opt.name | downcase -%}\n  {%- if shsd_opt_name_down == 'length' -%}\n    {%- assign length_option_position = forloop.index -%}\n  {%- endif -%}\n  {%- if get_color contains shsd_opt_name_down -%}\n    {%- assign color_option_position = forloop.index -%}\n  {%- endif -%}\n{%- endfor -%}\n\n<script>\n  window.__CUSTOM_OPTION_NAMES__ = {{ custom_option_names | json }};\n  window.__LENGTH_OPTION_INDEX__ = {{ length_option_position | minus: 1 }};\n  window.__COLOR_OPTION_INDEX__ = {{ color_option_position | minus: 1 }};\n  window.__COLOR_OPTION_NAMES__ = {{ get_color | json }};\n</script>\n\n{%- comment -%} Load dropdown CSS if either color mode or selector mode is dropdown {%- endcomment -%}\n\n{%- if color_mode == 'dropdown' or selector_mode == 'dropdown' -%}\n  <link\n    rel=\"stylesheet\"\n    href=\"{{ 'base_drop.min.css' | asset_url }}\"\n    media=\"all\"\n  >\n{%- endif -%}\n\n{%- comment -%} Custom CSS for product form dynamic {%- endcomment -%}\n{{ 'product-form-dynamic.css' | asset_url | stylesheet_tag }}\n\n<div class=\"pfd-override-wrapper\">\n  <div class=\"pfd-custom-wrapper\">\n    <div\n      class=\"t4s-product-form__variants is-no-pick__{{ PR_no_pick }}{% if PR_buy_pr %} is-payment-btn-true t4s-payment-button t4s-btn-color-{{ bk_stts.button_color_payment }}{% endif %} is-remove-soldout-{{ remove_soldout }} is-btn-full-width__{{ bk_stts.btn_atc_full }} is-btn-atc-txt-{{ bk_stts.btn_txt }} is-btn-ck-txt-{{ bk_stts.btn_txt2 }} is--fist-ratio-{{ is_fit_ratio_img }}\"\n      style=\"{% if is_fit_ratio_img %} --fit-ratio-img: {{ first_ratio_img }}; {% endif %} --wishlist-color: {{bk_stts.wishlist_color}};--wishlist-hover-color: {{bk_stts.wishlist_color_hover}};--wishlist-active-color: {{bk_stts.wishlist_color_active}};--compare-color: {{bk_stts.compare_color}};--compare-hover-color: {{bk_stts.compare_color_hover}};--compare-active-color: {{bk_stts.compare_color_active}};\"\n      {{ shopify_attributes }}\n    >\n      <div data-callBackVariant id=\"t4s-callBackVariant{{ product_form_id }}\">\n        {%- form 'product',\n          product,\n          id: product_form_id,\n          data-productid: product.id,\n          class: class_frm,\n          novalidate: 'novalidate',\n          data-type: 'add-to-cart-form',\n          data-disable-swatch: isProductDefault\n        -%}\n          {% comment %}{{- form | payment_terms -}}{% endcomment %}\n          {%- if isProductDefault -%}\n            <input\n              name=\"id\"\n              value=\"{{ pr_variants.first.id }}\"\n              type=\"hidden\"\n            >\n            {%- if advance_pr_type != blank -%}\n              {%- render 'choose_style', advance_pr_type: advance_pr_type, title: advance_label, pid: product.id -%}\n            {%- endif -%}\n          {%- else -%}\n            {{ 'swatch.css' | asset_url | stylesheet_tag }}\n            <select\n              name=\"id\"\n              id=\"product-select-{{ pr_sid }}\"\n              class=\"t4s-product__select t4s-d-none\"\n            >\n              {%- for variant in pr_variants -%}\n                {%- if variant.available -%}\n                  <option\n                    data-option1=\"{{ variant.option1 }}\"\n                    data-option2=\"{{ variant.option2 }}\"\n                    value=\"{{ variant.id }}\"\n                    data-mdid=\"{{ variant.featured_media.id | json }}\"\n                    data-incoming=\"{{ variant.incoming }}\"\n                    data-inventoryQuantity=\"{{ variant.inventory_quantity | json }}\"\n                    data-inventoryPolicy=\"{{ variant.inventory_policy | json }}\"\n                    data-nextIncomingDate=\"{{ variant.next_incoming_date | date: date_in }}\"\n                    {% if variant.id == current_variant.id %}\n                      selected=\"selected\"\n                    {% endif %}\n                  >\n                    {{ variant.title | escape }}\n                  </option>\n                {%- else -%}\n                  <option\n                    data-option1=\"{{ variant.option1 }}\"\n                    data-option2=\"{{ variant.option2 }}\"\n                    value=\"{{ variant.id }}\"\n                    data-mdid=\"{{ variant.featured_media.id | json }}\"\n                    data-incoming=\"{{ variant.incoming }}\"\n                    data-inventoryQuantity=\"{{ variant.inventory_quantity | json }}\"\n                    data-inventoryPolicy=\"{{ variant.inventory_policy | json }}\"\n                    data-nextIncomingDate=\"{{ variant.next_incoming_date | date: date_in }}\"\n                  >\n                    {{ variant.title | escape }}\n                  </option>\n                {%- endif -%}\n              {%- endfor -%}\n            </select>\n\n            <div class=\"pfd-variant-images\" style=\"display:none !important;\">\n              <div class=\"pfd-main-imgs\">\n                {%- for variant in pr_variants -%}\n                  {% assign var_imgs = variant.metafields.custom.variant_image.value %}\n                  <div\n                    class=\"pfd-img-listing\"\n                    data-var-img=\"{{ variant.image.src | img_url: 'master' }}\"\n                    data-pfd-variant-id=\"{{ variant.id }}\"\n                  >\n                    {% for value in var_imgs %}\n                      <div class=\"pfd-media-item\">\n                        <img src=\"{{value | img_url: 'master'}}\">\n                      </div>\n                    {% endfor %}\n                  </div>\n                {%- endfor -%}\n              </div>\n              <div class=\"pfd-thumb-imgs\">\n                {%- for variant in pr_variants -%}\n                  {% assign var_imgs = variant.metafields.custom.variant_image.value %}\n                  <div class=\"pfd-img-listing\" data-pfd-variant-id=\"{{ variant.id }}\">\n                    {% for value in var_imgs %}\n                      <div class=\"pfd-media-thumb\">\n                        <div\n                          class=\"pfd-img\"\n                          style=\"background-image:url('{{value | img_url: \"master\"}}');\"\n                        ></div>\n                      </div>\n                    {% endfor %}\n                  </div>\n                {%- endfor -%}\n              </div>\n            </div>\n\n            <div class=\"t4s-swatch t4s-color-mode__{{ color_mode }} t4s-color-size__{{ bk_stts.color_size }} t4s-selector-mode__{{ selector_mode }}\">\n              {%- if advance_pr_type != blank -%}\n                {%- render 'choose_style', advance_pr_type: advance_pr_type, title: advance_label, pid: product.id -%}\n              {%- endif -%}\n\n              {%- for option in shsd_product_options_with_values -%}\n                {%- liquid\n                  assign option_index = 'option' | append: forloop.index\n                  assign selected_value = product.selected_or_first_available_variant[option_index]\n                  assign option_name = option.name\n                  assign name_downcase = option_name | downcase\n                -%}\n\n                {%- if get_color contains name_downcase -%}\n                  {% comment %}--MARK: Color Option{% endcomment %}\n\n                  {% comment %} Build color nickname map from variant metafields {% endcomment %}\n                  {%- capture color_nicknames_map -%}\n                    {%- for variant in shsd_product_variants -%}\n                      {%- if variant.metafields.custom.variant_color != blank -%}\n                        {%- for opt_index in (1..3) -%}\n                          {%- assign opt_key = 'option' | append: opt_index -%}\n                          {%- assign opt_val = variant[opt_key] -%}\n                          {%- if opt_val != blank -%}\n                            {%- comment %} Use color_option_position (reordered) instead of product.options lookup {%- endcomment -%}\n                            {%- if opt_index == color_option_position -%}\n                              {{ opt_val | handle }}:{{ variant.metafields.custom.variant_color }};\n                            {%- endif -%}\n                          {%- endif -%}\n                        {%- endfor -%}\n                      {%- endif -%}\n                    {%- endfor -%}\n                  {%- endcapture -%}\n                  {%- assign color_nicknames_map = color_nicknames_map | strip -%}\n\n                  <div\n                    data-swatch-option\n                    data-option-name=\"{{ option_name | escape }}\"\n                    data-id=\"{{ forloop.index0 }}\"\n                    data-option-unit=\"\n                      {%- liquid\n                        assign option_unit = ''\n                        if se_stts and se_stts.option_units and se_stts.option_units != blank\n                          assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                          for pair in option_units_raw\n                            assign pair_cleaned = pair | strip\n                            if pair_cleaned contains ':'\n                              assign key_value = pair_cleaned | split: ':'\n                              assign key = key_value[0] | strip\n                              assign value = key_value[1] | strip\n                              if key == option_name and value != blank\n                                assign option_unit = value\n                                break\n                              endif\n                            endif\n                          endfor\n                        endif\n                      -%}{{ option_unit | escape }}\n                    \"\n                    class=\"t4s-swatch__option is-t4s-style__color is-t4s-name__{{ option_name | handle }} {% cycle 'is--first-color', '', '' %}\"\n                  >\n                    <h4 class=\"t4s-swatch__title t4s-swatch__title--color\">\n                      <span class=\"t4s-swatch__title--left\">\n                        <span class=\"bold\">\n                          {{- option_name | upcase -}}\n                          {%- liquid\n                            assign option_unit = ''\n                            if se_stts and se_stts.option_units and se_stts.option_units != blank\n                              assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                              for pair in option_units_raw\n                                assign pair_cleaned = pair | strip\n                                if pair_cleaned contains ':'\n                                  assign key_value = pair_cleaned | split: ':'\n                                  assign key = key_value[0] | strip\n                                  assign value = key_value[1] | strip\n                                  if key == option_name and value != blank\n                                    assign option_unit = value\n                                    break\n                                  endif\n                                endif\n                              endfor\n                            endif\n                          -%}\n                          {%- if option_unit != blank %} ({{ option_unit }}){%- endif -%}\n                          :\n                        </span>\n                        <span class=\"t4s-selected-value\">\n                          {%- assign display_value = selected_value | default: choose_an_option | replace: '\"', '' -%}\n                          {{- display_value -}}\n                          {%- if option_unit != blank %} {{ option_unit }}{%- endif -%}\n                        </span>\n                      </span>\n                      {%- if name_sizeg == name_downcase -%}\n                        {{- html_sizeg -}}\n                      {%- endif %}\n                    </h4>\n\n                    <div data-swatch-list class=\"t4s-swatch__list\">\n                      {%- if color_mode != 'dropdown' -%}\n                        {%- if color_mode contains 'is-sw-cl__label' -%}\n                          {%- for value in option.values -%}\n                            {%- assign color_handle = value | handle -%}\n\n                            {%- comment %} Look up color nickname from map {%- endcomment -%}\n                            {%- assign color_nickname = '' -%}\n                            {%- assign nickname_pairs = color_nicknames_map | split: ';' -%}\n                            {%- for pair in nickname_pairs -%}\n                              {%- assign pair_clean = pair | strip -%}\n                              {%- if pair_clean != blank -%}\n                                {%- assign pair_parts = pair_clean | split: ':' -%}\n                                {%- if pair_parts[0] == color_handle -%}\n                                  {%- assign color_nickname = pair_parts[1] -%}\n                                  {%- break -%}\n                                {%- endif -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Context-aware availability check: color + current other selections {%- endcomment -%}\n                            {%- assign color_is_available = false -%}\n                            {%- for variant in shsd_product_variants -%}\n                              {%- assign matches_color = false -%}\n                              {%- assign matches_other_options = true -%}\n\n                              {%- for opt_idx in (1..3) -%}\n                                {%- assign opt_key = 'option' | append: opt_idx -%}\n                                {%- assign variant_opt_val = variant[opt_key] -%}\n                                {%- if variant_opt_val != blank -%}\n                                  {%- assign variant_opt_handle = variant_opt_val | handle -%}\n\n                                  {%- comment %} Use color_option_position (derived from reordered shsd options) to identify the color slot {%- endcomment -%}\n                                  {%- if opt_idx == color_option_position -%}\n                                    {%- comment %} This is the color option - check if it matches our target color {%- endcomment -%}\n                                    {%- if variant_opt_handle == color_handle -%}\n                                      {%- assign matches_color = true -%}\n                                    {%- endif -%}\n                                  {%- else -%}\n                                    {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment -%}\n                                    {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}\n                                    {%- if current_selected_val != blank -%}\n                                      {%- assign current_selected_handle = current_selected_val | handle -%}\n                                      {%- unless variant_opt_handle == current_selected_handle -%}\n                                        {%- assign matches_other_options = false -%}\n                                      {%- endunless -%}\n                                    {%- endif -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n\n                              {%- if matches_color and matches_other_options and variant.available -%}\n                                {%- assign color_is_available = true -%}\n                                {%- break -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Compute available standard lengths (longer than current selection) for this color {%- endcomment -%}\n                            {%- assign avail_lengths = '' -%}\n                            {%- assign avail_lengths_seen = '' -%}\n                            {%- assign length_opt_key = 'option' | append: length_option_position -%}\n                            {%- comment %} Get the currently selected length as a number for comparison {%- endcomment -%}\n                            {%- assign selected_length_key = 'option' | append: length_option_position -%}\n                            {%- assign selected_length_raw = product.selected_or_first_available_variant[selected_length_key] | replace: '\"', '' | strip -%}\n                            {%- assign selected_length_num = selected_length_raw | times: 1 -%}\n                            {%- if length_option_position > 0 and color_option_position > 0 -%}\n                              {%- for lv in shsd_product_variants -%}\n                                {%- assign v_color_key = 'option' | append: color_option_position -%}\n                                {%- assign v_color_val = lv[v_color_key] | handle -%}\n                                {%- if v_color_val == color_handle and lv.available -%}\n                                  {%- assign v_length_val = lv[length_opt_key] -%}\n                                  {%- if v_length_val != blank -%}\n                                    {%- assign is_custom_length = false -%}\n                                    {%- if custom_option_names -%}\n                                      {%- for custom_name in custom_option_names -%}\n                                        {%- assign custom_name_stripped = custom_name | strip -%}\n                                        {%- if v_length_val contains custom_name_stripped -%}\n                                          {%- assign is_custom_length = true -%}\n                                          {%- break -%}\n                                        {%- endif -%}\n                                      {%- endfor -%}\n                                    {%- endif -%}\n                                    {%- unless is_custom_length -%}\n                                      {%- assign v_length_clean = v_length_val | replace: '\"', '' | strip -%}\n                                      {%- assign v_length_num = v_length_clean | times: 1 -%}\n                                      {%- comment %} Only include lengths strictly greater than the currently selected length {%- endcomment -%}\n                                      {%- if selected_length_num == 0 or v_length_num > selected_length_num -%}\n                                        {%- assign sentinel = '@@' | append: v_length_clean | append: '@@' -%}\n                                        {%- unless avail_lengths_seen contains sentinel -%}\n                                          {%- assign avail_lengths_seen = avail_lengths_seen | append: sentinel -%}\n                                          {%- if avail_lengths == '' -%}\n                                            {%- assign avail_lengths = v_length_clean -%}\n                                          {%- else -%}\n                                            {%- assign avail_lengths = avail_lengths | append: ', ' | append: v_length_clean -%}\n                                          {%- endif -%}\n                                        {%- endunless -%}\n                                      {%- endif -%}\n                                    {%- endunless -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                            {%- endif -%}\n\n                            <div\n                              data-swatch-item\n                              class=\"t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}{% unless color_is_available %} is--soldout is--out-of-stock{% if avail_lengths != '' %} pfd-has-lengths{% endif %}{% endunless %}\"\n                              data-value=\"{{ value | escape }}\"\n                              data-available=\"{{ color_is_available }}\"\n                            >\n                              <!-- DEBUG: color={{ color_handle }} | available={{ color_is_available }} | selected_opt1={{ product.selected_or_first_available_variant.option1 | handle }} | selected_opt2={{ product.selected_or_first_available_variant.option2 | handle }} -->\n                              <div\n                                data-img-el\n                                class=\"t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s\">\n                                <img crossorigin=\"anonymous\">\n                                {%- unless color_is_available -%}\n                                  <span class=\"t4s-swatch__restock-badge is-visible\">Awaiting Restock</span>\n                                {%- endunless -%}\n                              </div>\n                              {%- unless color_is_available -%}\n                                {%- if avail_lengths != '' -%}\n                                  <span class=\"t4s-swatch__available-lengths is-visible\">Available in {{ avail_lengths }}</span>\n                                {%- endif -%}\n                              {%- endunless -%}\n                              <span class=\"t4s-swatch__label\">\n                                {{- value | replace: '\"', '' -}}\n                              </span>\n                              {%- if color_nickname != blank -%}\n                                <span class=\"t4s-swatch__nickname\">{{ color_nickname }}</span>\n                              {%- endif -%}\n                            </div>\n\n                          {%- endfor -%}\n\n                        {%- else -%}\n                          {%- for value in option.values -%}\n                            {%- assign color_handle = value | handle -%}\n\n                            {%- comment %} Look up color nickname {%- endcomment -%}\n                            {%- assign color_nickname = '' -%}\n                            {%- assign nickname_pairs = color_nicknames_map | split: ';' -%}\n                            {%- for pair in nickname_pairs -%}\n                              {%- assign pair_clean = pair | strip -%}\n                              {%- if pair_clean != blank -%}\n                                {%- assign pair_parts = pair_clean | split: ':' -%}\n                                {%- if pair_parts[0] == color_handle -%}\n                                  {%- assign color_nickname = pair_parts[1] -%}\n                                  {%- break -%}\n                                {%- endif -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Context-aware availability check: color + current other selections {%- endcomment -%}\n                            {%- assign color_is_available = false -%}\n                            {%- for variant in shsd_product_variants -%}\n                              {%- assign matches_color = false -%}\n                              {%- assign matches_other_options = true -%}\n\n                              {%- for opt_idx in (1..3) -%}\n                                {%- assign opt_key = 'option' | append: opt_idx -%}\n                                {%- assign variant_opt_val = variant[opt_key] -%}\n                                {%- if variant_opt_val != blank -%}\n                                  {%- assign variant_opt_handle = variant_opt_val | handle -%}\n\n                                  {%- comment %} Use color_option_position (derived from reordered shsd options) to identify the color slot {%- endcomment -%}\n                                  {%- if opt_idx == color_option_position -%}\n                                    {%- comment %} This is the color option - check if it matches our target color {%- endcomment -%}\n                                    {%- if variant_opt_handle == color_handle -%}\n                                      {%- assign matches_color = true -%}\n                                    {%- endif -%}\n                                  {%- else -%}\n                                    {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment -%}\n                                    {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}\n                                    {%- if current_selected_val != blank -%}\n                                      {%- assign current_selected_handle = current_selected_val | handle -%}\n                                      {%- unless variant_opt_handle == current_selected_handle -%}\n                                        {%- assign matches_other_options = false -%}\n                                      {%- endunless -%}\n                                    {%- endif -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n\n                              {%- if matches_color and matches_other_options and variant.available -%}\n                                {%- assign color_is_available = true -%}\n                                {%- break -%}\n                              {%- endif -%}\n                            {%- endfor -%}\n\n                            {%- comment %} Compute available standard lengths for this color {%- endcomment -%}\n                            {%- assign avail_lengths = '' -%}\n                            {%- assign avail_lengths_seen = '' -%}\n                            {%- assign length_opt_key = 'option' | append: length_option_position -%}\n                            {%- if length_option_position > 0 and color_option_position > 0 -%}\n                              {%- for lv in shsd_product_variants -%}\n                                {%- assign v_color_key = 'option' | append: color_option_position -%}\n                                {%- assign v_color_val = lv[v_color_key] | handle -%}\n                                {%- if v_color_val == color_handle and lv.available -%}\n                                  {%- assign v_length_val = lv[length_opt_key] -%}\n                                  {%- if v_length_val != blank -%}\n                                    {%- assign is_custom_length = false -%}\n                                    {%- if custom_option_names -%}\n                                      {%- for custom_name in custom_option_names -%}\n                                        {%- assign custom_name_stripped = custom_name | strip -%}\n                                        {%- if v_length_val == custom_name_stripped -%}\n                                          {%- assign is_custom_length = true -%}\n                                          {%- break -%}\n                                        {%- endif -%}\n                                      {%- endfor -%}\n                                    {%- endif -%}\n                                    {%- unless is_custom_length -%}\n                                      {%- assign v_length_clean = v_length_val | replace: '\"', '' | strip -%}\n                                      {%- assign sentinel = '@@' | append: v_length_clean | append: '@@' -%}\n                                      {%- unless avail_lengths_seen contains sentinel -%}\n                                        {%- assign avail_lengths_seen = avail_lengths_seen | append: sentinel -%}\n                                        {%- if avail_lengths == '' -%}\n                                          {%- assign avail_lengths = v_length_clean -%}\n                                        {%- else -%}\n                                          {%- assign avail_lengths = avail_lengths | append: ', ' | append: v_length_clean -%}\n                                        {%- endif -%}\n                                      {%- endunless -%}\n                                    {%- endunless -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                            {%- endif -%}\n\n                            <div\n                              data-swatch-item\n                class=\"t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}{% unless color_is_available %} is--soldout is--out-of-stock{% if avail_lengths != '' %} pfd-has-lengths{% endif %}{% endunless %}\"\n                              data-value=\"{{ value | escape }}\"\n                              data-available=\"{{ color_is_available }}\"\n                            >\n                              <div\n                                data-img-el\n                                class=\"t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s\"\n                              >\n                                <img crossorigin=\"anonymous\">\n                                {%- unless color_is_available -%}\n                                  <span class=\"t4s-swatch__restock-badge is-visible\">Awaiting Restock</span>\n                                {%- endunless -%}\n                              </div>\n                              {%- unless color_is_available -%}\n                                {%- if avail_lengths != '' -%}\n                                  <span class=\"t4s-swatch__available-lengths is-visible\">Available in {{ avail_lengths }}</span>\n                                {%- endif -%}\n                              {%- endunless -%}\n                              {%- if color_nickname != blank -%}\n                                <span class=\"t4s-swatch__nickname\">{{ color_nickname }}</span>\n                              {%- endif -%}\n                            </div>\n\n                          {%- endfor -%}\n\n                        {%- endif -%}\n                      {%- else -%}\n                        <button\n                          type=\"button\"\n                          data-dropdown-open\n                          data-position=\"bottom-end\"\n                          data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                        >\n                          <span data-current-value>\n                            {{- selected_value | default: choose_an_option -}}\n                          </span>\n                          <svg\n                            class=\"t4s-icon-select-arrow\"\n                            role=\"presentation\"\n                            viewBox=\"0 0 19 12\"\n                          >\n                            <use xlink:href=\"#t4s-select-arrow\"></use>\n                          </svg>\n                        </button>\n                        <div\n                          data-dropdown-wrapper\n                          class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                          id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                        >\n                          <div class=\"t4s-drop-arrow\"></div>\n                          <div class=\"t4s-dropdown__header\">\n                            <span\n                              data-current-value\n                              class=\"t4s-dropdown__title\"\n                            >\n                              {{- selected_value | default: choose_an_option -}}\n                            </span>\n                            <button\n                              data-dropdown-close\n                              aria-label=\"{{ 'general.aria.close' | t }}\"\n                            >\n                              <svg\n                                role=\"presentation\"\n                                class=\"t4s-iconsvg-close\"\n                                viewBox=\"0 0 16 14\"\n                              >\n                                <path d=\"M15 0L1 14m14 0L1 0\" stroke=\"currentColor\" fill=\"none\" fill-rule=\"evenodd\"></path>\n                              </svg>\n                            </button>\n                          </div>\n                          <div class=\"t4s-dropdown__content\">\n                            {%- for value in option.values -%}\n                              <div\n                                data-swatch-item\n                                data-dropdown-off\n                                class=\"t4s-swatch__item t4s-truncate {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}\"\n                                data-value=\"{{ value | escape }}\"\n                              >\n                                {{ value | replace: '\"', '' }}\n                              </div>\n                            {%- endfor -%}\n                          </div>\n                        </div>\n                      {%- endif -%}\n                    </div>\n                    {%- render 'color-info-accordion' -%}\n                  </div>\n                {%- else -%}\n                  {% comment %}--MARK: Non-Color{% endcomment %}\n                  {%- liquid\n                    assign standard_values = ''\n                    assign custom_values = ''\n                    assign has_standard = false\n                    assign has_custom = false\n\n                    for value in option.values\n                      assign is_custom = false\n                      for custom_name in custom_option_names\n                        assign custom_name_clean = custom_name | strip\n                        if value contains custom_name_clean\n                          assign is_custom = true\n                          break\n                        endif\n                      endfor\n\n                      if is_custom\n                        if custom_values == ''\n                          assign custom_values = value\n                        else\n                          assign custom_values = custom_values | append: ',' | append: value\n                        endif\n                        assign has_custom = true\n                      else\n                        if standard_values == ''\n                          assign standard_values = value\n                        else\n                          assign standard_values = standard_values | append: ',' | append: value\n                        endif\n                        assign has_standard = true\n                      endif\n                    endfor\n\n                    assign standard_values_array = standard_values | split: ','\n                    assign custom_values_array = custom_values | split: ','\n                  -%}\n\n                  <div\n                    data-swatch-option\n                    data-option-name=\"{{ option_name | escape }}\"\n                    data-id=\"{{ forloop.index0 }}\"\n                    data-option-unit=\"\n                      {%- liquid\n                        assign option_unit = ''\n                        if se_stts and se_stts.option_units and se_stts.option_units != blank\n                          assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                          for pair in option_units_raw\n                            assign pair_cleaned = pair | strip\n                            if pair_cleaned contains ':'\n                              assign key_value = pair_cleaned | split: ':'\n                              assign key = key_value[0] | strip\n                              assign value = key_value[1] | strip\n                              if key == option_name and value != blank\n                                assign option_unit = value\n                                break\n                              endif\n                            endif\n                          endfor\n                        endif\n                      -%}{{ option_unit | escape }}\n                    \"\n                    class=\"t4s-swatch__option is-t4s-name__{{ option_name | handle }} pfd-split-option\"\n                  >\n                    <h4 class=\"t4s-swatch__title\">\n                      <span class=\"t4s-swatch__title--left\"\n                        >Select a\n                        <span class=\"bold\">\n                          {{- option_name -}}\n                        </span>\n                        {%- liquid\n                          assign option_unit = ''\n                          if se_stts and se_stts.option_units and se_stts.option_units != blank\n                            assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'\n                            for pair in option_units_raw\n                              assign pair_cleaned = pair | strip\n                              if pair_cleaned contains ':'\n                                assign key_value = pair_cleaned | split: ':'\n                                assign key = key_value[0] | strip\n                                assign value = key_value[1] | strip\n                                if key == option_name and value != blank\n                                  assign option_unit = value\n                                  break\n                                endif\n                              endif\n                            endfor\n                          endif\n                        -%}\n                        {%- if option_unit != blank %} ({{ option_unit }}){%- endif -%}\n                      </span>\n                      <span class=\"t4s-swatch__title--right\"\n                        >Selected:\n                        <span class=\"bold\">\n                          {%- assign display_value = selected_value | default: choose_an_option | replace: '\"', '' -%}\n                          {{- display_value -}}\n                          {%- if option_unit != blank %} {{ option_unit }}{%- endif -%}\n                        </span></span\n                      >\n                      {%- if name_sizeg == name_downcase -%}\n                        {{- html_sizeg -}}\n                      {%- endif %}\n                    </h4>\n\n                    <div class=\"pfd-split-selection\">\n                      {%- if has_standard -%}\n                        <div class=\"pfd-standard-options\">\n                          {%- if selector_mode != 'dropdown' -%}\n                            {%- for value in standard_values_array -%}\n                              <div\n                                data-swatch-item\n                                class=\"t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}\"\n                                data-value=\"{{ value | escape }}\"\n                              >\n                                {{ value | replace: '\"', '' }}\n                              </div>\n                            {%- endfor -%}\n                          {%- else -%}\n                            <button\n                              type=\"button\"\n                              data-pfd-dropdown-open\n                              data-position=\"bottom-end\"\n                              data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_standard\"\n                            >\n                              <span data-current-value>\n                                {{- selected_value | default: choose_an_option -}}\n                              </span>\n                              <svg\n                                class=\"t4s-icon-select-arrow\"\n                                role=\"presentation\"\n                                viewBox=\"0 0 19 12\"\n                              >\n                                <use xlink:href=\"#t4s-select-arrow\"></use>\n                              </svg>\n                            </button>\n                            <div\n                              data-dropdown-wrapper\n                              class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                              id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_standard\"\n                            >\n                              <div class=\"t4s-drop-arrow\"></div>\n                              <div class=\"t4s-dropdown__content\">\n                                {%- for value in standard_values_array -%}\n                                  <div\n                                    data-swatch-item\n                                    data-dropdown-off\n                                    class=\"t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}\"\n                                    data-value=\"{{ value | escape }}\"\n                                  >\n                                    {{ value | replace: '\"', '' }}\n                                  </div>\n                                {%- endfor -%}\n                              </div>\n                            </div>\n                          {%- endif -%}\n                        </div>\n                      {%- endif -%}\n\n                      {%- if has_custom -%}\n                        <div class=\"pfd-custom-options\">\n                          {%- if has_standard and has_custom -%}\n                            <span class=\"pfd-or-separator\">or</span>\n                          {%- endif -%}\n                          <button\n                            type=\"button\"\n                            data-pfd-dropdown-open\n                            data-position=\"bottom-end\"\n                            data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_custom\"\n                            class=\"pfd-custom-dropdown\"\n                          >\n                            <span data-current-value>\n                              {%- assign is_custom_selected = false -%}\n                              {%- for custom_val in custom_values_array -%}\n                                {%- if selected_value == custom_val -%}\n                                  {%- assign display_custom_val = custom_val | replace: '\"', '' -%}\n                                  {%- if option_unit != blank -%}\n                                    {{ display_custom_val }}\n                                    {{ option_unit }}\n                                    <span class=\"pfd-custom-badge\">Custom</span>\n                                  {%- else -%}\n                                    {{ display_custom_val }}\n                                    <span class=\"pfd-custom-badge\">Custom</span>\n                                  {%- endif -%}\n                                  {%- assign is_custom_selected = true -%}\n                                  {%- break -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                              {%- unless is_custom_selected -%}\n                                Custom {{ option_name | downcase }}\n                              {%- endunless -%}\n                            </span>\n                            <svg\n                              class=\"t4s-icon-select-arrow\"\n                              role=\"presentation\"\n                              viewBox=\"0 0 19 12\"\n                            >\n                              <use xlink:href=\"#t4s-select-arrow\"></use>\n                            </svg>\n                          </button>\n                          <div\n                            data-dropdown-wrapper\n                            class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                            id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}_custom\"\n                          >\n                            <div class=\"t4s-drop-arrow\"></div>\n                            <div class=\"t4s-dropdown__content\">\n                              {%- for value in custom_values_array -%}\n                                <div\n                                  data-swatch-item\n                                  data-dropdown-off\n                                  class=\"t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}\"\n                                  data-value=\"{{ value | escape }}\"\n                                >\n                                  <span class=\"pfd-checkmark\">✓</span>\n                                  <span class=\"pfd-option-text\">\n                                    {%- assign display_value = value | replace: '\"', '' -%}\n                                    {%- if option_unit != blank -%}\n                                      {{ display_value }}\n                                      {{ option_unit }}\n                                    {%- else -%}\n                                      {{ display_value }}\n                                    {%- endif -%}\n                                  </span>\n                                  <span class=\"pfd-custom-badge\">Custom</span>\n                                </div>\n                              {%- endfor -%}\n                            </div>\n                          </div>\n                        </div>\n                      {%- endif -%}\n\n                      {%- unless has_standard or has_custom -%}\n                        {%- comment %} Fallback to original rendering if no split detected {%- endcomment %}\n                        <div class=\"t4s-swatch__list pfd-fallback-list\">\n                          {%- if selector_mode != 'dropdown' -%}\n                            {%- for value in option.values -%}\n                              <div\n                                data-swatch-item\n                                class=\"t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}\"\n                                data-value=\"{{ value | escape }}\"\n                              >\n                                {{ value | replace: '\"', '' }}\n                              </div>\n                            {%- endfor -%}\n                          {%- else -%}\n                            <button\n                              type=\"button\"\n                              data-pfd-dropdown-open\n                              data-position=\"bottom-end\"\n                              data-id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                            >\n                              <span data-current-value>\n                                {{- selected_value | default: choose_an_option -}}\n                              </span>\n                              <svg\n                                class=\"t4s-icon-select-arrow\"\n                                role=\"presentation\"\n                                viewBox=\"0 0 19 12\"\n                              >\n                                <use xlink:href=\"#t4s-select-arrow\"></use>\n                              </svg>\n                            </button>\n                            <div\n                              data-dropdown-wrapper\n                              class=\"t4s-dropdown__wrapper t4s-current-scrollbar\"\n                              id=\"t4s_nt_{{ pr_sid }}{{ forloop.index }}\"\n                            >\n                              <div class=\"t4s-drop-arrow\"></div>\n                              <div class=\"t4s-dropdown__content\">\n                                {%- for value in option.values -%}\n                                  <div\n                                    data-swatch-item\n                                    data-dropdown-off\n                                    class=\"t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}\"\n                                    data-value=\"{{ value | escape }}\"\n                                  >\n                                    {{ value | replace: '\"', '' }}\n                                  </div>\n                                {%- endfor -%}\n                              </div>\n                            </div>\n                          {%- endif -%}\n                        </div>\n                      {%- endunless -%}\n                    </div>\n\n                    {%- comment %} Custom order notice - shown when custom option is selected {%- endcomment %}\n                    {%- assign show_custom_notice = false -%}\n                    {%- for custom_val in custom_values_array -%}\n                      {%- if selected_value == custom_val -%}\n                        {%- assign show_custom_notice = true -%}\n                        {%- break -%}\n                      {%- endif -%}\n                    {%- endfor -%}\n                    <div\n                      class=\"pfd-custom-notice\"\n                      style=\"display: {% if show_custom_notice %}block{% else %}none{% endif %};\"\n                    >\n                      <div class=\"pfd-custom-notice-content\">\n                        <svg\n                          class=\"pfd-custom-notice-icon\"\n                          xmlns=\"http://www.w3.org/2000/svg\"\n                          width=\"24\"\n                          height=\"24\"\n                          viewBox=\"0 0 24 24\"\n                          fill=\"none\"\n                          stroke=\"currentColor\"\n                          stroke-width=\"2\"\n                          stroke-linecap=\"round\"\n                          stroke-linejoin=\"round\"\n                        >\n                          <circle cx=\"12\" cy=\"12\" r=\"10\"></circle>\n                          <polyline points=\"12 6 12 12 16 14\"></polyline>\n                        </svg>\n                        <p class=\"pfd-custom-notice-text\">\n                          Custom {{ option_name | downcase }}s are <strong>made to order</strong>. Please allow\n                          <span class=\"pfd-custom-notice-highlight\">6-8 weeks</span> for delivery.\n                        </p>\n                      </div>\n                    </div>\n\n                    {%- comment %} Configuration-based custom content for options {%- endcomment %}\n                    {%- comment %} Renders ALL matching option content, shows only the selected one {%- endcomment %}\n                    {%- assign option_name_lower = option_name | downcase -%}\n                    {%- assign selected_value_lower = selected_value | downcase -%}\n\n                    {%- capture all_option_info -%}\n  {%- for pair in option_content_pairs -%}\n    {%- assign pair_cleaned = pair | strip -%}\n    {%- if pair_cleaned contains '|' -%}\n      {%- assign parts = pair_cleaned | split: '|' -%}\n      {%- assign option_key_full = parts[0] | strip -%}\n      {%- assign content_value = parts[1] | strip -%}\n\n      {%- if option_key_full contains ':' -%}\n        {%- assign key_parts = option_key_full | split: ':' -%}\n        {%- assign option_key = key_parts[0] | strip | downcase -%}\n        {%- assign value_key = key_parts[1] | strip -%}\n        {%- assign value_key_lower = value_key | downcase -%}\n\n        {%- if option_name_lower == option_key -%}\n          {%- assign is_selected = false -%}\n          {%- if selected_value_lower == value_key_lower -%}\n            {%- assign is_selected = true -%}\n          {%- endif -%}\n          <div class=\"pfd-option-info-item\"\n               data-option-name=\"{{ option_name_lower }}\"\n               data-option-value=\"{{ value_key | handle }}\"\n               style=\"{% unless is_selected %}display: none;{% endunless %}\">\n            {{ content_value }}\n          </div>\n        {%- endif -%}\n      {%- endif -%}\n    {%- endif -%}\n  {%- endfor -%}\n{%- endcapture -%}\n\n                    {%- assign all_option_info_stripped = all_option_info | strip -%}\n                    {%- if all_option_info_stripped != blank -%}\n                      <div class=\"pfd-custom-option-info\" data-option-info-container=\"{{ option_name_lower }}\">\n                        {{ all_option_info }}\n                      </div>\n                    {%- endif -%}\n                  </div>\n                {%- endif -%}\n              {%- endfor -%}\n            </div>\n          {%- endif -%}\n\n          {%- liquid\n            if arr_properties.size > 0 and isProductAvailable\n              render 'frm_properties', arr_properties: arr_properties, product: product\n            endif\n          -%}\n\n          {%- if use_incoming_mess\n            and current_variant_incoming\n            and pr_variants.size == 1\n            and current_variant.next_incoming_date != blank\n          -%}\n            {%- assign format_date = current_variant.next_incoming_date | date: date_in -%}\n            {%- comment -%}<div class=\"t4s-incoming__mess\"><!-- will_not_ship_until / will_be_in_stock_after --></div>{%- endcomment -%}\n\n          {%- elsif use_incoming_mess and pr_variants.size > 1 -%}\n            {%- liquid\n              assign format_date = current_variant.next_incoming_date | date: date_in\n              unless format_date\n                assign format_date = '19041994'\n              endunless\n            -%}\n            {%- comment -%}<div data-incoming__mess class=\"t4s-incoming__mess\"><!-- will_not_ship_until / will_be_in_stock_after with incoming date --></div>{%- endcomment -%}\n\n          {%- endif -%}\n\n          {{ 'button-style.css' | asset_url | stylesheet_tag }}\n          <link\n            href=\"{{ 'custom-effect.css' | asset_url }}\"\n            rel=\"stylesheet\"\n            media=\"print\"\n            onload=\"this.media='all'\"\n          >\n\n          {{- html_price -}}\n\n          <div\n            class=\"t4s-product-form__buttons\"\n            style=\"--pr-btn-round: {{ bk_stts.pr_btn_round }}px;--wis-cp-btn-round: {{ bk_stts.wis_cp_btn_round }}px;\"\n          >\n            <div class=\"t4s-pr__qty_cart t4s-d-flex t4s-flex-wrap\">\n              {%- if isExternal -%}\n                <a\n                  href=\"{{ external_link }}\"\n                  rel=\"nofollow\"\n                  target=\"_blank\"\n                  class=\"t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ bk_stts.button_style }} t4s-btn-color-{{ bk_stts.button_color }} t4s-w-100 t4s-justify-content-center {% if bk_stts.button_style == 'default' or bk_stts.button_style == 'outline' %} t4s-btn-effect-{{ bk_stts.button_effect }}{% endif %} t4s-truncate is--btn-external t4s-btn-loading__svg\"\n                >\n                  {%- if bk_stts.btn_icon -%}\n                    <svg class=\"t4s-btn-icon\" viewBox=\"0 0 24 24\">\n                      <use xlink:href=\"#t4s-icon-atc\"></use>\n                    </svg>\n                  {%- endif -%}\n                  <span class=\"t4s-btn-atc_text\">\n                    {{- external_title -}}\n                  </span>\n                  <span class=\"t4s-loading__spinner\" hidden>\n                    <svg\n                      width=\"16\"\n                      height=\"16\"\n                      hidden\n                      class=\"t4s-svg-spinner\"\n                      focusable=\"false\"\n                      role=\"presentation\"\n                      viewBox=\"0 0 66 66\"\n                      xmlns=\"http://www.w3.org/2000/svg\"\n                    >\n                      <circle class=\"t4s-path\" fill=\"none\" stroke-width=\"6\" cx=\"33\" cy=\"33\" r=\"30\"></circle>\n                    </svg>\n                  </span>\n                </a>\n              {%- else -%}\n                {%- if bk_stts.show_qty and isProductAvailable -%}\n                  <div\n                    data-quantity-wrapper\n                    class=\"t4s-quantity-wrapper t4s-product-form__qty\"\n                  >\n                    <button\n                      data-quantity-selector\n                      data-decrease-qty\n                      type=\"button\"\n                      class=\"t4s-quantity-selector is--minus\"\n                    ></button>\n                    <input\n                      data-quantity-value\n                      type=\"number\"\n                      class=\"t4s-quantity-input\"\n                      step=\"1\"\n                      min=\"{{cus_qty}}\"\n                      max=\"{{max_qty}}\"\n                      name=\"quantity\"\n                      value=\"{{cus_qty}}\"\n                      size=\"4\"\n                      pattern=\"[0-9]*\"\n                      inputmode=\"numeric\"\n                    >\n                    <button\n                      data-quantity-selector\n                      data-increase-qty\n                      type=\"button\"\n                      class=\"t4s-quantity-selector is--plus\"\n                    ></button>\n                  </div>\n                {%- else -%}\n                  <input type=\"hidden\" name=\"quantity\" value=\"1\">\n                {%- endif -%}\n                {% if customer %}\n                  <button\n                    data-animation-atc='{ \"ani\": \"{{ bk_stts.ani }}\",\"time\": {{ bk_stts.time }}000 }'\n                    type=\"submit\"\n                    name=\"add\"\n                    data-atc-form\n                    class=\"t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ bk_stts.button_style }} t4s-btn-color-{{ bk_stts.button_color }} t4s-w-100 t4s-justify-content-center {% if bk_stts.button_style == 'default' or bk_stts.button_style == 'outline' %} t4s-btn-effect-{{ bk_stts.button_effect }}{% endif %} t4s-btn-loading__svg\"\n                    {% unless current_variant_available %}\n                      aria-disabled=\"true\"\n                    {% endunless -%}\n                    {% unless isProductAvailable %}\n                      disabled=\"disabled\"\n                    {% endunless %}\n                  >\n                    {%- if bk_stts.btn_icon -%}\n                      <svg\n                        class=\"t4s-btn-icon\"\n                        viewBox=\"0 0 24 24\"\n                      >\n                        <use xlink:href=\"#t4s-icon-atc\"></use>\n                      </svg>\n                    {%- endif -%}\n                    <span class=\"t4s-btn-atc_text\">\n                      {%- if current_variant_available == false or isProductAvailable == false -%}\n                        {{- 'products.product.sold_out' | t -}}\n                      {%- elsif isPreoder -%}\n                        {{- 'products.product.pre_order' | t }}\n                      {%- else -%}\n                        {{ 'products.product.add_to_cart' | t }}\n                      {%- endif -%}\n                    </span>\n                    <span class=\"t4s-loading__spinner\" hidden>\n                      <svg\n                        width=\"16\"\n                        height=\"16\"\n                        hidden\n                        class=\"t4s-svg-spinner\"\n                        focusable=\"false\"\n                        role=\"presentation\"\n                        viewBox=\"0 0 66 66\"\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                      >\n                        <circle class=\"t4s-path\" fill=\"none\" stroke-width=\"6\" cx=\"33\" cy=\"33\" r=\"30\"></circle>\n                      </svg>\n                    </span>\n                  </button>\n                {% else %}\n                  <a\n                    href=\"/account/login\"\n                    onclick=\"rememberPage(event)\"\n                    data-drawer-delay-\n                    data-drawer-options='{ \"id\": \"#t4s-login-sidebar\" }'\n                    class=\"atc-btn t4s-btn t4s-btn-base t4s-btn-style-default t4s-btn-color-dark t4s-w-100 t4s-justify-content-center t4s-btn-effect-sweep-to-right t4s-btn-loading__svg\"\n                  >\n                    <svg\n                      class=\"t4s-btn-icon\"\n                      viewBox=\"0 0 24 24\"\n                      style=\"margin-right:4px\"\n                    >\n                      <use xlink:href=\"#t4s-icon-atc\"></use>\n                    </svg>\n                    <span class=\"t4s-btn-atc_text\">Login to Shop</span>\n                    <span class=\"t4s-loading__spinner\" hidden=\"\">\n                      <svg\n                        width=\"16\"\n                        height=\"16\"\n                        hidden=\"\"\n                        class=\"t4s-svg-spinner\"\n                        focusable=\"false\"\n                        role=\"presentation\"\n                        viewBox=\"0 0 66 66\"\n                        xmlns=\"http://www.w3.org/2000/svg\"\n                      >\n                        <circle class=\"t4s-path\" fill=\"none\" stroke-width=\"6\" cx=\"33\" cy=\"33\" r=\"30\"></circle>\n                      </svg>\n                    </span>\n                  </a>\n                {% endif %}\n              {%- endif -%}\n            </div>\n            {%- if PR_buy_pr and type != 'main_sticky' %}\n              {{- form | payment_button -}}\n            {% endif -%}\n            {%- if settings.use_notify_me -%}\n              {% if customer -%}\n                <button\n                  data-class=\"t4s-mfp-btn-close-inline\"\n                  data-id=\"t4s-pr-popup__notify-stock\"\n                  data-storageid=\"notify-stock{{ current_variant.id }}\"\n                  data-mfp-src\n                  data-open-mfp-ajax\n                  class=\"t4s-pr__notify-stock{% if current_variant_available or current_variant == blank %} t4s-d-none{% endif %}\"\n                  type=\"button\"\n                  data-notify-stock-btn\n                  data-variant-id=\"{{ current_variant.id }}\"\n                  data-root-url=\"{{ routes.root_url }}\"\n                >\n                  {{ 'products.notify_stock.trigger' | t }}\n                </button>\n              {%- endif %}\n            {%- endif -%}\n            {%- if bk_stts.enable_wishlist or bk_stts.enable_compare -%}\n              <div class=\"t4s-pr__wis_cp\">\n                {%- render 't4s_wis_cp', product: product, bk_stts: bk_stts, disableTooltip: true -%}\n              </div>\n            {%- endif -%}\n          </div>\n        {%- endform -%}\n        {%- unless isProductDefault or type == 'main_sticky' -%}\n          <script type=\"application/json\" class=\"pr_variants_json\">\n            {{ shsd_product_variants | json }}\n          </script>\n          <script type=\"application/json\" class=\"pr_options_json\">\n            {{ shsd_product_options_with_values | json }}\n          </script>\n        {%- endunless -%}\n        {%- if bk_stts.ani != 'none' -%}\n          <link\n            href=\"{{ 'ani-atc.min.css' | asset_url }}\"\n            rel=\"stylesheet\"\n            media=\"print\"\n            onload=\"this.media='all'\"\n          >\n        {%- endif -%}\n      </div>\n    </div>\n  </div>\n\n  <script>\n    (function () {\n      'use strict';\n\n      function updateOptionInfo(container, selectedValue) {\n        var optionName = container.getAttribute('data-option-name');\n        if (!optionName) return;\n        optionName = optionName.toLowerCase();\n\n        var infoContainer = container.querySelector('[data-option-info-container=\"' + optionName + '\"]');\n        if (!infoContainer) return;\n\n        var valueHandle = selectedValue\n          .toLowerCase()\n          .replace(/\\s+/g, '-')\n          .replace(/[^a-z0-9-]/g, '');\n        var infoItems = infoContainer.querySelectorAll('.pfd-option-info-item');\n\n        infoItems.forEach(function (item) {\n          var itemValue = item.getAttribute('data-option-value');\n          item.style.display = itemValue === valueHandle ? '' : 'none';\n        });\n      }\n\n      function initOptionInfoHandler() {\n        var swatchContainers = document.querySelectorAll('[data-swatch-option]');\n\n        swatchContainers.forEach(function (container) {\n          // Method 1: MutationObserver for instant updates\n          var observer = new MutationObserver(function (mutations) {\n            mutations.forEach(function (mutation) {\n              if (mutation.type === 'attributes' && mutation.attributeName === 'class') {\n                var target = mutation.target;\n                if (target.classList.contains('is--selected') && target.hasAttribute('data-value')) {\n                  var selectedValue = target.getAttribute('data-value');\n                  updateOptionInfo(container, selectedValue);\n                }\n              }\n            });\n          });\n\n          observer.observe(container, {\n            attributes: true,\n            subtree: true,\n            attributeFilter: ['class'],\n          });\n\n          // Method 2: Backup click handler with small delay\n          var swatchItems = container.querySelectorAll('[data-swatch-item]');\n          swatchItems.forEach(function (swatch) {\n            swatch.addEventListener('click', function () {\n              var selectedValue = this.getAttribute('data-value');\n              if (!selectedValue) return;\n              setTimeout(function () {\n                updateOptionInfo(container, selectedValue);\n              }, 10);\n            });\n          });\n        });\n      }\n\n      if (document.readyState === 'loading') {\n        document.addEventListener('DOMContentLoaded', initOptionInfoHandler);\n      } else {\n        initOptionInfoHandler();\n      }\n\n      document.addEventListener('shopify:section:load', initOptionInfoHandler);\n    })();\n  </script>\n</div>\n{%- if PR_buy_pr and current_variant_available != true and type != 'main_sticky' -%}\n  <style>\n    #t4s-callBackVariant{{ product_form_id }} .shopify-payment-button { display: none;}\n  </style>\n{% endif -%}\n",
              "reasoning": "Filter available lengths to only those numerically greater than the currently selected length. Also fix custom_option_names exclusion to use `contains` (matching the non-color branch pattern) instead of exact equality, and extract selected_length_num once before the loop."
            },
            "result": "Tracked change for product-form-dynamic.liquid (1351 lines).",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "edit_lines",
            "id": "toolu_01QweAjSvwWpnYFu8F2vLQzw",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "startLine": 415,
              "endLine": 452,
              "newContent": "                            {%- comment %} Compute available standard lengths (longer than current selection) for this color {%- endcomment -%}\n                            {%- assign avail_lengths = '' -%}\n                            {%- assign avail_lengths_seen = '' -%}\n                            {%- assign length_opt_key = 'option' | append: length_option_position -%}\n                            {%- comment %} Get the currently selected length as a number for comparison {%- endcomment -%}\n                            {%- assign selected_length_key = 'option' | append: length_option_position -%}\n                            {%- assign selected_length_raw = product.selected_or_first_available_variant[selected_length_key] | replace: '\"', '' | strip -%}\n                            {%- assign selected_length_num = selected_length_raw | times: 1 -%}\n                            {%- if length_option_position > 0 and color_option_position > 0 -%}\n                              {%- for lv in shsd_product_variants -%}\n                                {%- assign v_color_key = 'option' | append: color_option_position -%}\n                                {%- assign v_color_val = lv[v_color_key] | handle -%}\n                                {%- if v_color_val == color_handle and lv.available -%}\n                                  {%- assign v_length_val = lv[length_opt_key] -%}\n                                  {%- if v_length_val != blank -%}\n                                    {%- assign is_custom_length = false -%}\n                                    {%- if custom_option_names -%}\n                                      {%- for custom_name in custom_option_names -%}\n                                        {%- assign custom_name_stripped = custom_name | strip -%}\n                                        {%- if v_length_val contains custom_name_stripped -%}\n                                          {%- assign is_custom_length = true -%}\n                                          {%- break -%}\n                                        {%- endif -%}\n                                      {%- endfor -%}\n                                    {%- endif -%}\n                                    {%- unless is_custom_length -%}\n                                      {%- assign v_length_clean = v_length_val | replace: '\"', '' | strip -%}\n                                      {%- assign v_length_num = v_length_clean | times: 1 -%}\n                                      {%- comment %} Only include lengths strictly greater than the currently selected length {%- endcomment -%}\n                                      {%- if selected_length_num == 0 or v_length_num > selected_length_num -%}\n                                        {%- assign sentinel = '@@' | append: v_length_clean | append: '@@' -%}\n                                        {%- unless avail_lengths_seen contains sentinel -%}\n                                          {%- assign avail_lengths_seen = avail_lengths_seen | append: sentinel -%}\n                                          {%- if avail_lengths == '' -%}\n                                            {%- assign avail_lengths = v_length_clean -%}\n                                          {%- else -%}\n                                            {%- assign avail_lengths = avail_lengths | append: ', ' | append: v_length_clean -%}\n                                          {%- endif -%}\n                                        {%- endunless -%}\n                                      {%- endif -%}\n                                    {%- endunless -%}\n                                  {%- endif -%}\n                                {%- endif -%}\n                              {%- endfor -%}\n                            {%- endif -%}",
              "reasoning": "Filter available lengths to only those numerically greater than the currently selected length. Also fix custom_option_names exclusion to use `contains` (matching the non-color branch pattern) instead of exact equality, and extract selected_length_num once before the loop."
            },
            "result": "Lines 415-452 replaced in product-form-dynamic.liquid (1351 total lines).",
            "isError": false,
            "elapsedMs": 0
          },
          {
            "name": "read_lines",
            "id": "toolu_01XymzgJfc9NwA8gAHbtroDb",
            "input": {
              "filePath": "snippets/product-form-dynamic.liquid",
              "ranges": [
                {
                  "startLine": 546,
                  "endLine": 590
                }
              ]
            },
            "result": "--- product-form-dynamic.liquid lines 544-592 ---\n  544|                             {%- endfor -%}\n  545| \n  546|                             {%- comment %} Compute available standard lengths for this color {%- endcomment -%}\n  547|                             {%- assign avail_lengths = '' -%}\n  548|                             {%- assign avail_lengths_seen = '' -%}\n  549|                             {%- assign length_opt_key = 'option' | append: length_option_position -%}\n  550|                             {%- if length_option_position > 0 and color_option_position > 0 -%}\n  551|                               {%- for lv in shsd_product_variants -%}\n  552|                                 {%- assign v_color_key = 'option' | append: color_option_position -%}\n  553|                                 {%- assign v_color_val = lv[v_color_key] | handle -%}\n  554|                                 {%- if v_color_val == color_handle and lv.available -%}\n  555|                                   {%- assign v_length_val = lv[length_opt_key] -%}\n  556|                                   {%- if v_length_val != blank -%}\n  557|                                     {%- assign is_custom_length = false -%}\n  558|                                     {%- if custom_option_names -%}\n  559|                                       {%- for custom_name in custom_option_names -%}\n  560|                                         {%- assign custom_name_stripped = custom_name | strip -%}\n  561|                                         {%- if v_length_val == custom_name_stripped -%}\n  562|                                           {%- assign is_custom_length = true -%}\n  563|                                           {%- break -%}\n  564|                                         {%- endif -%}\n  565|                                       {%- endfor -%}\n  566|                                     {%- endif -%}\n  567|                                     {%- unless is_custom_length -%}\n  568|                     \n... [truncated 1928 chars]",
            "isError": false,
            "elapsedMs": 0
          }
        ],
        "reasoningBlocks": [],
        "responseText": "",
        "outcome": {
          "status": "applied",
          "changedFiles": 1,
          "changeSummary": "product-form-dynamic.liquid: Filter available lengths to only those numerically greater than the currently selected length. Also fix custom_option_names exclusion to use `contains` (matching the non-color branch pattern) instead of exact equality, and extract selected_length_num once before the loop.",
          "validationIssues": [
            {
              "gate": "syntax",
              "errors": [
                "templates/page.ecom-deadfest2025.json:0 — Invalid JSON in template file",
                "templates/article.portfolio.json:0 — Invalid JSON in template file",
                "templates/page.ecom-deaducation-live-phoenix.json:0 — Invalid JSON in template file",
                "templates/index.ecom-preview-home.json:0 — Invalid JSON in template file",
                "templates/index.ecom-preview-page.json:0 — Invalid JSON in template file"
              ],
              "changesKept": true
            },
            {
              "gate": "theme_check",
              "errors": [
                "templates/page.ecom-deadfest2025.json — Invalid JSON in template file",
                "templates/article.portfolio.json — Invalid JSON in template file",
                "templates/page.ecom-deaducation-live-phoenix.json — Invalid JSON in template file",
                "templates/index.ecom-preview-home.json — Invalid JSON in template file",
                "templates/index.ecom-preview-page.json — Invalid JSON in template file"
              ],
              "changesKept": true
            }
          ]
        },
        "metrics": {
          "totalToolCalls": 20,
          "editToolCalls": 2,
          "readToolCalls": 18,
          "searchToolCalls": 0,
          "elapsedMs": 149842,
          "costCents": 0,
          "inputTokens": 0,
          "outputTokens": 0
        }
      },
      "analysis": {
        "diagnosis": {
          "summary": "Agent successfully identified and edited the Liquid template file (product-form-dynamic.liquid) but FAILED to implement the complete three-layer requirement. Only 1 file was changed (Liquid markup) when the prompt explicitly required all three layers: (1) Liquid markup, (2) CSS styling, and (3) JavaScript behavior. The agent read all three files (lines 1-20 in tool sequence show reads of .liquid, .js, and .css), analyzed them extensively, but only proposed and executed a single edit to the Liquid file. The CSS and JS files were never modified despite being core to the requirements (contrast-aware styling and variant option1 data handling).",
          "rootCause": "The coordinator's iteration loop terminated prematurely after the first successful edit, likely due to stagnation detection or context exhaustion. The agent did not re-enter the think-tool-observe cycle to apply CSS and JS changes. The PM prompt may have insufficiently emphasized the multi-layer requirement as a single atomic task, allowing the agent to treat the completion of one layer as task completion. No validation gate enforced that all three layers must be modified before considering the task complete.",
          "agentBehavior": "1. Scout loaded context (606 files, 5 prefs). 2. Classified as COMPLEX tier → GOD_MODE strategy → Sonnet-4-6 model. 3. Agent read all three target files sequentially (tools 1-17: 18 reads across .liquid, .js, .css). 4. Agent proposed edit to Liquid (tool 18: propose_code_edit). 5. Agent executed Liquid edit (tool 19: edit_lines, lines 415-452). 6. Agent read partial context again (tool 20: lines 544-592 of Liquid). 7. Loop terminated. No CSS or JS edits were proposed or executed. Total: 20 tool calls, 2 edits (only 1 actually executed per summary), 18 reads, 0 searches."
        },
        "recommendations": [
          {
            "priority": "critical",
            "category": "prompt",
            "title": "Enforce multi-layer atomic completion in PM system prompt",
            "description": "The v2-pm-prompt.ts must explicitly state that multi-layer requirements (Liquid + CSS + JS, or similar) are a single atomic task unit. The agent must not consider the task complete until ALL specified layers are modified. Add a validation checklist pattern that requires the agent to confirm completion of each layer before concluding.",
            "targetFile": "lib/agents/prompts/v2-pm-prompt.ts",
            "targetArea": "System prompt instruction section (after tool definitions, before examples)",
            "suggestedChange": "Add instruction block:\n```\nWhen a request specifies multiple implementation layers (e.g., Liquid markup + CSS + JavaScript),\ntreat it as a single atomic task. Do NOT conclude the task is complete until you have:\n1. Modified the Liquid/template layer\n2. Modified the CSS/styling layer\n3. Modified the JavaScript/behavior layer\nBefore responding with task completion, explicitly confirm in your reasoning:\n  - Layer 1 (Liquid): [file path] modified ✓\n  - Layer 2 (CSS): [file path] modified ✓\n  - Layer 3 (JS): [file path] modified ✓\nIf any layer remains unmodified, continue iterating until all are complete.\n```"
          },
          {
            "priority": "critical",
            "category": "validation",
            "title": "Add orchestration policy gate for multi-layer task completion",
            "description": "The orchestration-policy.ts must enforce a validation rule that detects multi-layer requirements and prevents task completion until all specified layers are modified. This gate should run before the coordinator allows the loop to exit.",
            "targetFile": "lib/agents/orchestration-policy.ts",
            "targetArea": "Context gates and validation rules section",
            "suggestedChange": "Add new validation rule:\n```typescript\nfunction validateMultiLayerCompletion(originalPrompt: string, filesModified: Set<string>): ValidationResult {\n  const layerPatterns = [\n    { name: 'Liquid', pattern: /liquid|markup|template/i, filePattern: /\\.liquid$/ },\n    { name: 'CSS', pattern: /css|styling|style/i, filePattern: /\\.css$/ },\n    { name: 'JavaScript', pattern: /javascript|js|behavior|script|event/i, filePattern: /\\.js$/ }\n  ];\n  \n  const requiredLayers = layerPatterns.filter(l => l.pattern.test(originalPrompt));\n  const completedLayers = requiredLayers.filter(l => \n    Array.from(filesModified).some(f => l.filePattern.test(f))\n  );\n  \n  if (requiredLayers.length > 0 && completedLayers.length < requiredLayers.length) {\n    return {\n      isValid: false,\n      reason: `Multi-layer task incomplete: ${requiredLayers.length} layers required, ${completedLayers.length} completed`,\n      blockedLayers: requiredLayers.filter(l => !completedLayers.includes(l)).map(l => l.name)\n    };\n  }\n  return { isValid: true };\n}\n```"
          },
          {
            "priority": "high",
            "category": "coordinator",
            "title": "Prevent premature loop termination after single-layer edits",
            "description": "The coordinator-v2.ts iteration loop is terminating too early. After executing an edit, the coordinator should check whether the original task requires additional file modifications before allowing exit. Stagnation detection or iteration limits may be firing incorrectly when the agent has only completed one of multiple required layers.",
            "targetFile": "lib/agents/coordinator-v2.ts",
            "targetArea": "Main loop exit conditions (around iteration limit checks and stagnation detection)",
            "suggestedChange": "Before allowing loop exit after a successful edit, add check:\n```typescript\nif (lastToolWasEdit && editedFiles.size > 0) {\n  const validationResult = await orchestrationPolicy.validateMultiLayerCompletion(\n    originalPrompt,\n    editedFiles\n  );\n  if (!validationResult.isValid) {\n    // Do not exit loop; continue iterating\n    console.log(`[coordinator] Multi-layer task incomplete. Blocked layers: ${validationResult.blockedLayers.join(', ')}`);\n    // Force another iteration instead of exiting\n    continue; // or adjust iteration limit to allow more iterations\n  }\n}\n```"
          },
          {
            "priority": "high",
            "category": "prompt",
            "title": "Add explicit task breakdown checklist for multi-layer requirements",
            "description": "The PM prompt should include a structured checklist pattern that forces the agent to plan and track completion of each layer. This should appear early in the agent's reasoning, not just in the final response.",
            "targetFile": "lib/agents/prompts/v2-pm-prompt.ts",
            "targetArea": "Tool instruction section, after tool definitions",
            "suggestedChange": "Add instruction:\n```\nFor multi-layer tasks, use this checklist pattern in your thinking:\n\n## Task Breakdown Checklist\n- [ ] Layer 1: [description] → File: [path]\n- [ ] Layer 2: [description] → File: [path]\n- [ ] Layer 3: [description] → File: [path]\n\nAfter each edit, update the checklist. Do not conclude until all boxes are checked.\nIf you complete one layer and the checklist shows unchecked items, explicitly state:\n\"Continuing to next layer: [layer name] in [file path]\"\n```"
          },
          {
            "priority": "high",
            "category": "context",
            "title": "Ensure theme map pre-loads all three target files for multi-layer tasks",
            "description": "The scout/structural-scout.ts and theme-map/lookup.ts may not be pre-loading all required files when a multi-layer task is detected. The brief should explicitly include all three files (Liquid, CSS, JS) in the initial context to signal their importance and prevent the agent from forgetting them.",
            "targetFile": "lib/agents/scout/structural-scout.ts",
            "targetArea": "Structural brief generation logic",
            "suggestedChange": "When generating brief for multi-layer tasks, ensure all target files are included:\n```typescript\nfunction detectMultiLayerTargets(prompt: string, themeMap: ThemeMap): string[] {\n  const targets = [];\n  if (/liquid|markup|template/i.test(prompt)) targets.push(...themeMap.find('snippets', /product-form-dynamic\\.liquid/));\n  if (/css|styling|style/i.test(prompt)) targets.push(...themeMap.find('assets', /product-form-dynamic\\.css/));\n  if (/javascript|js|behavior|script/i.test(prompt)) targets.push(...themeMap.find('assets', /product-form-dynamic\\.js/));\n  return targets;\n}\n// Include these in the brief with explicit markers: \"[LAYER 1]\", \"[LAYER 2]\", \"[LAYER 3]\"\n```"
          },
          {
            "priority": "medium",
            "category": "tools",
            "title": "Add multi-layer task tracking to tool executor",
            "description": "The v2-tool-executor.ts should track which files have been edited and which are still pending for multi-layer tasks. This metadata should be passed back to the coordinator to inform loop continuation decisions.",
            "targetFile": "lib/agents/tools/v2-tool-executor.ts",
            "targetArea": "Tool execution response structure",
            "suggestedChange": "Extend tool response metadata:\n```typescript\ninterface ToolExecutionResult {\n  output: string;\n  success: boolean;\n  toolName: string;\n  metadata?: {\n    editedFile?: string;\n    editedLines?: [number, number];\n    multiLayerStatus?: {\n      requiredLayers: string[];\n      completedLayers: string[];\n      pendingLayers: string[];\n    };\n  };\n}\n```"
          },
          {
            "priority": "medium",
            "category": "strategy",
            "title": "Adjust GOD_MODE iteration limits for multi-layer tasks",
            "description": "For COMPLEX tier with GOD_MODE strategy, the iteration limit (max 80) may be set too conservatively, or stagnation detection is firing when the agent is legitimately working through multiple layers. The strategy.ts should increase iteration allowance or disable stagnation checks when multi-layer completion is pending.",
            "targetFile": "lib/agents/strategy.ts",
            "targetArea": "GOD_MODE strategy configuration and iteration limits",
            "suggestedChange": "Modify strategy selection:\n```typescript\nif (isMultiLayerTask && strategy === 'GOD_MODE') {\n  return {\n    ...godModeConfig,\n    maxIterations: 120, // Increased from 80\n    stagnationThreshold: 0.15, // Relaxed from 0.10 to allow more iterations\n    allowConsecutiveReads: true // Allow multiple read phases\n  };\n}\n```"
          },
          {
            "priority": "low",
            "category": "prompt",
            "title": "Add explicit ordering guidance for multi-layer edits",
            "description": "The PM prompt should suggest a recommended order for applying multi-layer changes (typically: Liquid first, then CSS, then JS) to ensure logical dependency ordering and to make it easier for the agent to track progress.",
            "targetFile": "lib/agents/prompts/v2-pm-prompt.ts",
            "targetArea": "General guidance section",
            "suggestedChange": "Add guidance:\n```\nFor multi-layer Shopify theme modifications, apply changes in this order:\n1. Liquid/Template layer (defines structure and data availability)\n2. CSS/Styling layer (applies visual changes, depends on Liquid markup)\n3. JavaScript/Behavior layer (adds interactivity, depends on both Liquid and CSS)\nThis ordering ensures dependencies are satisfied and makes testing incremental.\n```"
          }
        ]
      }
    }
  ],
  "summary": {
    "passRate": "1/1 (100%)",
    "avgToolCalls": 20,
    "avgTimeSeconds": 150,
    "totalCostCents": 0,
    "failureReasons": []
  },
  "aggregateAnalysis": {
    "diagnosis": {
      "summary": "Single successful run with 100% pass rate. Agent executed methodical file exploration (16 read_lines calls) followed by structured code implementation (propose_code_edit + edit_lines). No errors or failures detected. Agent demonstrated effective context gathering before implementation.",
      "rootCause": "Not applicable — no failures observed. This is a baseline success case showing optimal agent behavior for multi-layer implementation tasks.",
      "agentBehavior": "Agent followed systematic exploration → planning → implementation pattern. Extensive initial reads (16 calls) suggest thorough file structure understanding before proposing changes. Single propose_code_edit followed by edit_lines indicates confident, focused implementation without iterative corrections."
    },
    "recommendations": [
      {
        "priority": "high",
        "category": "coordinator",
        "title": "Establish baseline metrics for read-before-edit ratio",
        "description": "Run 1 used 16 reads before proposing edits (80% of tool calls were reads). Document this as optimal baseline for multi-file implementation tasks. Add coordinator instrumentation to track and alert if future runs deviate significantly below this ratio, which could indicate insufficient context gathering.",
        "targetFile": "lib/agents/coordinator-v2.ts",
        "targetArea": "iteration loop, context validation gates",
        "suggestedChange": "Add optional instrumentation to track read/edit ratio per task complexity tier. For HYBRID/GOD_MODE tasks with 3+ files, warn if read_calls < (total_calls * 0.6) before first edit proposal."
      },
      {
        "priority": "high",
        "category": "prompt",
        "title": "Document and enforce multi-file exploration pattern in PM prompt",
        "description": "The successful run's approach of reading all relevant files (product-form-dynamic.liquid, .css, .js, plus metafield context) before proposing changes should be encoded as a best practice in the PM system prompt. This prevents premature implementation on incomplete context.",
        "targetFile": "lib/agents/prompts/v2-pm-prompt.ts",
        "targetArea": "tool usage guidance section",
        "suggestedChange": "Add explicit guidance: 'For multi-layer implementations (markup + styling + behavior), read all target files completely BEFORE proposing first edit. Map data dependencies (e.g., metafield → JS → CSS) to ensure changes are coordinated.'"
      },
      {
        "priority": "medium",
        "category": "validation",
        "title": "Validate read completeness before edit proposal",
        "description": "Add orchestration policy check that requires agent to have read all files mentioned in the task description before allowing propose_code_edit tool invocation. This formalizes the pattern observed in Run 1.",
        "targetFile": "lib/agents/orchestration-policy.ts",
        "targetArea": "validation gates section",
        "suggestedChange": "Add gate: before propose_code_edit is allowed, verify task mentions N files and agent has issued read_lines for all N. Track file coverage in context state."
      },
      {
        "priority": "medium",
        "category": "context",
        "title": "Ensure metafield/variant data context is captured early",
        "description": "Run 1 succeeded partially because it read files that contained metafield references and variant structure. Formalize that tasks involving product data transformations should pre-populate context with relevant product schema, metafield definitions, and variant option structure.",
        "targetFile": "lib/agents/scout/structural-scout.ts",
        "targetArea": "brief generation for product-related tasks",
        "suggestedChange": "For tasks mentioning 'metafield' or 'variant option', automatically include product schema context in scout brief. Reference theme-map cached product structure if available."
      },
      {
        "priority": "medium",
        "category": "tools",
        "title": "Add tool for validating cross-file consistency",
        "description": "Run 1 succeeded with coordinated changes across 3 files. Add optional validation tool that checks CSS selectors match Liquid markup classes, and JS event handlers reference correct data attributes. This would catch coordination errors early.",
        "targetFile": "lib/agents/tools/v2-tool-definitions.ts",
        "targetArea": "tool schema definitions",
        "suggestedChange": "Add 'validate_cross_file_refs' tool: takes file list and checks (1) CSS selectors exist in markup, (2) JS data-attributes match Liquid output, (3) CSS variables referenced in JS are defined."
      },
      {
        "priority": "low",
        "category": "coordinator",
        "title": "Log successful read-edit patterns for future optimization",
        "description": "Run 1 is a clean success case. Capture the sequence of tool calls and context decisions for use as a training example for prompt refinement and strategy tuning.",
        "targetFile": "lib/agents/coordinator-v2.ts",
        "targetArea": "logging/telemetry section",
        "suggestedChange": "On successful completion, log: (1) read/edit ratio, (2) files read in order, (3) time between first read and first edit, (4) number of iterations. Use for statistical analysis of optimal patterns."
      }
    ],
    "patterns": {
      "consistentFailureMode": null,
      "intermittentIssues": [],
      "toolUsageAntiPatterns": [],
      "contextGaps": []
    }
  }
}