{% comment %} Custom options configuration - options listed here will render as dropdowns {% endcomment %}
{% assign custom_option_names = product.metafields.custom.custom_values.value %}

{% comment %} Custom content configuration for specific options {% endcomment %}
{% comment %} Format: option_name:option_value|<html content> - separated by semicolons for multiple {% endcomment %}

{% assign option_content_config = 'texture:Straight|<div class="pfd-info-content"><span class="pfd-info-icon">i</span><span class="pfd-info-text">Our straight texture has slight natural wave texture to it when washed and dried. It is not pin straight hair, nor is that desirable among most clientele.</span></div>;texture:Natural Wave|<div class="pfd-info-content"><span class="pfd-info-icon">i</span><span class="pfd-info-text">Our natural wave texture features soft, beachy waves that blend seamlessly with most natural hair textures. Low maintenance and versatile for everyday styling.</span></div>;texture:Loose Curl|<div class="pfd-info-content"><span class="pfd-info-icon">i</span><span class="pfd-info-text">Our loose curl texture offers bouncy, defined curls that hold their shape beautifully. Perfect for adding volume and movement with minimal styling required.</span></div>;texture:Tight Curl|<div class="pfd-info-content"><span class="pfd-info-icon">i</span><span class="pfd-info-text">Our tight curl texture provides well-defined, springy curls with maximum volume. Ideal for protective styles and blending with naturally curly hair.</span></div>' %}

{% assign option_content_pairs = option_content_config | split: ';' %}

{% comment %} SellersDash collect child product details {% endcomment %}
{% assign shsd_product_details = product.metafields.sellersdash.shsdproducts %}
{% if shsd_product_details.product_type == 'shsd_parent' %}
  {% assign shsd_product_handles = product.handle %}
  {% assign shsd_product_handles = shsd_product_handles
    | concat: shsd_product_details.handles
  %}
  {% for shsd_handle in shsd_product_handles %}
    {% assign shsd_single_product = all_products[shsd_handle] %}
    {% assign shsd_product_variants = shsd_product_variants
      | concat: shsd_single_product.variants
    %}
    {% assign shsd_product_media = shsd_product_media
      | concat: shsd_single_product.media
    %}
    {% assign shsd_product_images = shsd_product_images
      | concat: shsd_single_product.images
    %}
  {% endfor %}
  {% assign shsd_product_options_with_values = shsd_product_details.options_with_values %}
{% else %}
  {% assign shsd_product_options_with_values = product.options_with_values %}
  {% assign shsd_product_variants = product.variants %}
  {% assign shsd_product_media = product.media %}
  {% assign shsd_product_images = product.images %}
{% endif %}

{%- assign product_form_id = 'product-form-' | append: pr_sid -%}
{%- liquid
  assign pr_variants = shsd_product_variants
  assign PR_buy_pr = false
  if bk_stts.show_dynamic_checkout and isExternal == false and isProductAvailable
    assign PR_buy_pr = true
  endif
  assign choose_an_option = 'products.product.choose_an_option' | t
  assign date_in = settings.date_in
  assign class_frm = 't4s-form__product has--form__swatch'
  if isProductDefault
    assign class_frm = 't4s-form__product'
  endif
  if arr_properties.size > 0 and isProductAvailable
    assign class_frm = class_frm | append: ' has--properties'
  endif
  if settings.sticky_atc and type == 'main'
    assign class_frm = class_frm | append: ' is--main-sticky'
  else
    assign class_frm = class_frm | append: ' is--atc-sticky'
  endif

  assign color_swatch = 'disabled-'
  assign color_mode = bk_stts.color_mode
  assign selector_mode = bk_stts.selector_mode
  assign stt_color_ck = settings.color_ck | default: ';'
  assign color_ck = stt_color_ck | append: ',color,colors,couleur,colour' | remove: ';,'
  assign get_color = color_ck | downcase | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | uniq
  assign color_mode_list = 'color, color is-sw-cl__round, color is-sw-cl__round is-sw-cl__label, variant_image, variant_image is-sw-cl__round, variant_image is-sw-cl__round is-sw-cl__label' | split: ', '
  if color_mode_list contains color_mode
    assign color_swatch = 'is-sw__color '
  endif
  assign current_variant_available = current_variant.available
  assign use_incoming_mess = settings.use_incoming_mess
  assign current_variant_incoming = false
  assign current_inventory_quantity = current_variant.inventory_quantity
  if current_inventory_quantity <= 0 and current_variant.inventory_management == 'shopify' and current_variant.incoming
    assign current_variant_incoming = true
  endif
  if pos_sizeg == '1'
    assign html_sizeg = ''
  endif
  if current_variant.inventory_management != null and current_inventory_quantity > 0 and current_variant.inventory_policy != 'continue'
    assign max_qty = current_inventory_quantity
  else
    assign max_qty = 9999
  endif
  if color_mode contains 'color' or color_mode contains 'variant'
    assign show_tooltip = ''
  else
    assign show_tooltip = '-off'
  endif
-%}

{%- if product.metafields.custom.default_variant.value -%}
  <script>
    window.__HAS_SELECTED__ = {{ product.selected_variant | json }};
    window.__DEFAULT_VARIANT__ = {{ product.metafields.custom.default_variant.value | json }};
  </script>
{%- endif -%}

{%- comment -%} Load dropdown CSS if either color mode or selector mode is dropdown {%- endcomment -%}

{%- if color_mode == 'dropdown' or selector_mode == 'dropdown' -%}
  <link
    rel='stylesheet'
    href='{{ 'base_drop.min.css' | asset_url }}'
    media='all'
  >
{%- endif -%}

{%- comment -%} Custom CSS for product form dynamic {%- endcomment -%}
{{ 'product-form-dynamic.css' | asset_url | stylesheet_tag }}

<div class='pfd-override-wrapper'>
  <div class='pfd-custom-wrapper'>
    <div
      class='t4s-product-form__variants is-no-pick__{{ PR_no_pick }}{% if PR_buy_pr %} is-payment-btn-true t4s-payment-button t4s-btn-color-{{ bk_stts.button_color_payment }}{% endif %} is-remove-soldout-{{ remove_soldout }} is-btn-full-width__{{ bk_stts.btn_atc_full }} is-btn-atc-txt-{{ bk_stts.btn_txt }} is-btn-ck-txt-{{ bk_stts.btn_txt2 }} is--fist-ratio-{{ is_fit_ratio_img }}'
      style='{% if is_fit_ratio_img %} --fit-ratio-img: {{ first_ratio_img }}; {% endif %} --wishlist-color: {{bk_stts.wishlist_color}};--wishlist-hover-color: {{bk_stts.wishlist_color_hover}};--wishlist-active-color: {{bk_stts.wishlist_color_active}};--compare-color: {{bk_stts.compare_color}};--compare-hover-color: {{bk_stts.compare_color_hover}};--compare-active-color: {{bk_stts.compare_color_active}};'
      {{ shopify_attributes }}
    >
      <div data-callBackVariant id='t4s-callBackVariant{{ product_form_id }}'>
        {%- form 'product',
          product,
          id: product_form_id,
          data-productid: product.id,
          class: class_frm,
          novalidate: 'novalidate',
          data-type: 'add-to-cart-form',
          data-disable-swatch: isProductDefault
        -%}
          {% comment %}{{- form | payment_terms -}}{% endcomment %}
          {%- if isProductDefault -%}
            <input
              name='id'
              value='{{ pr_variants.first.id }}'
              type='hidden'
            >
            {%- if advance_pr_type != blank -%}
              {%- render 'choose_style',
                advance_pr_type: advance_pr_type,
                title: advance_label,
                pid: product.id
              -%}
            {%- endif -%}
          {%- else -%}
            {{ 'swatch.css' | asset_url | stylesheet_tag }}
            <select
              name='id'
              id='product-select-{{ pr_sid }}'
              class='t4s-product__select t4s-d-none'
            >
              {%- for variant in pr_variants -%}
                {%- if variant.available -%}
                  <option
                    data-option1='{{ variant.option1 }}'
                    data-option2='{{ variant.option2 }}'
                    value='{{ variant.id }}'
                    data-mdid='{{ variant.featured_media.id | json }}'
                    data-incoming='{{ variant.incoming }}'
                    data-inventoryQuantity='{{ variant.inventory_quantity | json }}'
                    data-inventoryPolicy='{{ variant.inventory_policy | json }}'
                    data-nextIncomingDate='{{ variant.next_incoming_date | date: date_in }}'
                    {% if variant.id == current_variant.id %}
                      selected='selected'
                    {% endif %}
                  >
                    {{ variant.title | escape }}
                  </option>
                {%- else -%}
                  <option
                    data-option1='{{ variant.option1 }}'
                    data-option2='{{ variant.option2 }}'
                    value='{{ variant.id }}'
                    data-mdid='{{ variant.featured_media.id | json }}'
                    data-incoming='{{ variant.incoming }}'
                    data-inventoryQuantity='{{ variant.inventory_quantity | json }}'
                    data-inventoryPolicy='{{ variant.inventory_policy | json }}'
                    data-nextIncomingDate='{{ variant.next_incoming_date | date: date_in }}'
                  >
                    {{ variant.title | escape }}
                  </option>
                {%- endif -%}
              {%- endfor -%}
            </select>

            <div class='pfd-variant-images' style='display:none !important;'>
              <div class='pfd-main-imgs'>
                {%- for variant in pr_variants -%}
                  {% assign var_imgs = variant.metafields.custom.variant_image.value %}
                  <div
                    class='pfd-img-listing'
                    data-var-img='{{ variant.image.src | img_url: 'master' }}'
                    data-pfd-variant-id='{{ variant.id }}'
                  >
                    {% for value in var_imgs %}
                      <div class='pfd-media-item'>
                        <img src='{{value | img_url: 'master'}}'>
                      </div>
                    {% endfor %}
                  </div>
                {%- endfor -%}
              </div>
              <div class='pfd-thumb-imgs'>
                {%- for variant in pr_variants -%}
                  {% assign var_imgs = variant.metafields.custom.variant_image.value %}
                  <div
                    class='pfd-img-listing'
                    data-pfd-variant-id='{{ variant.id }}'
                  >
                    {% for value in var_imgs %}
                      <div class='pfd-media-thumb'>
                        <div
                          class='pfd-img'
                          style="background-image:url('{{value | img_url: "master"}}');"
                        ></div>
                      </div>
                    {% endfor %}
                  </div>
                {%- endfor -%}
              </div>
            </div>

            <div class='t4s-swatch t4s-color-mode__{{ color_mode }} t4s-color-size__{{ bk_stts.color_size }} t4s-selector-mode__{{ selector_mode }}'>
              {%- if advance_pr_type != blank -%}
                {%- render 'choose_style',
                  advance_pr_type: advance_pr_type,
                  title: advance_label,
                  pid: product.id
                -%}
              {%- endif -%}

              {%- for option in shsd_product_options_with_values -%}
                {%- liquid
                  assign option_index = 'option' | append: forloop.index
                  assign selected_value = product.selected_or_first_available_variant[option_index]
                  assign option_name = option.name
                  assign name_downcase = option_name | downcase
                -%}

                {%- if get_color contains name_downcase -%}
                  {% comment %}--MARK: Color Option{% endcomment %}

                  {% comment %} Build color nickname map from variant metafields {% endcomment %}
                  {%- capture color_nicknames_map -%}
                    {%- for variant in shsd_product_variants -%}
                      {%- if variant.metafields.custom.variant_color != blank -%}
                        {%- for opt_index in (1..3) -%}
                          {%- assign opt_key = 'option' | append: opt_index -%}
                          {%- assign opt_val = variant[opt_key] -%}
                          {%- if opt_val != blank -%}
                            {%- assign opt_index_adjusted = opt_index | minus: 1 -%}
                            {%- assign opt_name_check = product.options[opt_index_adjusted] | downcase -%}
                            {%- if get_color contains opt_name_check -%}
                              {{ opt_val | handle }}:{{ variant.metafields.custom.variant_color }};
                            {%- endif -%}
                          {%- endif -%}
                        {%- endfor -%}
                      {%- endif -%}
                    {%- endfor -%}
                  {%- endcapture -%}
                  {%- assign color_nicknames_map = color_nicknames_map
                    | strip
                  -%}

                  <div
                    data-swatch-option
                    data-option-name='{{ option_name | escape }}'
                    data-id='{{ forloop.index0 }}'
                    data-option-unit='
                      {%- liquid
                        assign option_unit = ''
                        if se_stts and se_stts.option_units and se_stts.option_units != blank
                          assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'
                          for pair in option_units_raw
                            assign pair_cleaned = pair | strip
                            if pair_cleaned contains ':'
                              assign key_value = pair_cleaned | split: ':'
                              assign key = key_value[0] | strip
                              assign value = key_value[1] | strip
                              if key == option_name and value != blank
                                assign option_unit = value
                                break
                              endif
                            endif
                          endfor
                        endif
                      -%}{{ option_unit | escape }}
                    '
                    class='t4s-swatch__option is-t4s-style__color is-t4s-name__{{ option_name | handle }} {% cycle 'is--first-color', '', '' %}'
                  >
                    <h4 class='t4s-swatch__title t4s-swatch__title--color'>
                      <span class='t4s-swatch__title--left'>
                        <span class='bold'>
                          {{- option_name | upcase -}}
                          {%- liquid
                            assign option_unit = ''
                            if se_stts and se_stts.option_units and se_stts.option_units != blank
                              assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'
                              for pair in option_units_raw
                                assign pair_cleaned = pair | strip
                                if pair_cleaned contains ':'
                                  assign key_value = pair_cleaned | split: ':'
                                  assign key = key_value[0] | strip
                                  assign value = key_value[1] | strip
                                  if key == option_name and value != blank
                                    assign option_unit = value
                                    break
                                  endif
                                endif
                              endfor
                            endif
                          -%}
                          {%- if option_unit != blank %}
                            ({{ option_unit }})
                          {%- endif -%}
                          :
                        </span>
                        <span class='t4s-selected-value'>
                          {%- assign display_value = selected_value
                            | default: choose_an_option
                            | replace: '"', ''
                          -%}
                          {{- display_value -}}
                          {%- if option_unit != blank %}
                            {{ option_unit }}
                          {%- endif -%}
                        </span>
                      </span>
                      {%- if name_sizeg == name_downcase -%}
                        {{- html_sizeg -}}
                      {%- endif %}
                    </h4>

                    <div data-swatch-list class='t4s-swatch__list'>
                      {%- if color_mode != 'dropdown' -%}
                        {%- if color_mode contains 'is-sw-cl__label' -%}
                          {%- for value in option.values -%}
                            {%- assign color_handle = value | handle -%}

                            {%- comment %} Look up color nickname from map {%- endcomment %}
                            {%- assign color_nickname = '' -%}
                            {%- assign nickname_pairs = color_nicknames_map
                              | split: ';'
                            -%}
                            {%- for pair in nickname_pairs -%}
                              {%- assign pair_clean = pair | strip -%}
                              {%- if pair_clean != blank -%}
                                {%- assign pair_parts = pair_clean
                                  | split: ':'
                                -%}
                                {%- if pair_parts[0] == color_handle -%}
                                  {%- assign color_nickname = pair_parts[1] -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- endif -%}
                            {%- endfor -%}

                            {%- comment %} Context-aware availability check: color + current other selections {%- endcomment %}
                            {%- assign color_is_available = false -%}
                            {%- for variant in shsd_product_variants -%}
                              {%- assign matches_color = false -%}
                              {%- assign matches_other_options = true -%}

                              {%- for opt_idx in (1..3) -%}
                                {%- assign opt_key = 'option'
                                  | append: opt_idx
                                -%}
                                {%- assign variant_opt_val = variant[opt_key] -%}
                                {%- if variant_opt_val != blank -%}
                                  {%- assign variant_opt_handle = variant_opt_val
                                    | handle
                                  -%}

                                  {%- comment %} Determine if this option index is the color option {%- endcomment %}
                                  {%- assign opt_idx_adjusted = opt_idx
                                    | minus: 1
                                  -%}
                                  {%- assign this_opt_name = product.options[opt_idx_adjusted]
                                    | downcase
                                  -%}

                                  {%- if get_color contains this_opt_name -%}
                                    {%- comment %} This is the color option - check if it matches our target color {%- endcomment %}
                                    {%- if variant_opt_handle == color_handle
                                    -%}
                                      {%- assign matches_color = true -%}
                                    {%- endif -%}
                                  {%- else -%}
                                    {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment %}
                                    {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}
                                    {%- if current_selected_val != blank -%}
                                      {%- assign current_selected_handle = current_selected_val
                                        | handle
                                      -%}
                                      {%- unless variant_opt_handle
                                          == current_selected_handle
                                      -%}
                                        {%- assign matches_other_options = false -%}
                                      {%- endunless -%}
                                    {%- endif -%}
                                  {%- endif -%}
                                {%- endif -%}
                              {%- endfor -%}

                              {%- if matches_color
                                and matches_other_options
                                and variant.available
                              -%}
                                {%- assign color_is_available = true -%}
                                {%- break -%}
                              {%- endif -%}
                            {%- endfor -%}

                            <div
                              data-swatch-item
                              class='t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}{% unless color_is_available %} is--out-of-stock{% endunless %}'
                              data-value='{{ value | escape }}'
                              data-available='{{ color_is_available }}'
                            >
                              <!--
                                DEBUG: color={{ color_handle }} | available={{ color_is_available }} | selected_opt1={{ product.selected_or_first_available_variant.option1 | handle }} | selected_opt2={{ product.selected_or_first_available_variant.option2 | handle }}
                              -->
                              <div
                                data-img-el
                                class='t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s'
                              >
                                <img crossorigin='anonymous'>
                              </div>
                              {%- unless color_is_available -%}
                                <span class='t4s-swatch__restock-badge'
                                  >Awaiting Restock</span
                                >
                                {%- comment %} Available lengths: use option whose name contains "length", else option2 (common: Color=opt1, Length=opt2), else option1 {%- endcomment %}
                                {%- assign length_opt_key = 'option2' -%}
                                {%- for opt_idx in (1..3) -%}
                                  {%- assign okey = 'option'
                                    | append: opt_idx
                                  -%}
                                  {%- assign opt_name_down = product.options[opt_idx | minus: 1] | downcase -%}
                                  {%- if get_color contains opt_name_down -%}
                                    {%- continue -%}
                                  {%- endif -%}
                                  {%- if opt_name_down contains 'length'
                                    or opt_name_down contains 'size'
                                  -%}
                                    {%- assign length_opt_key = okey -%}
                                    {%- break -%}
                                  {%- endif -%}
                                  {%- if opt_idx == 2 -%}
                                    {%- assign length_opt_key = okey -%}
                                  {%- endif -%}
                                {%- endfor -%}
                                {%- assign available_lengths_delim = '|' -%}
                                {%- for v in shsd_product_variants -%}
                                  {%- assign v_len_val = v[length_opt_key]
                                    | default: ''
                                  -%}
                                  {%- if v_len_val == blank -%}
                                    {%- continue -%}
                                  {%- endif -%}
                                  {%- assign v_color_match = false -%}
                                  {%- for opt_idx in (1..3) -%}
                                    {%- assign opt_key = 'option'
                                      | append: opt_idx
                                    -%}
                                    {%- assign this_opt_name = product.options[opt_idx | minus: 1] | downcase -%}
                                    {%- if get_color contains this_opt_name and v[opt_key] | handle == color_handle -%}
                                      {%- assign v_color_match = true -%}
                                      {%- break -%}
                                    {%- endif -%}
                                  {%- endfor -%}
                                  {%- if v_color_match -%}
                                    {%- assign excluded = false -%}
                                    {%- if product.metafields.custom.custom_values.value
                                        != blank
                                    -%}
                                      {%- for excl_item in product.metafields.custom.custom_values.value -%}
                                        {%- if excl_item != blank and v_len_val | handle == excl_item | handle -%}
                                          {%- assign excluded = true -%}
                                          {%- break -%}
                                        {%- endif -%}
                                      {%- endfor -%}
                                    {%- endif -%}
                                    {%- unless excluded -%}
                                      {%- assign needle = '|'
                                        | append: v_len_val
                                        | append: '|'
                                      -%}
                                      {%- unless available_lengths_delim
                                          contains needle
                                      -%}
                                        {%- assign available_lengths_delim = available_lengths_delim
                                          | append: v_len_val
                                          | append: '|'
                                        -%}
                                      {%- endunless -%}
                                    {%- endunless -%}
                                  {%- endif -%}
                                {%- endfor -%}
                                {%- assign available_lengths_arr = available_lengths_delim
                                  | split: '|'
                                  | compact
                                -%}
                                {%- assign available_lengths_str = available_lengths_arr
                                  | join: ', '
                                -%}
                                {%- if available_lengths_str != blank -%}
                                  <span class='t4s-swatch__available-lengths'>
                                    {{- available_lengths_str -}}
                                  </span>
                                {%- endif -%}
                              {%- endunless -%}
                              <span class='t4s-swatch__label'>
                                {{- value | replace: '"', '' -}}
                              </span>
                              {%- if color_nickname != blank -%}
                                <span class='t4s-swatch__nickname'>
                                  {{- color_nickname -}}
                                </span>
                              {%- endif -%}
                            </div>
                          {%- endfor -%}

                        {%- else -%}
                          {%- for value in option.values -%}
                            {%- assign color_handle = value | handle -%}

                            {%- comment %} Look up color nickname {%- endcomment %}
                            {%- assign color_nickname = '' -%}
                            {%- assign nickname_pairs = color_nicknames_map
                              | split: ';'
                            -%}
                            {%- for pair in nickname_pairs -%}
                              {%- assign pair_clean = pair | strip -%}
                              {%- if pair_clean != blank -%}
                                {%- assign pair_parts = pair_clean
                                  | split: ':'
                                -%}
                                {%- if pair_parts[0] == color_handle -%}
                                  {%- assign color_nickname = pair_parts[1] -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- endif -%}
                            {%- endfor -%}

                            {%- comment %} Context-aware availability check: color + current other selections {%- endcomment %}
                            {%- assign color_is_available = false -%}
                            {%- for variant in shsd_product_variants -%}
                              {%- assign matches_color = false -%}
                              {%- assign matches_other_options = true -%}

                              {%- for opt_idx in (1..3) -%}
                                {%- assign opt_key = 'option'
                                  | append: opt_idx
                                -%}
                                {%- assign variant_opt_val = variant[opt_key] -%}
                                {%- if variant_opt_val != blank -%}
                                  {%- assign variant_opt_handle = variant_opt_val
                                    | handle
                                  -%}

                                  {%- comment %} Determine if this option index is the color option {%- endcomment %}
                                  {%- assign opt_idx_adjusted = opt_idx
                                    | minus: 1
                                  -%}
                                  {%- assign this_opt_name = product.options[opt_idx_adjusted]
                                    | downcase
                                  -%}

                                  {%- if get_color contains this_opt_name -%}
                                    {%- comment %} This is the color option - check if it matches our target color {%- endcomment %}
                                    {%- if variant_opt_handle == color_handle
                                    -%}
                                      {%- assign matches_color = true -%}
                                    {%- endif -%}
                                  {%- else -%}
                                    {%- comment %} This is a non-color option - check if variant matches current selection {%- endcomment %}
                                    {%- assign current_selected_val = product.selected_or_first_available_variant[opt_key] -%}
                                    {%- if current_selected_val != blank -%}
                                      {%- assign current_selected_handle = current_selected_val
                                        | handle
                                      -%}
                                      {%- unless variant_opt_handle
                                          == current_selected_handle
                                      -%}
                                        {%- assign matches_other_options = false -%}
                                      {%- endunless -%}
                                    {%- endif -%}
                                  {%- endif -%}
                                {%- endif -%}
                              {%- endfor -%}

                              {%- if matches_color
                                and matches_other_options
                                and variant.available
                              -%}
                                {%- assign color_is_available = true -%}
                                {%- break -%}
                              {%- endif -%}
                            {%- endfor -%}

                            <div
                              data-swatch-item
                              class='t4s-swatch__btn-wrap{% if selected_value == value %} is--selected{% endif %}{% unless color_is_available %} is--out-of-stock{% endunless %}'
                              data-value='{{ value | escape }}'
                              data-available='{{ color_is_available }}'
                            >
                              <!--
                                DEBUG: color={{ color_handle }} | available={{ color_is_available }} | selected_opt1={{ product.selected_or_first_available_variant.option1 | handle }} | selected_opt2={{ product.selected_or_first_available_variant.option2 | handle }}
                              -->
                              <div
                                data-img-el
                                class='t4s-swatch__item {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s'
                              >
                                <img crossorigin='anonymous'>
                              </div>
                              {%- unless color_is_available -%}
                                <span class='t4s-swatch__restock-badge'
                                  >Awaiting Restock</span
                                >
                                {%- comment %} Available lengths: same logic as first branch {%- endcomment %}
                                {%- assign length_opt_key_2 = 'option2' -%}
                                {%- for opt_idx in (1..3) -%}
                                  {%- assign okey = 'option'
                                    | append: opt_idx
                                  -%}
                                  {%- assign opt_name_down = product.options[opt_idx | minus: 1] | downcase -%}
                                  {%- if get_color contains opt_name_down -%}
                                    {%- continue -%}
                                  {%- endif -%}
                                  {%- if opt_name_down contains 'length'
                                    or opt_name_down contains 'size'
                                  -%}
                                    {%- assign length_opt_key_2 = okey -%}
                                    {%- break -%}
                                  {%- endif -%}
                                  {%- if opt_idx == 2 -%}
                                    {%- assign length_opt_key_2 = okey -%}
                                  {%- endif -%}
                                {%- endfor -%}
                                {%- assign available_lengths_delim_2 = '|' -%}
                                {%- for v in shsd_product_variants -%}
                                  {%- assign v_len_val_2 = v[length_opt_key_2]
                                    | default: ''
                                  -%}
                                  {%- if v_len_val_2 == blank -%}
                                    {%- continue -%}
                                  {%- endif -%}
                                  {%- assign v_color_match_2 = false -%}
                                  {%- for opt_idx in (1..3) -%}
                                    {%- assign opt_key = 'option'
                                      | append: opt_idx
                                    -%}
                                    {%- assign this_opt_name = product.options[opt_idx | minus: 1] | downcase -%}
                                    {%- if get_color contains this_opt_name and v[opt_key] | handle == color_handle -%}
                                      {%- assign v_color_match_2 = true -%}
                                      {%- break -%}
                                    {%- endif -%}
                                  {%- endfor -%}
                                  {%- if v_color_match_2 -%}
                                    {%- assign excluded_2 = false -%}
                                    {%- if product.metafields.custom.custom_values.value
                                        != blank
                                    -%}
                                      {%- for excl_item in product.metafields.custom.custom_values.value -%}
                                        {%- if excl_item != blank and v_len_val_2 | handle == excl_item | handle -%}
                                          {%- assign excluded_2 = true -%}
                                          {%- break -%}
                                        {%- endif -%}
                                      {%- endfor -%}
                                    {%- endif -%}
                                    {%- unless excluded_2 -%}
                                      {%- assign needle_2 = '|'
                                        | append: v_len_val_2
                                        | append: '|'
                                      -%}
                                      {%- unless available_lengths_delim_2
                                          contains needle_2
                                      -%}
                                        {%- assign available_lengths_delim_2 = available_lengths_delim_2
                                          | append: v_len_val_2
                                          | append: '|'
                                        -%}
                                      {%- endunless -%}
                                    {%- endunless -%}
                                  {%- endif -%}
                                {%- endfor -%}
                                {%- assign available_lengths_arr_2 = available_lengths_delim_2
                                  | split: '|'
                                  | compact
                                -%}
                                {%- assign available_lengths_str_2 = available_lengths_arr_2
                                  | join: ', '
                                -%}
                                {%- if available_lengths_str_2 != blank -%}
                                  <span class='t4s-swatch__available-lengths'>
                                    {{- available_lengths_str_2 -}}
                                  </span>
                                {%- endif -%}
                              {%- endunless -%}
                              {%- if color_nickname != blank -%}
                                <span class='t4s-swatch__nickname'>
                                  {{- color_nickname -}}
                                </span>
                              {%- endif -%}
                            </div>
                          {%- endfor -%}
                        {%- endif -%}
                      {%- else -%}
                        <button
                          type='button'
                          data-dropdown-open
                          data-position='bottom-end'
                          data-id='t4s_nt_{{ pr_sid }}{{ forloop.index }}'
                        >
                          <span data-current-value>
                            {{- selected_value | default: choose_an_option -}}
                          </span>
                          <svg
                            class='t4s-icon-select-arrow'
                            role='presentation'
                            viewBox='0 0 19 12'
                          >
                            <use xlink:href="#t4s-select-arrow"></use>
                          </svg>
                        </button>
                        <div
                          data-dropdown-wrapper
                          class='t4s-dropdown__wrapper t4s-current-scrollbar'
                          id='t4s_nt_{{ pr_sid }}{{ forloop.index }}'
                        >
                          <div class='t4s-drop-arrow'></div>
                          <div class='t4s-dropdown__header'>
                            <span
                              data-current-value
                              class='t4s-dropdown__title'
                            >
                              {{- selected_value | default: choose_an_option -}}
                            </span>
                            <button
                              data-dropdown-close
                              aria-label='{{ 'general.aria.close' | t }}'
                            >
                              <svg
                                role='presentation'
                                class='t4s-iconsvg-close'
                                viewBox='0 0 16 14'
                              >
                                <path d="M15 0L1 14m14 0L1 0" stroke="currentColor" fill="none" fill-rule="evenodd"></path>
                              </svg>
                            </button>
                          </div>
                          <div class='t4s-dropdown__content'>
                            {%- for value in option.values -%}
                              <div
                                data-swatch-item
                                data-dropdown-off
                                class='t4s-swatch__item t4s-truncate {{ color_swatch }}bg_color_{{ value | handle }} lazyloadt4s{% if selected_value == value %} is--selected{% endif %}'
                                data-value='{{ value | escape }}'
                              >
                                {{ value | replace: '"', '' }}
                              </div>
                            {%- endfor -%}
                          </div>
                        </div>
                      {%- endif -%}
                    </div>
                    {%- render 'color-info-accordion' -%}
                  </div>
                {%- else -%}
                  {% comment %}--MARK: Non-Color{% endcomment %}
                  {%- liquid
                    assign standard_values = ''
                    assign custom_values = ''
                    assign has_standard = false
                    assign has_custom = false

                    for value in option.values
                      assign is_custom = false
                      for custom_name in custom_option_names
                        assign custom_name_clean = custom_name | strip
                        if value contains custom_name_clean
                          assign is_custom = true
                          break
                        endif
                      endfor

                      if is_custom
                        if custom_values == ''
                          assign custom_values = value
                        else
                          assign custom_values = custom_values | append: ',' | append: value
                        endif
                        assign has_custom = true
                      else
                        if standard_values == ''
                          assign standard_values = value
                        else
                          assign standard_values = standard_values | append: ',' | append: value
                        endif
                        assign has_standard = true
                      endif
                    endfor

                    assign standard_values_array = standard_values | split: ','
                    assign custom_values_array = custom_values | split: ','
                  -%}

                  <div
                    data-swatch-option
                    data-option-name='{{ option_name | escape }}'
                    data-id='{{ forloop.index0 }}'
                    data-option-unit='
                      {%- liquid
                        assign option_unit = ''
                        if se_stts and se_stts.option_units and se_stts.option_units != blank
                          assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'
                          for pair in option_units_raw
                            assign pair_cleaned = pair | strip
                            if pair_cleaned contains ':'
                              assign key_value = pair_cleaned | split: ':'
                              assign key = key_value[0] | strip
                              assign value = key_value[1] | strip
                              if key == option_name and value != blank
                                assign option_unit = value
                                break
                              endif
                            endif
                          endfor
                        endif
                      -%}{{ option_unit | escape }}
                    '
                    class='t4s-swatch__option is-t4s-name__{{ option_name | handle }} pfd-split-option'
                  >
                    <h4 class='t4s-swatch__title'>
                      <span class='t4s-swatch__title--left'
                        >Select a
                        <span class='bold'>
                          {{- option_name -}}
                        </span>
                        {%- liquid
                          assign option_unit = ''
                          if se_stts and se_stts.option_units and se_stts.option_units != blank
                            assign option_units_raw = se_stts.option_units | strip | newline_to_br | split: '<br />'
                            for pair in option_units_raw
                              assign pair_cleaned = pair | strip
                              if pair_cleaned contains ':'
                                assign key_value = pair_cleaned | split: ':'
                                assign key = key_value[0] | strip
                                assign value = key_value[1] | strip
                                if key == option_name and value != blank
                                  assign option_unit = value
                                  break
                                endif
                              endif
                            endfor
                          endif
                        -%}
                        {%- if option_unit != blank %}
                          ({{ option_unit }})
                        {%- endif -%}
                      </span>
                      <span class='t4s-swatch__title--right'
                        >Selected:
                        <span class='bold'>
                          {%- assign display_value = selected_value
                            | default: choose_an_option
                            | replace: '"', ''
                          -%}
                          {{- display_value -}}
                          {%- if option_unit != blank %}
                            {{ option_unit }}
                          {%- endif -%}
                        </span></span
                      >
                      {%- if name_sizeg == name_downcase -%}
                        {{- html_sizeg -}}
                      {%- endif %}
                    </h4>

                    <div class='pfd-split-selection'>
                      {%- if has_standard -%}
                        <div class='pfd-standard-options'>
                          {%- if selector_mode != 'dropdown' -%}
                            {%- for value in standard_values_array -%}
                              <div
                                data-swatch-item
                                class='t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}'
                                data-value='{{ value | escape }}'
                              >
                                {{ value | replace: '"', '' }}
                              </div>
                            {%- endfor -%}
                          {%- else -%}
                            <button
                              type='button'
                              data-pfd-dropdown-open
                              data-position='bottom-end'
                              data-id='t4s_nt_{{ pr_sid }}{{ forloop.index }}_standard'
                            >
                              <span data-current-value>
                                {{-
                                  selected_value
                                  | default: choose_an_option
                                -}}
                              </span>
                              <svg
                                class='t4s-icon-select-arrow'
                                role='presentation'
                                viewBox='0 0 19 12'
                              >
                                <use xlink:href="#t4s-select-arrow"></use>
                              </svg>
                            </button>
                            <div
                              data-dropdown-wrapper
                              class='t4s-dropdown__wrapper t4s-current-scrollbar'
                              id='t4s_nt_{{ pr_sid }}{{ forloop.index }}_standard'
                            >
                              <div class='t4s-drop-arrow'></div>
                              <div class='t4s-dropdown__content'>
                                {%- for value in standard_values_array -%}
                                  <div
                                    data-swatch-item
                                    data-dropdown-off
                                    class='t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}'
                                    data-value='{{ value | escape }}'
                                  >
                                    {{ value | replace: '"', '' }}
                                  </div>
                                {%- endfor -%}
                              </div>
                            </div>
                          {%- endif -%}
                        </div>
                      {%- endif -%}

                      {%- if has_custom -%}
                        <div class='pfd-custom-options'>
                          {%- if has_standard and has_custom -%}
                            <span class='pfd-or-separator'>or</span>
                          {%- endif -%}
                          <button
                            type='button'
                            data-pfd-dropdown-open
                            data-position='bottom-end'
                            data-id='t4s_nt_{{ pr_sid }}{{ forloop.index }}_custom'
                            class='pfd-custom-dropdown'
                          >
                            <span data-current-value>
                              {%- assign is_custom_selected = false -%}
                              {%- for custom_val in custom_values_array -%}
                                {%- if selected_value == custom_val -%}
                                  {%- assign display_custom_val = custom_val
                                    | replace: '"', ''
                                  -%}
                                  {%- if option_unit != blank -%}
                                    {{ display_custom_val }}
                                    {{ option_unit }}
                                    <span class='pfd-custom-badge'>Custom</span>
                                  {%- else -%}
                                    {{ display_custom_val }}
                                    <span class='pfd-custom-badge'>Custom</span>
                                  {%- endif -%}
                                  {%- assign is_custom_selected = true -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- endfor -%}
                              {%- unless is_custom_selected -%}
                                Custom {{ option_name | downcase }}
                              {%- endunless -%}
                            </span>
                            <svg
                              class='t4s-icon-select-arrow'
                              role='presentation'
                              viewBox='0 0 19 12'
                            >
                              <use xlink:href="#t4s-select-arrow"></use>
                            </svg>
                          </button>
                          <div
                            data-dropdown-wrapper
                            class='t4s-dropdown__wrapper t4s-current-scrollbar'
                            id='t4s_nt_{{ pr_sid }}{{ forloop.index }}_custom'
                          >
                            <div class='t4s-drop-arrow'></div>
                            <div class='t4s-dropdown__content'>
                              {%- for value in custom_values_array -%}
                                <div
                                  data-swatch-item
                                  data-dropdown-off
                                  class='t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}'
                                  data-value='{{ value | escape }}'
                                >
                                  <span class='pfd-checkmark'></span>
                                  <span class='pfd-option-text'>
                                    {%- assign display_value = value
                                      | replace: '"', ''
                                    -%}
                                    {%- if option_unit != blank -%}
                                      {{ display_value }}
                                      {{ option_unit }}
                                    {%- else -%}
                                      {{ display_value }}
                                    {%- endif -%}
                                  </span>
                                  <span class='pfd-custom-badge'>Custom</span>
                                </div>
                              {%- endfor -%}
                            </div>
                          </div>
                        </div>
                      {%- endif -%}

                      {%- unless has_standard or has_custom -%}
                        {%- comment %} Fallback to original rendering if no split detected {%- endcomment %}
                        <div class='t4s-swatch__list pfd-fallback-list'>
                          {%- if selector_mode != 'dropdown' -%}
                            {%- for value in option.values -%}
                              <div
                                data-swatch-item
                                class='t4s-swatch__item{% if selected_value == value %} is--selected{% endif %}'
                                data-value='{{ value | escape }}'
                              >
                                {{ value | replace: '"', '' }}
                              </div>
                            {%- endfor -%}
                          {%- else -%}
                            <button
                              type='button'
                              data-pfd-dropdown-open
                              data-position='bottom-end'
                              data-id='t4s_nt_{{ pr_sid }}{{ forloop.index }}'
                            >
                              <span data-current-value>
                                {{-
                                  selected_value
                                  | default: choose_an_option
                                -}}
                              </span>
                              <svg
                                class='t4s-icon-select-arrow'
                                role='presentation'
                                viewBox='0 0 19 12'
                              >
                                <use xlink:href="#t4s-select-arrow"></use>
                              </svg>
                            </button>
                            <div
                              data-dropdown-wrapper
                              class='t4s-dropdown__wrapper t4s-current-scrollbar'
                              id='t4s_nt_{{ pr_sid }}{{ forloop.index }}'
                            >
                              <div class='t4s-drop-arrow'></div>
                              <div class='t4s-dropdown__content'>
                                {%- for value in option.values -%}
                                  <div
                                    data-swatch-item
                                    data-dropdown-off
                                    class='t4s-swatch__item t4s-truncate{% if selected_value == value %} is--selected{% endif %}'
                                    data-value='{{ value | escape }}'
                                  >
                                    {{ value | replace: '"', '' }}
                                  </div>
                                {%- endfor -%}
                              </div>
                            </div>
                          {%- endif -%}
                        </div>
                      {%- endunless -%}
                    </div>

                    {%- comment %} Custom order notice - shown when custom option is selected {%- endcomment %}
                    {%- assign show_custom_notice = false -%}
                    {%- for custom_val in custom_values_array -%}
                      {%- if selected_value == custom_val -%}
                        {%- assign show_custom_notice = true -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                    <div
                      class='pfd-custom-notice'
                      style='display: {% if show_custom_notice %}block{% else %}none{% endif %};'
                    >
                      <div class='pfd-custom-notice-content'>
                        <svg
                          class='pfd-custom-notice-icon'
                          xmlns='http://www.w3.org/2000/svg'
                          width='24'
                          height='24'
                          viewBox='0 0 24 24'
                          fill='none'
                          stroke='currentColor'
                          stroke-width='2'
                          stroke-linecap='round'
                          stroke-linejoin='round'
                        >
                          <circle cx="12" cy="12" r="10"></circle>
                          <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <p class='pfd-custom-notice-text'>
                          Custom {{ option_name | downcase }}s are
                          <strong>made to order</strong>. Please allow
                          <span class='pfd-custom-notice-highlight'
                            >6-8 weeks</span
                          >
                          for delivery.
                        </p>
                      </div>
                    </div>

                    {%- comment %} Configuration-based custom content for options {%- endcomment %}
                    {%- comment %} Renders ALL matching option content, shows only the selected one {%- endcomment %}
                    {%- assign option_name_lower = option_name | downcase -%}
                    {%- assign selected_value_lower = selected_value
                      | downcase
                    -%}

                    {%- capture all_option_info -%}
  {%- for pair in option_content_pairs -%}
    {%- assign pair_cleaned = pair | strip -%}
    {%- if pair_cleaned contains '|' -%}
      {%- assign parts = pair_cleaned | split: '|' -%}
      {%- assign option_key_full = parts[0] | strip -%}
      {%- assign content_value = parts[1] | strip -%}

      {%- if option_key_full contains ':' -%}
        {%- assign key_parts = option_key_full | split: ':' -%}
        {%- assign option_key = key_parts[0] | strip | downcase -%}
        {%- assign value_key = key_parts[1] | strip -%}
        {%- assign value_key_lower = value_key | downcase -%}

        {%- if option_name_lower == option_key -%}
          {%- assign is_selected = false -%}
          {%- if selected_value_lower == value_key_lower -%}
            {%- assign is_selected = true -%}
          {%- endif -%}
          <div class="pfd-option-info-item"
               data-option-name="{{ option_name_lower }}"
               data-option-value="{{ value_key | handle }}"
               style="{% unless is_selected %}display: none;{% endunless %}">
            {{ content_value }}
          </div>
        {%- endif -%}
      {%- endif -%}
    {%- endif -%}
  {%- endfor -%}
{%- endcapture -%}

                    {%- assign all_option_info_stripped = all_option_info
                      | strip
                    -%}
                    {%- if all_option_info_stripped != blank -%}
                      <div
                        class='pfd-custom-option-info'
                        data-option-info-container='{{ option_name_lower }}'
                      >
                        {{ all_option_info }}
                      </div>
                    {%- endif -%}
                  </div>
                {%- endif -%}
              {%- endfor -%}
            </div>
          {%- endif -%}

          {%- liquid
            if arr_properties.size > 0 and isProductAvailable
              render 'frm_properties', arr_properties: arr_properties, product: product
            endif
          -%}

          {%- if use_incoming_mess
            and current_variant_incoming
            and pr_variants.size == 1
            and current_variant.next_incoming_date != blank
          -%}
            {%- assign format_date = current_variant.next_incoming_date
              | date: date_in
            -%}
            {% comment %}<div class="t4s-incoming__mess">{% if current_variant_available %}{{ 'products.product_single.will_not_ship_until_html' | t: date: format_date }}{% else %}{{ 'products.product_single.will_be_in_stock_after_html' | t: date: format_date }}{% endif %}</div>{% endcomment %}
          {%- elsif use_incoming_mess and pr_variants.size > 1 -%}
            {%- liquid
              assign format_date = current_variant.next_incoming_date | date: date_in
              unless format_date
                assign format_date = '19041994'
              endunless
            -%}
            {% comment %}<div data-incoming__mess class="t4s-incoming__mess"{% unless current_variant_incoming %} hidden{% endunless %}><span data-incoming-available{% if current_variant_available == false or current_variant == blank %} style="display: none"{% endif %}>{{ 'products.product_single.will_not_ship_until_html' | t: date: format_date }}</span><span data-incoming-soldout{% if current_variant_available or current_variant == blank %} style="display: none"{% endif %}>{{ 'products.product_single.will_be_in_stock_after_html' | t: date: format_date }}</span></div>{% endcomment %}
          {%- endif -%}

          {{ 'button-style.css' | asset_url | stylesheet_tag }}
          <link
            href='{{ 'custom-effect.css' | asset_url }}'
            rel='stylesheet'
            media='print'
            onload="this.media='all'"
          >

          {{- html_price -}}

          <div
            class='t4s-product-form__buttons'
            style='--pr-btn-round: {{ bk_stts.pr_btn_round }}px;--wis-cp-btn-round: {{ bk_stts.wis_cp_btn_round }}px;'
          >
            <div class='t4s-pr__qty_cart t4s-d-flex t4s-flex-wrap'>
              {%- if isExternal -%}
                <a
                  href='{{ external_link }}'
                  rel='nofollow'
                  target='_blank'
                  class='t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ bk_stts.button_style }} t4s-btn-color-{{ bk_stts.button_color }} t4s-w-100 t4s-justify-content-center {% if bk_stts.button_style == 'default' or bk_stts.button_style == 'outline' %} t4s-btn-effect-{{ bk_stts.button_effect }}{% endif %} t4s-truncate is--btn-external t4s-btn-loading__svg'
                >
                  {%- if bk_stts.btn_icon -%}
                    <svg class='t4s-btn-icon' viewBox='0 0 24 24'>
                      <use xlink:href="#t4s-icon-atc"></use>
                    </svg>
                  {%- endif -%}
                  <span class='t4s-btn-atc_text'>
                    {{- external_title -}}
                  </span>
                  <span class='t4s-loading__spinner' hidden>
                    <svg
                      width='16'
                      height='16'
                      hidden
                      class='t4s-svg-spinner'
                      focusable='false'
                      role='presentation'
                      viewBox='0 0 66 66'
                      xmlns='http://www.w3.org/2000/svg'
                    >
                      <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                    </svg>
                  </span>
                </a>
              {%- else -%}
                {%- if bk_stts.show_qty and isProductAvailable -%}
                  <div
                    data-quantity-wrapper
                    class='t4s-quantity-wrapper t4s-product-form__qty'
                  >
                    <button
                      data-quantity-selector
                      data-decrease-qty
                      type='button'
                      class='t4s-quantity-selector is--minus'
                    ></button>
                    <input
                      data-quantity-value
                      type='number'
                      class='t4s-quantity-input'
                      step='1'
                      min='{{cus_qty}}'
                      max='{{max_qty}}'
                      name='quantity'
                      value='{{cus_qty}}'
                      size='4'
                      pattern='[0-9]*'
                      inputmode='numeric'
                    >
                    <button
                      data-quantity-selector
                      data-increase-qty
                      type='button'
                      class='t4s-quantity-selector is--plus'
                    ></button>
                  </div>
                {%- else -%}
                  <input type='hidden' name='quantity' value='1'>
                {%- endif -%}
                {% if customer %}
                  <button
                    data-animation-atc='{ "ani": "{{ bk_stts.ani }}","time": {{ bk_stts.time }}000 }'
                    type='submit'
                    name='add'
                    data-atc-form
                    class='t4s-product-form__submit t4s-btn t4s-btn-base t4s-btn-style-{{ bk_stts.button_style }} t4s-btn-color-{{ bk_stts.button_color }} t4s-w-100 t4s-justify-content-center {% if bk_stts.button_style == 'default' or bk_stts.button_style == 'outline' %} t4s-btn-effect-{{ bk_stts.button_effect }}{% endif %} t4s-btn-loading__svg'
                    {% unless current_variant_available %}
                      aria-disabled='true'
                    {% endunless -%}
                    {% unless isProductAvailable %}
                      disabled='disabled'
                    {% endunless %}
                  >
                    {%- if bk_stts.btn_icon -%}
                      <svg
                        class='t4s-btn-icon'
                        viewBox='0 0 24 24'
                      >
                        <use xlink:href="#t4s-icon-atc"></use>
                      </svg>
                    {%- endif -%}
                    <span class='t4s-btn-atc_text'>
                      {%- if current_variant_available == false
                        or isProductAvailable == false
                      -%}
                        {{- 'products.product.sold_out' | t -}}
                      {%- elsif isPreoder -%}
                        {{- 'products.product.pre_order' | t }}
                      {%- else -%}
                        {{ 'products.product.add_to_cart' | t }}
                      {%- endif -%}
                    </span>
                    <span class='t4s-loading__spinner' hidden>
                      <svg
                        width='16'
                        height='16'
                        hidden
                        class='t4s-svg-spinner'
                        focusable='false'
                        role='presentation'
                        viewBox='0 0 66 66'
                        xmlns='http://www.w3.org/2000/svg'
                      >
                        <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                      </svg>
                    </span>
                  </button>
                {% else %}
                  <a
                    href='/account/login'
                    onclick='rememberPage(event)'
                    data-drawer-delay-
                    data-drawer-options='{ "id": "#t4s-login-sidebar" }'
                    class='atc-btn t4s-btn t4s-btn-base t4s-btn-style-default t4s-btn-color-dark t4s-w-100 t4s-justify-content-center t4s-btn-effect-sweep-to-right t4s-btn-loading__svg'
                  >
                    <svg
                      class='t4s-btn-icon'
                      viewBox='0 0 24 24'
                      style='margin-right:4px'
                    >
                      <use xlink:href="#t4s-icon-atc"></use>
                    </svg>
                    <span class='t4s-btn-atc_text'>Login to Shop</span>
                    <span class='t4s-loading__spinner' hidden=''>
                      <svg
                        width='16'
                        height='16'
                        hidden=''
                        class='t4s-svg-spinner'
                        focusable='false'
                        role='presentation'
                        viewBox='0 0 66 66'
                        xmlns='http://www.w3.org/2000/svg'
                      >
                        <circle class="t4s-path" fill="none" stroke-width="6" cx="33" cy="33" r="30"></circle>
                      </svg>
                    </span>
                  </a>
                {% endif %}
              {%- endif -%}
            </div>
            {%- if PR_buy_pr and type != 'main_sticky' %}
              {{- form | payment_button -}}
            {% endif -%}
            {%- if settings.use_notify_me -%}
              {% if customer -%}
                <button
                  data-class='t4s-mfp-btn-close-inline'
                  data-id='t4s-pr-popup__notify-stock'
                  data-storageid='notify-stock{{ current_variant.id }}'
                  data-mfp-src
                  data-open-mfp-ajax
                  class='t4s-pr__notify-stock{% if current_variant_available or current_variant == blank %} t4s-d-none{% endif %}'
                  type='button'
                  data-notify-stock-btn
                  data-variant-id='{{ current_variant.id }}'
                  data-root-url='{{ routes.root_url }}'
                >
                  {{ 'products.notify_stock.trigger' | t }}
                </button>
              {%- endif %}
            {%- endif -%}
            {%- if bk_stts.enable_wishlist or bk_stts.enable_compare -%}
              <div class='t4s-pr__wis_cp'>
                {%- render 't4s_wis_cp',
                  product: product,
                  bk_stts: bk_stts,
                  disableTooltip: true
                -%}
              </div>
            {%- endif -%}
          </div>
        {%- endform -%}
        {%- unless isProductDefault or type == 'main_sticky' -%}
          <script type='application/json' class='pr_variants_json'>
            {{ shsd_product_variants | json }}
          </script>
          <script type='application/json' class='pr_options_json'>
            {{ shsd_product_options_with_values | json }}
          </script>
        {%- endunless -%}
        {%- if bk_stts.ani != 'none' -%}
          <link
            href='{{ 'ani-atc.min.css' | asset_url }}'
            rel='stylesheet'
            media='print'
            onload="this.media='all'"
          >
        {%- endif -%}
      </div>
    </div>
  </div>

  <script>
    (function () {
      'use strict';

      function updateOptionInfo(container, selectedValue) {
        var optionName = container.getAttribute('data-option-name');
        if (!optionName) return;
        optionName = optionName.toLowerCase();

        var infoContainer = container.querySelector(
          '[data-option-info-container="' + optionName + '"]'
        );
        if (!infoContainer) return;

        var valueHandle = selectedValue
          .toLowerCase()
          .replace(/\s+/g, '-')
          .replace(/[^a-z0-9-]/g, '');
        var infoItems = infoContainer.querySelectorAll('.pfd-option-info-item');

        infoItems.forEach(function (item) {
          var itemValue = item.getAttribute('data-option-value');
          item.style.display = itemValue === valueHandle ? '' : 'none';
        });
      }

      function initOptionInfoHandler() {
        var swatchContainers = document.querySelectorAll(
          '[data-swatch-option]'
        );

        swatchContainers.forEach(function (container) {
          // Method 1: MutationObserver for instant updates
          var observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (
                mutation.type === 'attributes' &&
                mutation.attributeName === 'class'
              ) {
                var target = mutation.target;
                if (
                  target.classList.contains('is--selected') &&
                  target.hasAttribute('data-value')
                ) {
                  var selectedValue = target.getAttribute('data-value');
                  updateOptionInfo(container, selectedValue);
                }
              }
            });
          });

          observer.observe(container, {
            attributes: true,
            subtree: true,
            attributeFilter: ['class'],
          });

          // Method 2: Backup click handler with small delay
          var swatchItems = container.querySelectorAll('[data-swatch-item]');
          swatchItems.forEach(function (swatch) {
            swatch.addEventListener('click', function () {
              var selectedValue = this.getAttribute('data-value');
              if (!selectedValue) return;
              setTimeout(function () {
                updateOptionInfo(container, selectedValue);
              }, 10);
            });
          });
        });
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initOptionInfoHandler);
      } else {
        initOptionInfoHandler();
      }

      document.addEventListener('shopify:section:load', initOptionInfoHandler);
    })();
  </script>
</div>
{%- if PR_buy_pr
  and current_variant_available != true
  and type != 'main_sticky'
-%}
  <style>
    #t4s-callBackVariant{{ product_form_id }} .shopify-payment-button { display: none;}
  </style>
{% endif -%}
